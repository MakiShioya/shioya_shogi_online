<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>しおや将棋 所持品</title>
  
  <link rel="preload" href="script/font/setofont.ttf" as="font" type="font/ttf" crossorigin>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    /* ★追加：フォント定義 */
    @font-face {
      font-family: 'SetoFont';
      src: url('script/font/setofont.ttf') format('truetype');
      font-display: block;
    }

    /* ★追加：全体にフォント適用 */
    * {
      font-family: 'SetoFont', "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
    }

    /* ★追加：ロード画面のスタイル */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* 背景色(#2c3e50)に合わせて調整 */
      background-color: rgba(44, 62, 80, 0.95); 
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loader-content {
      text-align: center;
      color: white;
      font-family: "SetoFont", sans-serif;
    }

    /* ぐるぐる回るアニメーション */
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* チップスのテキスト表示エリア */
    #loading-tips {
      margin-top: 20px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 0.9rem;
      max-width: 250px;
      line-height: 1.5;
      min-height: 3em;
    }

    /* --- 以下、既存スタイル --- */
    body {
      margin: 0; padding: 0;
      background-color: #2c3e50;
      color: white;
      overflow-x: hidden;
      -webkit-user-select: none; user-select: none;
    }
    .header-bar {
      background: rgba(0,0,0,0.5); padding: 15px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .back-btn {
      background: #ccc; border: none; padding: 8px 20px; border-radius: 5px;
      cursor: pointer; font-weight: bold; color: black;
    }
    h2 { text-align: center; margin: 20px 0; border-bottom: 2px solid #aaa; padding-bottom: 10px; }
    
    .container { max-width: 800px; margin: 0 auto; padding: 10px; padding-bottom: 50px; }
    
    .section-title { font-size: 1.2rem; margin-top: 30px; color: #4facfe; font-weight: bold; }

    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px; margin-top: 10px;
    }

    .inv-card {
      background: white; color: black;
      border-radius: 10px; padding: 10px;
      text-align: center;
      position: relative;
      border: 3px solid transparent;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    }
    .inv-card.equipped {
      border-color: #ffd700;
      background: #fff8dc;
      box-shadow: 0 0 10px #ffd700;
    }

    .item-img {
      width: 80px; height: 80px; background: #ddd; margin: 0 auto 10px;
      border-radius: 5px; display: flex; align-items: center; justify-content: center;
      background-size: cover; background-position: center;
      flex-shrink: 0;
      position: relative; /* 試聴ボタンの配置基準 */
    }

    .item-desc {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 8px;
      line-height: 1.3;
      width: 100%;
      min-height: 2.6em;
    }
    
    .equip-btn {
      width: 100%; padding: 8px; margin-top: 5px;
      border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
      background: #007bff; color: white;
    }
    .equip-btn.active {
      background: #28a745; cursor: default;
    }

    /* 試聴ボタンのスタイル */
    .preview-btn {
      position: absolute;
      bottom: 2px; right: 2px; /* 画像の右下に配置 */
      width: 24px; height: 24px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: 2px solid white;
      font-size: 10px;
      cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      z-index: 5;
    }
    .preview-btn:hover { background: rgba(255, 69, 0, 0.8); }
    
    /* 再生中のアニメーション */
    .preview-btn.playing {
      background: #ff4500;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); }
      70% { box-shadow: 0 0 0 8px rgba(255, 69, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
    }
  </style>
</head>
<body>

<div id="loading-screen">
  <div class="loader-content">
    <div class="spinner"></div>
    <div id="loading-tips"></div>
    <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.8;">読み込み中...</p>
  </div>
</div>

<div class="header-bar">
  <button class="back-btn" onclick="window.location.href='home.html'">← ホームへ</button>
  <span style="font-weight:bold;">所持品・着せ替え</span>
</div>

<div class="container">
  
  <div class="section-title">将棋の駒</div>
  <div id="pieceList" class="item-grid"></div>

  <div class="section-title">将棋盤</div>
  <div id="boardList" class="item-grid"></div>

  <div class="section-title">BGM（再生ボタンで視聴ができます！）</div>
  <div id="bgmList" class="item-grid"></div>

</div>

<script src="script/items.js"></script>
<script src="script/auth.js"></script>

<script>
  let myInventory = [];
  let myEquipped = { piece: "piece_default", board: "board_default", bgm: "bgm_default" };
  
  // 試聴用の音声変数
  let currentPreviewAudio = null;
  let currentPreviewId = null;

  document.addEventListener("DOMContentLoaded", () => {
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        db.collection("users").doc(user.uid).onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            myInventory = data.inventory || [];
            
            if (!myInventory.includes("piece_default")) myInventory.push("piece_default");
            if (!myInventory.includes("board_default")) myInventory.push("board_default");
            if (!myInventory.includes("bgm_default")) myInventory.push("bgm_default");

            myEquipped = data.equipped || { piece: "piece_default", board: "board_default", bgm: "bgm_default" };
            
            renderInventory();
          }
        });
      } else {
        alert("ログインしてください");
        window.location.href = "home.html";
      }
    });
  });

  function renderInventory() {
    if (typeof GAME_ITEMS === 'undefined') {
        console.error("GAME_ITEMS is not defined. script/items.js failed to load.");
        return;
    }

    const pieceContainer = document.getElementById("pieceList");
    const boardContainer = document.getElementById("boardList");
    const bgmContainer = document.getElementById("bgmList"); 

    pieceContainer.innerHTML = "";
    boardContainer.innerHTML = "";
    bgmContainer.innerHTML = "";

    GAME_ITEMS.forEach(item => {
      if (myInventory.includes(item.id)) {
        if (item.type === "piece") {
            createItemCard(item, pieceContainer);
        } else if (item.type === "board") {
            createItemCard(item, boardContainer);
        } else if (item.type === "bgm") {
            createItemCard(item, bgmContainer);
        }
      }
    });
  }

  function createItemCard(item, container) {
    const isEquipped = (myEquipped[item.type] === item.id);
    
    const card = document.createElement("div");
    card.className = "inv-card" + (isEquipped ? " equipped" : "");

    let imgStyle = "";
    let imgText = item.placeholderText || "";

    if (item.image) {
        imgStyle = `background-image: url('${item.image}');`;
        imgText = "";
    } else if (item.type === "bgm") {
        imgText = "♪"; 
    }

    // 画像エリアのHTML作成（BGMならボタン追加）
    let imageAreaHTML = `<div class="item-img" style="${imgStyle}">${imgText}`;
    if (item.type === 'bgm') {
        imageAreaHTML += `<button class="preview-btn" id="btn-${item.id}" onclick="playPreview('${item.id}', '${item.src}')">▶</button>`;
    }
    imageAreaHTML += `</div>`;

    card.innerHTML = `
      ${imageAreaHTML}
      <div style="font-weight:bold; font-size:0.9rem;">${item.name}</div>
      <div class="item-desc">${item.desc || ""}</div>
    `;

    const btn = document.createElement("button");
    btn.className = "equip-btn" + (isEquipped ? " active" : "");
    btn.textContent = isEquipped ? "装備中" : "装備する";
    
    if (!isEquipped) {
      btn.onclick = () => equipItem(item.type, item.id);
    }

    card.appendChild(btn);
    container.appendChild(card);
  }

  // 試聴処理
  function playPreview(id, src) {
      if (currentPreviewId === id) {
          stopPreview();
          return;
      }
      if (currentPreviewAudio) {
          stopPreview();
      }

      currentPreviewAudio = new Audio(src);
      currentPreviewAudio.volume = 0.5;
      currentPreviewId = id;

      const btn = document.getElementById(`btn-${id}`);
      if (btn) {
          btn.textContent = "■";
          btn.classList.add("playing");
      }

      currentPreviewAudio.play().catch(e => {
          console.error("再生エラー:", e);
          stopPreview();
      });

      currentPreviewAudio.onended = () => {
          stopPreview();
      };
  }

  function stopPreview() {
      if (currentPreviewAudio) {
          currentPreviewAudio.pause();
          currentPreviewAudio = null;
      }
      if (currentPreviewId) {
          const btn = document.getElementById(`btn-${currentPreviewId}`);
          if (btn) {
              btn.textContent = "▶";
              btn.classList.remove("playing");
          }
          currentPreviewId = null;
      }
  }

  function equipItem(type, id) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    stopPreview();

    const updateKey = `equipped.${type}`;
    
    db.collection("users").doc(user.uid).update({
      [updateKey]: id
    }).then(() => {
      console.log("装備変更: " + id);
    });
  }

  // 画面を離れる時に停止
  window.onbeforeunload = function() {
      stopPreview();
  };
</script>

<script>
    const loadingTipsList = [
        "【tips】キャラクターにはそれぞれ固有の必殺技があります。",
        "【tips】オンライン対局は、先に入室した方が先手になります。",
        "【tips】棋譜では、自分のこれまでの対局を振り返るだけでなく、解析もできます。",
        "【tips】メニューボタンから、ホーム画面のキャラクターを変更できます。",
        "【tips】CPUの必殺技は、2回行動です。",
        "【tips】CPUは必殺技ゲージが300たまると必ず必殺技を打ってきます。"
    ];

    function showRandomTips() {
        const tipEl = document.getElementById('loading-tips');
        if (!tipEl) return;
        const randomTip = loadingTipsList[Math.floor(Math.random() * loadingTipsList.length)];
        tipEl.textContent = randomTip;
    }

    let tipsInterval = null;

    document.addEventListener('DOMContentLoaded', () => {
        showRandomTips();
        tipsInterval = setInterval(showRandomTips, 3000);
    });

    window.addEventListener('load', () => {
        const loader = document.getElementById('loading-screen');
        
        document.fonts.ready.then(() => {
            setTimeout(() => {
                clearInterval(tipsInterval);
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }, 800); // 演出のため少し待機
        });
    });
</script>

</body>
</html>

