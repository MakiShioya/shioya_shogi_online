<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>所持品・着せ替え - しおや将棋</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    body {
      margin: 0; padding: 0;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background-color: #2c3e50;
      color: white;
      overflow-x: hidden;
      -webkit-user-select: none; user-select: none;
    }
    .header-bar {
      background: rgba(0,0,0,0.5); padding: 15px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .back-btn {
      background: #ccc; border: none; padding: 8px 20px; border-radius: 5px;
      cursor: pointer; font-weight: bold; color: black;
    }
    h2 { text-align: center; margin: 20px 0; border-bottom: 2px solid #aaa; padding-bottom: 10px; }
    
    .container { max-width: 800px; margin: 0 auto; padding: 10px; }
    
    .section-title { font-size: 1.2rem; margin-top: 30px; color: #4facfe; font-weight: bold; }

    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px; margin-top: 10px;
    }

    .inv-card {
      background: white; color: black;
      border-radius: 10px; padding: 10px;
      text-align: center;
      position: relative;
      border: 3px solid transparent;
      /* カードの高さを揃えるためにフレックスボックス化 */
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    }
    .inv-card.equipped {
      border-color: #ffd700;
      background: #fff8dc;
      box-shadow: 0 0 10px #ffd700;
    }

    .item-img {
      width: 80px; height: 80px; background: #ddd; margin: 0 auto 10px;
      border-radius: 5px; display: flex; align-items: center; justify-content: center;
      background-size: cover; background-position: center;
      flex-shrink: 0; /* 画像がつぶれないように */
    }

    /* ★★★ 追加：説明文用のスタイル ★★★ */
    .item-desc {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 8px;
      line-height: 1.3;
      width: 100%;
      min-height: 2.6em; /* 2行分確保 */
    }
    
    .equip-btn {
      width: 100%; padding: 8px; margin-top: 5px;
      border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
      background: #007bff; color: white;
    }
    .equip-btn.active {
      background: #28a745; cursor: default;
    }
  </style>
</head>
<body>

<div class="header-bar">
  <button class="back-btn" onclick="window.location.href='home.html'">← ホームへ</button>
  <span style="font-weight:bold;">所持品・着せ替え</span>
</div>

<div class="container">
  
  <div class="section-title">将棋の駒</div>
  <div id="pieceList" class="item-grid"></div>

  <div class="section-title">将棋盤</div>
  <div id="boardList" class="item-grid"></div>

  <div class="section-title">BGM</div>
  <div id="bgmList" class="item-grid"></div>

</div>

<script src="script/items.js"></script>
<script src="script/auth.js"></script>

<script>
  let myInventory = [];
  let myEquipped = { piece: "piece_default", board: "board_default", bgm: "bgm_default" };

  document.addEventListener("DOMContentLoaded", () => {
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        db.collection("users").doc(user.uid).onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            myInventory = data.inventory || [];
            
            if (!myInventory.includes("piece_default")) myInventory.push("piece_default");
            if (!myInventory.includes("board_default")) myInventory.push("board_default");
            if (!myInventory.includes("bgm_default")) myInventory.push("bgm_default");

            myEquipped = data.equipped || { piece: "piece_default", board: "board_default", bgm: "bgm_default" };
            
            renderInventory();
          }
        });
      } else {
        alert("ログインしてください");
        window.location.href = "home.html";
      }
    });
  });

  function renderInventory() {
    if (typeof GAME_ITEMS === 'undefined') {
        console.error("GAME_ITEMS is not defined. script/items.js failed to load.");
        return;
    }

    const pieceContainer = document.getElementById("pieceList");
    const boardContainer = document.getElementById("boardList");
    const bgmContainer = document.getElementById("bgmList"); 

    pieceContainer.innerHTML = "";
    boardContainer.innerHTML = "";
    bgmContainer.innerHTML = "";

    GAME_ITEMS.forEach(item => {
      if (myInventory.includes(item.id)) {
        if (item.type === "piece") {
            createItemCard(item, pieceContainer);
        } else if (item.type === "board") {
            createItemCard(item, boardContainer);
        } else if (item.type === "bgm") {
            createItemCard(item, bgmContainer);
        }
      }
    });
  }

  function createItemCard(item, container) {
    // 厳密なID比較で装備判定
    const isEquipped = (myEquipped[item.type] === item.id);
    
    const card = document.createElement("div");
    card.className = "inv-card" + (isEquipped ? " equipped" : "");

    let imgStyle = "";
    let imgText = item.placeholderText || "";

    if (item.image) {
        imgStyle = `background-image: url('${item.image}');`;
        imgText = "";
    } else if (item.type === "bgm") {
        imgText = "♪"; 
    }

    // ★★★ 修正：名前の下に desc を表示する行を追加 ★★★
    card.innerHTML = `
      <div class="item-img" style="${imgStyle}">${imgText}</div>
      <div style="font-weight:bold; font-size:0.9rem;">${item.name}</div>
      <div class="item-desc">${item.desc || ""}</div>
    `;

    const btn = document.createElement("button");
    btn.className = "equip-btn" + (isEquipped ? " active" : "");
    btn.textContent = isEquipped ? "装備中" : "装備する";
    
    if (!isEquipped) {
      btn.onclick = () => equipItem(item.type, item.id);
    }

    card.appendChild(btn);
    container.appendChild(card);
  }

  function equipItem(type, id) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const updateKey = `equipped.${type}`;
    
    db.collection("users").doc(user.uid).update({
      [updateKey]: id
    }).then(() => {
      console.log("装備変更: " + id);
    });
  }
</script>
</body>
</html>
