<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>待機室</title>
<link rel="icon" href="script/image/komiya_icon.png">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script src="script/auth.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
    /* ▼▼▼ 追加：HTML全体でスクロールを禁止 ▼▼▼ */
    html {
        overflow: hidden;
        height: 100%;
        overscroll-behavior: none; /* バウンス効果（引っ張り）を無効化 */
    }

    body {
        font-family: Arial, sans-serif;
        background-color: #333;
        color: white;
        text-align: center;
        padding: 20px;

        /* 画面いっぱいに固定 */
        height: 100%;
        width: 100%;
        margin: 0;
        overflow: hidden; 
        box-sizing: border-box;

        /* ▼▼▼ コピー・長押し禁止設定 ▼▼▼ */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-user-drag: none;

        /* ▼▼▼ 追加：タップ操作の最適化（スクロール禁止含む） ▼▼▼ */
        touch-action: none;
    }
    .container {
        max-width: 700px;
        margin: 0 auto;
        background: rgba(255,255,255,0.1);
        padding: 2px 20px;
        border-radius: 15px;
    }
    h1 { color: #FFB347; }
    
    .player-box {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
    }
    .player-card {
        background: #444;
        width: 40%;
        padding: 20px;
        border-radius: 10px;
        border: 3px solid #666;
        transition: all 0.3s;
    }
    /* 自分の枠 */
    .player-card.is-me { border-color: #FFB347; }
    /* 準備完了時 */
    .player-card.ready { background: #225522; border-color: #00ff00; }

    .role-label { font-size: 1.2rem; margin-bottom: 10px; font-weight: bold; }
    .status-badge {
        display: inline-block;
        padding: 5px 15px;
        background: #888;
        border-radius: 20px;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    .ready .status-badge { background: #00ff00; color: #000; font-weight: bold; }

    #readyBtn {
        padding: 5px 50px;
        font-size: 1.5rem;
        background: #555;
        color: #aaa;
        border: none;
        border-radius: 50px;
        cursor: not-allowed;
        transition: 0.2s;
    }
    /* 自分が席に着いたら押せる */
    #readyBtn.active {
        background: #ff4500;
        color: white;
        cursor: pointer;
        box-shadow: 0 5px 0 #b33200;
    }
    #readyBtn.active:active { transform: translateY(4px); box-shadow: 0 1px 0 #b33200; }
    
    /* 準備完了状態のボタン */
    #readyBtn.pushed {
        background: #28a745;
        box-shadow: 0 5px 0 #1e7e34;
    }

    .msg-area { margin-top: 3px; font-size: 1rem; color: #FFB347; min-height: 1.5em; }


/* ボタンを横並びにするコンテナ */
.button-group {
    display: flex;
    justify-content: center;
    gap: 20px; /* ボタン同士の間隔 */
    margin-top: 20px;
}

/* 共通のボタンスタイル（準備OKボタンの設定を流用） */
#readyBtn, #backBtn {
    padding: 9px 0; /* 高さを少し調整 */
    width: 180px;
    text-align: center;
    font-size: 1.2rem;
    border: none;
    border-radius: 50px;
    transition: 0.2s;
    font-weight: bold;
    cursor: pointer;
}

/* 戻るボタン専用の色 */
#backBtn {
    background: #666;
    color: white;
    box-shadow: 0 5px 0 #444;
}

#backBtn:active {
    transform: translateY(4px);
    box-shadow: 0 1px 0 #444;
}

/* 準備OKボタンの初期状態（activeがつく前） */
#readyBtn {
    background: #555;
    color: #aaa;
    cursor: not-allowed;
}

    /* --- ★追加：ルーム設定用スタイル --- */
.room-settings {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid #666;
    border-radius: 10px;
    padding: 10px;
    margin: 15px auto;
    max-width: 90%;
}
.room-settings h3 {
    margin: 0 0 10px 0;
    font-size: 1rem;
    color: #ddd;
}
.mode-toggle-container {
    display: flex;
    justify-content: center;
    gap: 10px;
}
.mode-select-btn {
    flex: 1;
    padding: 8px;
    border: 2px solid #555;
    background: #333;
    color: #aaa;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
}
/* 選択されている側のスタイル */
.mode-select-btn.selected {
    background: #FFB347; /* かじゅある色 */
    color: #333;
    border-color: #FFB347;
    box-shadow: 0 0 10px rgba(255, 179, 71, 0.5);
}
/* ふぉーまる選択時のスタイル上書き */
#modeBtnFormal.selected {
    background: #607d8b; /* ふぉーまる色 */
    color: white;
    border-color: #607d8b;
    box-shadow: 0 0 10px rgba(96, 125, 139, 0.5);
}

</style>
</head>
<body>

<div class="container">
    <h1 id="roomTitle">待機室</h1>
    <div class="player-box">
        <div id="cardBlack" class="player-card">
            <div class="role-label">▲ 先手</div>
            <div id="nameBlack">空席</div>
            <div class="status-badge" id="badgeBlack">準備中</div>
        </div>

        <div id="cardWhite" class="player-card">
            <div class="role-label">△ 後手</div>
            <div id="nameWhite">空席</div>
            <div class="status-badge" id="badgeWhite">準備中</div>
        </div>
    </div>


    <div class="room-settings">
    <h3>対局モード設定</h3>
    <div class="mode-toggle-container">
        <button id="modeBtnCasual" class="mode-select-btn selected" onclick="changeRoomMode('casual')">
            かじゅある<br><span style="font-size:0.7rem">必殺技あり</span>
        </button>
        <button id="modeBtnFormal" class="mode-select-btn" onclick="changeRoomMode('formal')">
            ふぉーまる<br><span style="font-size:0.7rem">必殺技なし</span>
        </button>
    </div>
</div>

    


    
    <div class="button-group">

    <button id="readyBtn" onclick="toggleReady()">準備OK</button>
 <button id="backBtn" onclick="location.href='online_room_lobby.html'">戻る</button>
</div>
    <div class="msg-area" id="msgArea"></div>
</div>

<script>
    const socket = io();
    let myUserId = localStorage.getItem('shogi_user_id');
    let myRole = null;
    let roomId = new URLSearchParams(window.location.search).get('room') || 'default';
    let currentRoomMode = 'casual';

    // document.getElementById('roomTitle').textContent = `部屋: ${roomId}`;

    // 接続と入室
    socket.on('connect', () => {
        if(!myUserId) {
            myUserId = 'user_' + Math.random().toString(36).substr(2,9);
            localStorage.setItem('shogi_user_id', myUserId);
        }
        // キャラ情報宣言
        const myCharId = sessionStorage.getItem('my_character') || 'default';
        socket.emit('declare character', myCharId);

        // 入室
        socket.emit('enter game', { roomId, userId: myUserId });
    });

    // 自分の役割受信
    socket.on('role assigned', (role) => {
        myRole = role;
        const btn = document.getElementById('readyBtn');
        if (role === 'black' || role === 'white') {
            btn.classList.add('active'); // 押せるようにする
            btn.disabled = false;
        } else {
            document.getElementById('msgArea').textContent = "観戦者として参加しています";
        }
    });

    // 部屋の最新状態を受信
    socket.on('update room status', (info) => {
        // もし「すでに対局中」なら、即ゲーム画面へ転送する（リロード対策）
        if (info.status === 'playing') {
            goToGame();
            return;
        }

        updateCard('black', info.blackId, info.blackReady);
        updateCard('white', info.whiteId, info.whiteReady);
    });

    function updateCard(role, userId, isReady) {
        const card = document.getElementById(role === 'black' ? 'cardBlack' : 'cardWhite');
        const nameDiv = document.getElementById(role === 'black' ? 'nameBlack' : 'nameWhite');
        const badge = document.getElementById(role === 'black' ? 'badgeBlack' : 'badgeWhite');

        // 名前表示（自分なら強調）
        if (userId) {
            nameDiv.textContent = (userId === myUserId) ? "あなた" : "対戦相手";
            if (userId === myUserId) card.classList.add('is-me');
        } else {
            nameDiv.textContent = "空席";
            card.classList.remove('is-me');
        }

        // Ready状態の表示
        if (isReady) {
            card.classList.add('ready');
            badge.textContent = "準備完了！";
            if (userId === myUserId) {
                const btn = document.getElementById('readyBtn');
                btn.textContent = "キャンセル";
                btn.classList.add('pushed');
            }
        } else {
            card.classList.remove('ready');
            badge.textContent = "準備中";
            if (userId === myUserId) {
                const btn = document.getElementById('readyBtn');
                btn.textContent = "準備OK";
                btn.classList.remove('pushed');
            }
        }
    }

    // 準備ボタン
    function toggleReady() {
        if (!myRole || myRole === 'spectator') return;
        socket.emit('toggle ready');
    }

    // 全員完了時のスタート命令
    socket.on('all ready', () => {
        document.getElementById('msgArea').textContent = "両者準備完了！まもなく対局を開始します...";
        document.getElementById('readyBtn').disabled = true;
        setTimeout(goToGame, 3000); // 3秒後に移動
    });

    function goToGame() {
        window.location.href = `player_vs_player_online.html?room=${encodeURIComponent(roomId)}`;
    }

// ★★★ Firebaseのログイン状態を監視して、名前を同期する処理 ★★★
if (typeof firebase !== 'undefined' && firebase.auth) {
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            // ログインしている場合
            // 表示名(displayName)がなければメールアドレスの前半を使うなどの予備処理
            const displayName = user.displayName || (user.email ? user.email.split('@')[0] : "名無し");
            
            // LocalStorageに保存（これで次回から自動的に名前が使われる）
            localStorage.setItem('shogi_username', displayName);
            
            console.log("ログイン確認: " + displayName + " として保存しました。");

            // もし画面上に名前を表示する要素があれば更新する
            // (ロビー画面など用)
            const nameDisplay = document.getElementById('myCharName'); // ロビーのID
            if (nameDisplay && nameDisplay.textContent === "---") {
                 // ロビーの場合はキャラ名が表示されるので、
                 // 必要であればここで "ようこそ 〇〇さん" のように書き換える処理を入れる
            }
            
        } else {
            // ログインしていない場合
            console.log("未ログインです。");
        }
    });
}
</script>

<script>
  // 右クリック・長押しメニュー禁止
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
  }, { passive: false });

  // 画像などのドラッグ禁止
  document.addEventListener('dragstart', function(e) {
    e.preventDefault();
  }, { passive: false });

  // iOSでのピンチイン・ピンチアウト拡大を禁止
  document.addEventListener('gesturestart', function(e) {
    e.preventDefault();
  });
  
  // ダブルタップによる拡大を禁止
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  // ▼▼▼ 追加：スクロール（指でのスライド）を禁止 ▼▼▼
  document.addEventListener('touchmove', function(e) {
    // ページ全体のスクロールを完全に無効化
    e.preventDefault();
  }, { passive: false });

    // 1. ボタンを押したときの処理
function changeRoomMode(mode) {
    // サーバーに「モード変わったよ」と通知
    // ※サーバー側でこれを受け取り、部屋内の全員に broadcast する必要があります
    socket.emit('change room mode', { roomId: roomId, mode: mode });
}

// 2. サーバーから「モードが変わったよ」と通知が来たときの処理
socket.on('update room mode', (mode) => {
    currentRoomMode = mode;
    updateModeUI(mode);
});

// 3. UIの見た目を更新する関数
function updateModeUI(mode) {
    const btnCasual = document.getElementById('modeBtnCasual');
    const btnFormal = document.getElementById('modeBtnFormal');
    
    if (mode === 'casual') {
        btnCasual.classList.add('selected');
        btnFormal.classList.remove('selected');
    } else {
        btnCasual.classList.remove('selected');
        btnFormal.classList.add('selected');
    }
}

// 4. 【重要】対局画面へ移動する処理の修正
function goToGame() {
    // ★URLパラメータに mode を追加して渡す！
    // これで「ホーム画面の設定」ではなく「部屋の設定」が優先されます
    window.location.href = `player_vs_player_online.html?room=${encodeURIComponent(roomId)}&mode=${currentRoomMode}`;
}
    
</script>

</body>
</html>


