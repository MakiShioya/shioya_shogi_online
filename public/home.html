<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
Â  <title>ã—ãŠã‚„å°†æ£‹ - ãƒ›ãƒ¼ãƒ </title>
Â  <link rel="icon" href="script/image/komiya_icon.png">Â 
Â  <link rel="manifest" href="manifest.json">
Â  <link rel="apple-touch-icon" href="script/image/komiya_icon.png">
Â Â 
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
Â  <script src="/socket.io/socket.io.js"></script>

Â  <style>

Â  Â  @font-face {
Â  Â  Â  font-family: 'SetoFont';Â  /* å¥½ããªåå‰ã§OK */
Â  Â  Â  src: url('script/font/setofont.ttf') format('truetype'); /* ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ */
Â  Â  }
Â  Â Â 
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  font-family: "SetoFont", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
Â  Â  Â  position: fixed;Â 
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;Â  Â /* vw, vh ã§ã¯ãªã % ã‚’ä½¿ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆ */
Â  Â  height: 100%;
Â  Â Â 
Â  Â  background-color: #2c3e50;
Â  Â  background-size: cover;
Â  Â  background-position: center;
Â  Â  overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å‡ºã•ãªã„ */

Â  Â  /* â˜…â˜…â˜… ã“ã“ãŒæœ€é‡è¦ï¼šã‚¹ãƒ¯ã‚¤ãƒ—ã«ã‚ˆã‚‹ç”»é¢é·ç§»ï¼ˆãƒã‚¦ãƒ³ã‚¹ï¼‰ã‚’ç¦æ­¢ã™ã‚‹ â˜…â˜…â˜… */
Â  Â  overscroll-behavior-x: none;Â 
Â  Â  overscroll-behavior-y: none;
Â  Â  overscroll-behavior: none;

Â  Â  -webkit-user-select: none;
Â  Â  -webkit-touch-callout: none;
Â  Â  user-select: none;
Â  Â  touch-action: none; /* ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ãªã©ã‚‚ç„¡åŠ¹åŒ– */
}

/* â˜…â˜…â˜… è¿½åŠ ï¼šhtmlã‚¿ã‚°ã«ã‚‚é©ç”¨ã—ãªã„ã¨åŠ¹ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ â˜…â˜…â˜… */
html {
    width: 100%;
    height: 100%;
    overflow: hidden;
    overscroll-behavior: none;
}

input, textarea {
   user-select: text;
   -webkit-user-select: text;
   touch-action: auto; /* ã“ã“ã‚‚å¿˜ã‚Œãšã«ï¼ */
 }

/* èƒŒæ™¯å°‚ç”¨ã®è¨­å®š */
    #bg-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1; /* ä»–ã®è¦ç´ ã‚ˆã‚ŠèƒŒé¢ã«é…ç½® */
      background-image: url('script/image/shogi_title.PNG');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    /* å¹ãå‡ºã—ã®è¨­å®š */
    .speech-bubble {
      display: none;
      position: absolute;
      bottom: 30vh;
      left: 50%;
      transform: translateX(-50%);
      background: #fff8dc;
      border: 3px solid #8b4513;
      border-radius: 20px;
      padding: 12px 20px;
      min-width: 160px;
      max-width: 220px;
      color: #333;
      font-weight: bold;
      font-size: 0.95rem;
      z-index: 100;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      pointer-events: none;
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .speech-bubble::after {
      content: '';
      position: absolute;
      bottom: 100%;
      right: 20%;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 15px solid #8b4513;
    }

    @keyframes pop-in {
      0% { transform: translateX(-50%) scale(0); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    .character-stand {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      height: 85vh;
      width: auto;
      max-width: 95%;
      z-index: 1;

      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
      cursor: pointer;
      pointer-events: auto;
    }

    .user-info-bar {
      position: absolute;
      top: 0;
      width: 100%;
      padding: 10px 20px; 
      background: rgba(0, 0, 0, 0.6);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
      z-index: 5;
    }

    .user-name { font-weight: bold; font-size: 1.1rem; }
    
    .top-btn {
      border: none;
      color: white;
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 5px;
      font-weight: bold;
    }
    .stats-btn { background: #ff9800; }
    .news-btn { background: #28a745; }

    .bottom-menu {
      position: absolute;
      bottom: 10px;
      width: 96%;
      left: 2%;
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      gap: 5px;
      z-index: 10;
    }

    .menu-btn {
      flex: 1;
      height: 60px;
      background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
      border: 2px solid white;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .menu-btn:active { transform: scale(0.95); }

    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
      overscroll-behavior: none;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-box {
    position: relative;
    background: #fff8dc;
    padding: 15px;
    border-radius: 10px;
    border: 4px solid #8b4513;
    text-align: center;
    width: 80%;
    max-width: 800px;
    
    /* â˜…â˜…â˜… ã“ã“ãŒé‡è¦ï¼šç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„è¨­å®š â˜…â˜…â˜… */
    max-height: 85vh; /* ç”»é¢ã®é«˜ã•ã®85%ã¾ã§ã«åˆ¶é™ */
    display: flex;    /* ä¸­èº«ã‚’ç¸¦ä¸¦ã³ã®Flexãƒœãƒƒã‚¯ã‚¹ã«ã™ã‚‹ */
    flex-direction: column; /* ç¸¦æ–¹å‘ã«ä¸¦ã¹ã‚‹ */
    box-sizing: border-box;
}

    .modal-body {
    flex: 1;            /* ä½™ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨éƒ¨ä½¿ã† */
    overflow-y: auto;   /* ä¸­èº«ãŒæº¢ã‚ŒãŸã‚‰ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å‡ºã™ */
    margin: 10px 0;     /* ä¸Šä¸‹ã®ä½™ç™½ */
    padding: 5px;       /* å†…å´ã®ä½™ç™½ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨æ–‡å­—ãŒè¢«ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®æ“ä½œæ€§ã‚’è‰¯ãã™ã‚‹è¨­å®š */
    -webkit-overflow-scrolling: touch; 
}
    
    /* ãƒœã‚¿ãƒ³ã‚’2åˆ—ã«ä¸¦ã¹ã‚‹ãŸã‚ã®ã‚°ãƒªãƒƒãƒ‰è¨­å®š */
    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }

    .sub-btn {
      display: block;
      width: 100%;
      margin: 0;
      padding: 12px 5px;
      font-size: 1rem;
      background: #8b4513;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .sub-btn:active { transform: scale(0.98); opacity: 0.9; }

    /* ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .close-small-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      background: #666;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      cursor: pointer;
      z-index: 101;
    }

    #lobbyChatTitle {
      color: #005bea;
      margin: 0 0 5px 0;
      text-align: left;
      padding-left: 5px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    #lobbyChatHistory {
      flex: 1; 
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-height: 100px;
    }

    .chat-input-area {
      display: flex;
      gap: 5px;
      margin-top: 8px;
    }

    /* --- ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .mail-btn {
      position: relative;
      background: #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
    }
    
    /* æœªèª­ãƒãƒƒã‚¸ï¼ˆèµ¤ä¸¸ï¼‰ */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: red;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      border: 2px solid white;
      z-index: 10;
      display: none; /* åˆæœŸã¯éè¡¨ç¤º */
    }

    /* ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ */
    #mailList {
      list-style: none;
      padding: 0;
      margin: 0;
      width: 100%;
      text-align: left;
    }

    .mail-item {
      background: white;
      border-bottom: 1px solid #ccc;
      padding: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .mail-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
    .mail-item:last-child { border-bottom: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
    .mail-item:active { background: #f0f0f0; }
    
    .mail-item.unread {
      background: #fff8dc; /* æœªèª­ã¯å°‘ã—é»„è‰²ã */
      font-weight: bold;
    }
    .mail-item.unread::before {
      content: 'â—';
      color: #d35400;
      margin-right: 8px;
    }

    .mail-subject { font-size: 1rem; color: #333; flex: 1; }
    .mail-date { font-size: 0.8rem; color: #888; margin-left: 10px; }

    /* ãƒ¡ãƒ¼ãƒ«è©³ç´°ç”»é¢ */
    #mailDetailView {
      display: none; /* åˆæœŸéè¡¨ç¤º */
      flex-direction: column;
      height: 100%;
      text-align: left;
    }
    .mail-header {
      border-bottom: 2px solid #8b4513;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .mail-detail-subject { font-size: 1.2rem; font-weight: bold; color: #8b4513; }
    .mail-detail-date { font-size: 0.85rem; color: #666; margin-top: 5px; }
    .mail-body {
      flex: 1;
      font-size: 1rem;
      line-height: 1.6;
      white-space: pre-wrap; /* æ”¹è¡Œã‚’åæ˜  */
      background: rgba(255,255,255,0.6);
      padding: 10px;
      border-radius: 5px;
      overflow-y: auto;
    }
    .mail-reward-area {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border: 2px dashed #ff9800;
      border-radius: 10px;
      text-align: center;
    }

    /* --- å·¦å´ã®æµ®éŠãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ --- */
    .right-side-menu {
      position: absolute;
      left: 15px;
      top: 100px; /* ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸‹ã‚ãŸã‚Š */
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 20; /* ã‚­ãƒ£ãƒ©ç”»åƒã‚ˆã‚Šæ‰‹å‰ã« */
    }

    .mission-main-btn {
      width: 70px;
      height: 70px;
      background: linear-gradient(to bottom, #fff176, #fbc02d); /* é‡‘è‰²ã£ã½ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      border: 3px solid #fff;
      border-radius: 50%; /* ä¸¸ã„ãƒœã‚¿ãƒ³ */
      color: #5d4037;
      font-weight: bold;
      font-size: 0.8rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      animation: float-btn 3s infinite ease-in-out; /* ãµã‚ãµã‚å‹•ã */
    }
    
    .mission-main-btn:active {
      transform: scale(0.95);
    }

    .mission-icon-emoji {
      font-size: 1.5rem;
      margin-bottom: 2px;
      display: block;
    }

    /* ãµã‚ãµã‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes float-btn {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨ãƒãƒƒã‚¸ï¼ˆæœªé”æˆãƒ»å ±é…¬ã‚ã‚Šã®æ•°ãªã©ï¼‰ */
    .mission-badge {
      position: absolute;
      top: 0;
      right: 0;
      background-color: #d32f2f;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 2px solid white;
      font-weight: bold;
      display: none; /* JSã§åˆ¶å¾¡ */
    }

    /* --- æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆå³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ï¼‰ --- */
    .mail-main-btn {
      width: 70px;
      height: 70px;
      background: linear-gradient(to bottom, #ffcc80, #ef6c00); /* ã‚ªãƒ¬ãƒ³ã‚¸ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      border: 3px solid #fff;
      border-radius: 50%;
      color: #fff;
      font-weight: bold;
      font-size: 0.8rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      animation: float-btn 3s infinite ease-in-out;
      animation-delay: 1.5s; /* ä»»å‹™ãƒœã‚¿ãƒ³ã¨å‹•ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã‚ºãƒ©ã™ */
    }
    
    .mail-main-btn:active {
      transform: scale(0.95);
    }

    .mail-icon-emoji {
      font-size: 1.5rem;
      margin-bottom: 2px;
      display: block;
    }

    /* â˜…â˜…â˜… ãƒ¡ãƒ¼ãƒ«ã®çŠ¶æ…‹ã”ã¨ã®è‰²åˆ†ã‘ â˜…â˜…â˜… */
    /* 1. æ·»ä»˜ã‚ã‚Šãƒ»æœªå—ã‘å–ã‚Šï¼ˆè–„ã„é’ï¼‰ */
    .mail-item.type-reward-active {
      background-color: #e3f2fd;
      border-left: 5px solid #2196f3; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
    }
    
    /* 2. æ·»ä»˜ã‚ã‚Šãƒ»å—å–æ¸ˆã¿ï¼ˆè–„ã„ç°è‰²ï¼‰ */
    .mail-item.type-reward-claimed {
      background-color: #f5f5f5;
      color: #888;
      border-left: 5px solid #bdbdbd;
    }

    /* 3. æ·»ä»˜ãªã—ï¼ˆè–„ã„èµ¤ï¼‰ */
    .mail-item.type-normal {
      background-color: #ffebee;
      border-left: 5px solid #ef5350;
    }

    /* ãƒãƒ£ãƒƒãƒˆå¹ãå‡ºã—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³é–¢é€£ */
    .chat-row { display: flex; align-items: flex-start; gap: 10px; max-width: 95%; }
    .chat-row.mine { align-self: flex-end; flex-direction: row-reverse; }
    .icon-container { display: flex; flex-direction: column; align-items: center; width: 60px; }
    .chat-name-badge {
    /* æ è‡ªä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    background: #fff;
    border: 1px solid #8b4513;
    border-radius: 10px;
    z-index: 2;
    margin-bottom: -10px;
    
    /* â˜…â˜…â˜… ã“ã“ãŒé‡è¦ï¼šã‚µã‚¤ã‚ºã‚’å›ºå®šã™ã‚‹ â˜…â˜…â˜… */
    width: 60px;        /* å¹…ã‚’å›ºå®š */
    height: 18px;       /* é«˜ã•ã‚’å›ºå®š */
    display: flex;      /* ä¸­èº«ï¼ˆSVGï¼‰ã‚’ä¸­å¤®å¯„ã› */
    justify-content: center;
    align-items: center;
    padding: 0 4px;     /* å·¦å³ã«å°‘ã—ä½™ç™½ */
    overflow: hidden;   /* ã¯ã¿å‡ºã—é˜²æ­¢ï¼ˆå¿µã®ãŸã‚ï¼‰ */
}

    .chat-name-text {
    font-size: 12px;       /* åŸºæº–ã®æ–‡å­—ã‚µã‚¤ã‚º */
    font-weight: bold;
    fill: #333;            /* æ–‡å­—è‰² */
    text-anchor: middle;   /* ä¸­å¤®æƒãˆ */
    dominant-baseline: central; /* ä¸Šä¸‹ä¸­å¤®æƒãˆ */
}
    .chat-icon-img { width: 50px; height: 50px; border: 3px solid #56ab2f; border-radius: 12px; background: #fff; object-fit: cover; }
    .chat-row.mine .chat-icon-img { border: 3px solid #FFA500; }
    .chat-bubble { position: relative; padding: 10px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; word-break: break-all; }
    .chat-row .chat-bubble { background: #fff; border: 2px solid #e0e0e0; border-top-left-radius: 0; }
    .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; border-top-right-radius: 0; }

    /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
    .offline-color { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%) !important; }
    .online-color { background: linear-gradient(to bottom, #ff758c 0%, #ff7eb3 100%) !important; }
    .mypage-color { background: linear-gradient(to bottom, #f6d365 0%, #fda085 100%) !important; }
    .ready-color { background: linear-gradient(to bottom, #a8e063 0%, #56ab2f 100%) !important; }
    .chat-color { background: linear-gradient(to bottom, #da92ec 0%, #a06ee1 100%) !important; }

    /* â˜…â˜…â˜… è¿½åŠ ï¼šãƒãƒ£ãƒƒãƒˆã¨ãƒ¡ãƒ¼ãƒ«ã®ç”»é¢ã‚’æœ€å¤§ã‚µã‚¤ã‚ºã«å›ºå®šã™ã‚‹ â˜…â˜…â˜… */
    #lobbyChatModal .modal-box,
    #mailboxModal .modal-box {
 
      height: 85vh;       /* ç¸¦å¹…ã„ã£ã±ã„ï¼ˆç”»é¢ã®85%ï¼‰ */
      max-width: 800px;   /* PCã§è¦‹ã¦ã‚‚åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
      display: flex;
      flex-direction: column;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«æ¨ªå‘ãèª¿æ•´ */
    @media screen and (max-height: 450px) {
      .modal-box { padding: 10px; }
      #lobbyChatHistory { padding: 8px; }
    }
  </style>

</head>
<body>
  <div id="bg-image"></div>

  <div class="user-info-bar">
    <div>
      <span id="userNameDisplay" class="user-name">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“
      <button id="editNameBtn" onclick="showNameEditModal()" style="display:none; background:none; border:none; cursor:pointer; font-size:1rem;">âœï¸</button>
      
      <span style="margin-left: 15px; font-weight: bold; color: #ffd700; text-shadow: 1px 1px 2px #000;">
        ğŸ’° <span id="userGoldDisplay">0</span> G
      </span>
    </div>

    <div></div>
  </div>

  <div class="right-side-menu">
    <button class="mail-main-btn" onclick="openMailbox()">
      <span class="mail-icon-emoji">âœ‰</span>
      <div>ãƒ¡ãƒ¼ãƒ«</div>
      <span id="mailBadge" class="notification-badge">0</span>
    </button>
    <button class="mission-main-btn" onclick="window.location.href='mission.html'">
      <span class="mission-icon-emoji">ğŸ“œ</span>
      <div>ç›®æ¨™</div>
      <span id="missionBadge" class="mission-badge">!</span>
    </button>
  </div>

  <div id="characterBubble" class="speech-bubble"></div>

  <img class="character-stand" src="script/image/komiya_touka.png" alt="Character" onclick="talkCharacter()">

  <div class="bottom-menu">
    <button class="menu-btn offline-color" onclick="openModal('offlineMenu')">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</button>
    
    <button onclick="goToCharacterSelect('online')" class="menu-btn online-color">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</button>
    
    <button class="menu-btn chat-color" onclick="openLobbyChat()">ãƒãƒ£ãƒƒãƒˆ</button>
    
    <button class="menu-btn ready-color" onclick="window.location.href='shop.html'">ã‚·ãƒ§ãƒƒãƒ—</button>
    
    
    
    <button class="menu-btn mypage-color" onclick="window.location.href='mypage.html'">æ£‹è­œ</button>
    
    <button class="menu-btn" style="background: linear-gradient(to bottom, #607d8b 0%, #455a64 100%);" onclick="openModal('unifiedMenuModal')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
  </div>

  <div id="unifiedMenuModal" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <div class="modal-grid">
        <button class="sub-btn" style="background: linear-gradient(to bottom, #FF9800 0%, #F57C00 100%);" onclick="window.location.href='inventory.html'">ğŸ’ æ‰€æŒå“</button>
        <button class="sub-btn" style="background: #e91e63;" onclick="switchModal('unifiedMenuModal', 'characterSettingsMenu')">ğŸ‘¤ ã‚­ãƒ£ãƒ©</button>
        <button class="sub-btn" style="background: #ff9800;" onclick="showMyStats()">ğŸ“Š æˆ¦ç¸¾</button>
        <button class="sub-btn" style="background: #17a2b8;" onclick="switchModal('unifiedMenuModal', 'helpMainMenu')">â“ ãƒ˜ãƒ«ãƒ—</button>
        <button class="sub-btn" style="background: #6f42c1;" onclick="switchModal('unifiedMenuModal', 'helpContact')">ğŸ”§ ä¸å…·åˆ</button>
        <button class="sub-btn" style="background: #6c757d;" onclick="switchModal('unifiedMenuModal', 'settingsMainMenu')">âš™ï¸ è¨­å®š</button>
      </div>
      <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('unifiedMenuModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="newsModal" class="overlay">
    <div class="modal-box">
      <h3 style="color:#d35400; margin-top:0;">ğŸ”” æœ€æ–°æƒ…å ±</h3>
      <div style="text-align: left; margin: 20px 0; line-height: 1.6; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;">
        ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ å®Ÿè£…ï¼<br>
        ãƒ»ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ è¿½åŠ ï¼<br>
        ãƒ»æ£‹è­œè§£ææ©Ÿèƒ½ å®Ÿè£…ï¼<br>
        ãƒ»æœ€å¼·CPUå®Ÿè£…ï¼
      </div>
      <button onclick="closeModal('newsModal')" style="background: #ccc; border: none; color: black; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="settingsMainMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">è¨­å®š</h3>
    <div class="modal-grid">
      <button class="sub-btn" style="background: #e91e63;" onclick="switchModal('settingsMainMenu', 'characterSettingsMenu')">ã‚­ãƒ£ãƒ©è¨­å®š</button>
      
      <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'volumeMenu')">éŸ³é‡è¨­å®š</button>
      <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'languageMenu')">è¨€èªè¨­å®š</button>
      <button class="sub-btn" onclick="openAccountFromSettings()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
    </div>
    <button class="sub-btn" style="background:#666;" onclick="closeModal('settingsMainMenu')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="volumeMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">éŸ³é‡è¨­å®š</h3>
    <div style="margin: 20px 0;">
      <p>BGM</p><input type="range" style="width:80%;">
      <p>åŠ¹æœéŸ³</p><input type="range" style="width:80%;">
    </div>
    <button class="sub-btn" style="background:#666;" onclick="switchModal('volumeMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
  </div>
</div>

<div id="languageMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">è¨€èªè¨­å®š / Language</h3>
    <div class="modal-grid">
      <button class="sub-btn">æ—¥æœ¬èª</button>
      <button class="sub-btn" style="background:#555;">ã‚¹ãƒ¯ãƒ’ãƒªèªï¼ˆæº–å‚™ä¸­ï¼‰</button>
    </div>
    <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="switchModal('languageMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
  </div>
</div>

 
<div id="authModal" class="overlay">
    <div class="modal-box">
      
      <h2 id="authTitle" style="margin-top: 0; color: #8b4513; flex-shrink: 0;">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
      
      <div class="modal-body">
        
        <div id="authInputs">
          <div style="text-align: left; margin: 15px 0;">
            <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><br>
            <input type="email" id="authEmail" placeholder="example@mail.com" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
          </div>
          <div style="text-align: left; margin: 15px 0;">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label><br>
            <input type="password" id="authPass" placeholder="******" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
          </div>

          <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
            <button onclick="loginUser()" style="background: #007bff; color: white; width: 45%; height: 45px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="registerUser()" style="background: #28a745; color: white; width: 45%; height: 45px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">æ–°è¦ç™»éŒ²</button>
          </div>
        </div>

        <div style="margin-top:20px; padding-top:10px;">
    <button id="logoutBtnInModal" onclick="logoutUser(); closeAuthModal()" style="display:none; background: #6c757d; border:none; border-radius:5px; color: white; width: 100%; height: 40px; font-weight:bold;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

      </div> <div style="margin-top: 0; border-top: 1px solid #ccc; padding-top: 15px; flex-shrink: 0;">
        <button onclick="closeAuthModal()" style="background: #ccc; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; font-weight:bold;">ã‚‚ã©ã‚‹</button>
      </div>

    </div>
  </div>

  <div id="nameEditModal" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">åå‰ã‚’å¤‰æ›´</h3>
      <div style="margin: 20px 0;">
        <input type="text" maxlength="8" id="newNameInput" style="width: 80%; padding: 10px; font-size: 16px; border: 2px solid #8b4513; border-radius: 5px; text-align: center;">
      </div>
      <div style="display: flex; justify-content: space-around; gap: 10px;">
        <button onclick="saveNewName()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">æ±ºå®š</button>
        <button onclick="closeNameEditModal()" style="background: #ccc; color: black; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="statsModal" class="overlay">
    <div class="modal-box" style="max-height: 80vh; display: flex; flex-direction: column;">
      <h2 style="margin-top: 0; color: #8b4513;">ã‚ãªãŸã®æˆ¦ç¸¾</h2>
      <div style="display: flex; justify-content: space-around; font-size: 24px; margin-bottom: 15px;">
        <div style="color: red;">å‹: <span id="statsWin">0</span></div>
        <div style="color: blue;">æ•—: <span id="statsLose">0</span></div>
      </div>
      <div style="text-align: left; background: white; border: 1px solid #ccc; flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px;">
        <ul id="statsHistory" style="list-style: none; padding: 0; margin: 0;"></ul>
      </div>
      <button onclick="closeStatsModal()" style="background: #ccc; border: none; color: black; padding: 10px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="lobbyChatModal" class="overlay">
    <div class="modal-box">
      <button class="close-small-btn" onclick="closeModal('lobbyChatModal')">é–‰ã˜ã‚‹</button>
      
      <h3 id="lobbyChatTitle">ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</h3>
      
      <div id="lobbyChatHistory"></div>
      
      <div class="chat-input-area">
        <input type="text" id="lobbyChatInput" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; font-size: 16px;">
        <button onclick="sendLobbyMessage()" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; font-weight:bold;">é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="practiceMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ç·´ç¿’ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
      <div class="modal-grid"> <button class="sub-btn" onclick="startGame('saijaku')">ãŸã‚ã‚€ã‚Œ (æœ€å¼±)</button>
        <button class="sub-btn" onclick="startGame('easy')">ãŠã‚ãã³ (å…¥é–€)</button>
        <button class="sub-btn" onclick="startGame('normal')">ãŸã—ãªã¿ (æ™®é€š)</button>
      </div> <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('practiceMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div id="onePlayerModeSelect" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">å¯¾å±€ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
      <div class="modal-grid"> <button class="sub-btn" onclick="startGame('hard1')">ã“ã¿ã‚„</button>
        <button class="sub-btn" onclick="startGame('hard2')">ã—ãŠã‚„</button>
        <button class="sub-btn" onclick="startGame('ex_hard1')">ã“ã¿ã‚„EX</button>
        <button class="sub-btn" onclick="startGame('ex_hard2')">ã—ãŠã‚„EX</button>
      </div> <button class="sub-btn" style="background:#d35400; margin-top: 5px;" onclick="startGame('ex_hard3')">æœ€å¼·AIï¼ˆPCé™å®šï¼‰</button>
      <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('onePlayerModeSelect')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="helpMainMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #17a2b8; margin-top: 0;">ãƒ˜ãƒ«ãƒ—</h3>
      <div class="modal-grid">
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpMode')">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</button>
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpDifficulty')">é›£æ˜“åº¦ã«ã¤ã„ã¦</button>
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpChar')">ã‚­ãƒ£ãƒ©ã«ã¤ã„ã¦</button>
        <button class="sub-btn" style="background: #6f42c1;" onclick="switchModal('helpMainMenu', 'helpContact')">ä¸å…·åˆãƒ»è¦æœ›</button>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('helpMainMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="helpMode" class="overlay">
    <div class="modal-box" style="max-width: 350px;">
      <h3 style="color: #8b4513;">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</h3>
      <div style="text-align: left; font-size: 0.85rem; line-height: 1.5; overflow-y: auto; max-height: 50vh;">
        <p><strong>ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆã‚Œã‚“ã—ã‚…ã†ï¼ã²ã¨ã‚Šã§ï¼ãµãŸã‚Šã§ï¼‰</strong><br>CPUã¨ã®å¯¾å±€ãŒã§ãã¾ã™ã€‚ã“ã®ç«¯æœ«ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒå£«ã§ã‚‚å¯¾å±€ãŒã§ãã¾ã™ã€‚</p>
        <p><strong>ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</strong><br>é ãã«ã„ã‚‹äººã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ãŒã§ãã¾ã™ã€‚å…ˆã«å…¥å®¤ã—ãŸäººãŒå…ˆæ‰‹ã«ãªã‚Šã¾ã™ã€‚</p>
        <p><strong>ãƒ»ãƒãƒ£ãƒƒãƒˆ</strong><br>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ­ãƒ“ãƒ¼ã«ã„ã‚‹äººãŸã¡ã¨ä¼šè©±ãŒã§ãã¾ã™ã€‚</p> <p><strong>ãƒ»è§£æ</strong><br>æ£‹è­œã‚’è²¼ã‚Šä»˜ã‘ã¦ã€è§£æã‚„æŒ¯ã‚Šè¿”ã‚ŠãŒã§ãã¾ã™ã€‚</p>
        <p><strong>ãƒ»æ£‹è­œ</strong><br>è‡ªèº«ã®éå»ã®æ£‹è­œãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚è§£æã‚„æŒ¯ã‚Šè¿”ã‚Šã‚‚ã§ãã¾ã™ã€‚â€»ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚â€»PCé™å®šã®æ©Ÿèƒ½ã§ã™ã€‚</p>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('helpMode', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="helpDifficulty" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin: 0 0 10px 0;">é›£æ˜“åº¦ã«ã¤ã„ã¦</h3>
      
      <div style="text-align: left; font-size: 0.85rem; line-height: 1.4;">
        <p style="margin: 0 0 5px 0;">CPUã®é›£æ˜“åº¦ã¯ã€ä¸‹ã«è¡Œãã»ã©å¼·ã„ã§ã™ã€‚</p>
        <ul style="padding-left: 20px; margin: 0 0 10px 0;">
          <li>ãŸã‚ã‚€ã‚Œ</li>
          <li>ãŠã‚ãã³</li>
          <li>ãŸã—ãªã¿</li>
          <li>ã—ãŠã‚„ / ã“ã¿ã‚„</li>
          <li>ã—ãŠã‚„EX / ã“ã¿ã‚„EX</li>
          <li style="font-weight: bold; color: #d35400;">è©¦é¨“å®Ÿè£…ï¼ˆæœ€å¼·ï¼‰</li>
        </ul>
        <p style="margin: 0; font-size: 0.75rem;">â€»ã—ãŠã‚„ç³»ã¨ã“ã¿ã‚„ç³»ã®å¼·ã•ã¯åŒã˜ã§ã™ãŒã€æ€§æ ¼ãŒç•°ãªã‚Šã¾ã™ã€‚</p>
      </div>
      
      <button class="sub-btn" style="background:#666; margin: 15px 0 0 0;" onclick="switchModal('helpDifficulty', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="helpChar" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¤ã„ã¦</h3>
      <div style="text-align: left; font-size: 0.9rem; line-height: 1.6;">
        <p>ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å¯¾å±€å‰ã«è‡ªèº«ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚</p>
        <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ãã‚Œãã‚Œç‹¬è‡ªã®<strong>ã€Œå¿…æ®ºæŠ€ã€</strong>ã‚’æŒã£ã¦ãŠã‚Šã€å¯¾å±€ã‚’æœ‰åˆ©ã«é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('helpChar', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="helpContact" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513;">ä¸å…·åˆãƒ»ã”è¦æœ›</h3>
    <div style="margin: 20px 0; line-height: 1.6;">
      <p>ã“ã¡ã‚‰ã‹ã‚‰ã„ã¤ã§ã‚‚å—ã‘ä»˜ã‘ã¦ãŠã‚Šã¾ã™ã€‚<br>ã¾ãŸã¯ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
      <button class="sub-btn" style="background: #28a745; margin-top: 10px;" 
        onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSc5Ry7hikuBYzDp7lTVLtO74zWabVlvvsjc3a0HgqrIuT8Dww/viewform', '_blank')">
        å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã â†—
      </button>
    </div>
    <button class="sub-btn" style="background:#666;" onclick="closeModal('helpContact')">é–‰ã˜ã‚‹</button>
  </div>
</div>

  <div id="offlineMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å±€</h3>
      <div class="modal-grid"> <button class="sub-btn" onclick="goToCharacterSelect('practice')">ã‚Œã‚“ã—ã‚…ã†</button>
        <button class="sub-btn" onclick="goToCharacterSelect('cpu')">ã²ã¨ã‚Šã§</button>
        <button class="sub-btn" onclick="goToCharacterSelect('pvp')">ãµãŸã‚Šã§</button>
      </div> <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('offlineMenu')">æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="systemAlertModal" class="overlay" style="z-index: 200;">
    <div class="modal-box" style="max-width: 400px;">
      <h3 style="color: #8b4513; margin-top: 0;">ãŠçŸ¥ã‚‰ã›</h3>
      <p id="sysAlertMsg" style="margin: 20px 0; line-height: 1.5; white-space: pre-wrap;"></p>
      <button id="sysAlertBtn" style="background: #28a745; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">OK</button>
    </div>
  </div>

  <div id="systemConfirmModal" class="overlay" style="z-index: 200;">
    <div class="modal-box" style="max-width: 400px;">
      <h3 style="color: #8b4513; margin-top: 0;">ç¢ºèª</h3>
      <p id="sysConfirmMsg" style="margin: 20px 0; line-height: 1.5; white-space: pre-wrap;"></p>
      <div style="display: flex; justify-content: center; gap: 20px;">
        <button id="sysConfirmYesBtn" style="background: #007bff; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">ã¯ã„</button>
        <button id="sysConfirmNoBtn" style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <div id="characterSettingsMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h3>
    <p style="font-size:0.9rem;">ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’é¸ã¹ã¾ã™</p>
    
    <div class="modal-grid">
      <button class="sub-btn" onclick="changeCharacter('komiya')">ã‚­ãƒ£ãƒ©A</button>
      <button class="sub-btn" onclick="changeCharacter('a')">ã‚­ãƒ£ãƒ©B</button>
      <button class="sub-btn" onclick="changeCharacter('b')">ã‚­ãƒ£ãƒ©C</button>
      <button class="sub-btn" onclick="changeCharacter('d')">ã‚­ãƒ£ãƒ©D</button>
    </div>
    
    <button class="sub-btn" style="background:#666;" onclick="closeModal('characterSettingsMenu')">é–‰ã˜ã‚‹</button>
  </div>
</div>

  <div id="mailboxModal" class="overlay">
   <div class="modal-box">
      
      <div id="mailListView" style="display: flex; flex-direction: column; height: 100%;">
        <h3 style="color: #8b4513; margin-top: 0;">å—ä¿¡ãƒˆãƒ¬ã‚¤</h3>
        <div class="modal-body" style="background: #eee; border-radius: 5px; padding: 0;">
          <ul id="mailList">
            <li style="padding:20px; color:#666;">èª­ã¿è¾¼ã¿ä¸­...</li>
          </ul>
          <div id="noMailMsg" style="display:none; padding:20px; color:#666;">ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
        <button class="sub-btn" style="background:#666; margin-top:10px;" onclick="closeModal('mailboxModal')">é–‰ã˜ã‚‹</button>
      </div>

      <div id="mailDetailView">
        <div class="mail-header">
          <div class="mail-detail-subject" id="detailSubject">ä»¶å</div>
          <div class="mail-detail-date" id="detailDate">æ—¥ä»˜</div>
        </div>
        <div class="mail-body" id="detailBody">
          æœ¬æ–‡
        </div>
        
        <div id="rewardArea" class="mail-reward-area">
          <div style="font-weight:bold; margin-bottom:5px;">ğŸ æ·»ä»˜ã‚¢ã‚¤ãƒ†ãƒ </div>
          <div id="rewardContent" style="color:#d35400; font-size:1.1rem; margin-bottom:10px;">1000 G</div>
          <button id="claimRewardBtn" class="sub-btn" style="background: #28a745;">å—ã‘å–ã‚‹</button>
        </div>

        <button class="sub-btn" style="background:#666; margin-top:10px;" onclick="backToMailList()">æˆ»ã‚‹</button>
      </div>

    </div>
  </div>
  
  <script src="script/missions.js"></script>
  <script src="script/serifu/komiya.js"></script>
<script src="script/serifu/a.js"></script>
<script src="script/serifu/b.js"></script>
<script src="script/serifu/d.js"></script>
  <script src="script/auth.js"></script>
  <script>
    // --- â˜…â˜…â˜… ä¿®æ­£ç‚¹ï¼šSocket.ioåˆæœŸåŒ– â˜…â˜…â˜… ---
    let socket = null;

    try {
        socket = io();
    } catch(e) {
        console.log("ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ");
    }

    // --- ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ---
    function showSystemAlert(msg, callback) {
        document.getElementById("sysAlertMsg").textContent = msg;
        const modal = document.getElementById("systemAlertModal");
        modal.style.display = "flex";
        const btn = document.getElementById("sysAlertBtn");
        btn.onclick = function() {
            modal.style.display = "none";
            if (callback) callback();
        };
    }

    function showSystemConfirm(msg, yesCallback, noCallback) {
        document.getElementById("sysConfirmMsg").textContent = msg;
        const modal = document.getElementById("systemConfirmModal");
        modal.style.display = "flex";
        document.getElementById("sysConfirmYesBtn").onclick = function() {
            modal.style.display = "none";
            if (yesCallback) yesCallback();
        };
        document.getElementById("sysConfirmNoBtn").onclick = function() {
            modal.style.display = "none";
            if (noCallback) noCallback();
        };
    }
    
    // --- å¾©å¸°æ©Ÿèƒ½ ---
    document.addEventListener("DOMContentLoaded", () => {
        const savedRoomId = localStorage.getItem('current_shogi_room');
        if (savedRoomId && socket) {
            if (socket.connected) {
                checkReconnection(savedRoomId);
            } else {
                socket.on('connect', () => {
                   checkReconnection(savedRoomId);
                });
            }
        }
        
        // â˜…â˜…â˜… è¿½åŠ ï¼šä¿å­˜ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ç”»åƒã‚’æ›´æ–°ã™ã‚‹å‡¦ç† â˜…â˜…â˜…
        const savedCharId = localStorage.getItem('selected_character_id');
        if (savedCharId && window.CHARACTERS && window.CHARACTERS[savedCharId]) {
            currentCharacterId = savedCharId; // IDã‚’æ›´æ–°
            const imgEl = document.querySelector('.character-stand');
            if (imgEl) {
                imgEl.src = window.CHARACTERS[savedCharId].image;
            }
        }
    });

    function checkReconnection(roomId) {
        socket.emit('check reconnection', roomId, (response) => {
            if (response.canReconnect) {
                showSystemConfirm(
                    "ä¸­æ–­ã•ã‚ŒãŸå¯¾å±€ãŒã‚ã‚Šã¾ã™ã€‚\nå¾©å¸°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã„ã„ãˆã€ã‚’é¸ã¶ã¨å¯¾å±€ã‚’ç ´æ£„ã—ã¾ã™ï¼‰",
                    () => { window.location.href = `player_vs_player_online.html?room=${roomId}`; },
                    () => { localStorage.removeItem('current_shogi_room'); }
                );
            } else {
                localStorage.removeItem('current_shogi_room');
            }
        });
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function switchModal(closeId, openId) { closeModal(closeId); openModal(openId); }

    function openAccountFromSettings() {
      closeModal('settingsMainMenu');
      showAuthModal(); 
    }

    // --- ç”»é¢é·ç§» ---
    function goToCharacterSelect(mode) { 
        if (mode === 'online') {
            const user = firebase.auth().currentUser;
            if (!user) {
                showSystemAlert("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚", () => {
                    showAuthModal(); 
                });
                return;
            }
        }
        window.location.replace("character.html?mode=" + mode);
    }

    function startGame(difficulty) {
      if (difficulty === 'ex_hard3') {
          window.location.replace("cpu_yaneuraou.html");
      } else {
          window.location.replace("game_cpu.html?opponent=" + difficulty);
      }
    }

    // --- â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ â˜…â˜…â˜… ---
    // ç¾åœ¨é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©IDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ komiyaï¼‰
    let currentCharacterId = localStorage.getItem('selected_character_id') || 'komiya';

    function changeCharacter(charId) {
        // å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸ CHARACTERS ãŒã‚ã‚‹ã‹ç¢ºèª
        if (!window.CHARACTERS || !window.CHARACTERS[charId]) {
            console.error("æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", charId);
            return;
        }

        // 1. IDã‚’æ›´æ–°ãƒ»ä¿å­˜
        currentCharacterId = charId;
        localStorage.setItem('selected_character_id', charId);

        // 2. ç”»åƒã‚’æ›´æ–°
        const imgEl = document.querySelector('.character-stand');
        if (imgEl) {
            imgEl.src = window.CHARACTERS[charId].image;
        }

        // 3. è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        switchModal('characterSettingsMenu', 'settingsMainMenu');

        // 4. åˆ‡ã‚Šæ›¿ãˆç›´å¾Œã«æŒ¨æ‹¶ã•ã›ã‚‹ï¼ˆãŠå¥½ã¿ã§ï¼‰
        setTimeout(talkCharacter, 500);
    }

    // --- â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å–‹ã‚Šæ©Ÿèƒ½ï¼ˆ{name}ç½®æ›å¯¾å¿œç‰ˆï¼‰ â˜…â˜…â˜… ---
    let bubbleTimer = null;
    
    function talkCharacter() {
        // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!window.CHARACTERS || !window.CHARACTERS[currentCharacterId]) return;

        const bubble = document.getElementById("characterBubble");
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
        const userName = document.getElementById("userNameDisplay").textContent || "ã‚²ã‚¹ãƒˆ";
        
        const now = new Date();
        const hour = now.getHours();

        // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const charData = window.CHARACTERS[currentCharacterId];

        // æ™‚é–“å¸¯åˆ¥ã®ã‚»ãƒªãƒ•ãƒªã‚¹ãƒˆã‚’å–å¾—
        let timeMessages = [];
        if (hour >= 5 && hour < 11) {
            timeMessages = charData.time.morning || [];
        } else if (hour >= 11 && hour < 17) {
            timeMessages = charData.time.noon || [];
        } else if (hour >= 17 && hour < 22) {
            timeMessages = charData.time.evening || [];
        } else {
            timeMessages = charData.time.night || [];
        }

        // åŸºæœ¬ã‚»ãƒªãƒ•ã¨çµåˆ
        const allMessages = (charData.base || []).concat(timeMessages);
        
        // ã‚»ãƒªãƒ•ãŒ1ã¤ã‚‚ãªã„å ´åˆã¯çµ‚äº†
        if (allMessages.length === 0) return;

        // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
        let rawMsg = allMessages[Math.floor(Math.random() * allMessages.length)];
        
        // â˜… {name} ã‚’ å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ç½®ãæ›ãˆã‚‹å‡¦ç†
        let finalMsg = rawMsg.split('{name}').join(userName);
        
        // è¡¨ç¤º
        bubble.textContent = finalMsg;
        bubble.style.display = "block";

        clearTimeout(bubbleTimer);
        bubbleTimer = setTimeout(() => {
            bubble.style.display = "none";
        }, 3000); // å°‘ã—é•·ã‚ã«è¡¨ç¤º(3ç§’)
    }

    // --- ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
    function openLobbyChat() {
        openModal('lobbyChatModal');
    }

    // ã€ä¿®æ­£ç‰ˆã€‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
// ã€ä¿®æ­£ç‰ˆã€‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•° (Firestoreç‰ˆ)
function sendLobbyMessage() {
    const input = document.getElementById("lobbyChatInput");
    const text = input.value.trim();
    if (!text) return;

    const user = firebase.auth().currentUser;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—
    let myName = "ã‚²ã‚¹ãƒˆ";
    let myId = "guest"; // ã‚²ã‚¹ãƒˆã‚‚è­˜åˆ¥ã—ãŸã„å ´åˆã¯æŒ‡ç´‹IDãªã©ãŒå¿…è¦ã§ã™ãŒä¸€æ—¦ç°¡æ˜“åŒ–
    let iconUrl = "script/image/test.icon.PNG"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³

    if (user) {
        myId = user.uid;
        myName = document.getElementById("userNameDisplay").textContent || "åç„¡ã—";
        // â˜…å°†æ¥çš„ã«userãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã“ã“ã§è¨­å®š
    }

    // â˜…Socket.ioã§ã¯ãªãã€Firestoreã«ä¿å­˜ã™ã‚‹
    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å: "lobby_chat" (è‡ªç”±ã«ã¤ã‘ã¦OK)
    db.collection("lobby_chat").add({
        text: text,
        name: myName,
        userId: myId,
        icon: iconUrl,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), // ã‚µãƒ¼ãƒãƒ¼æ™‚é–“
        role: 'lobby'
    })
    .then(() => {
        console.log("é€ä¿¡æˆåŠŸ");
        input.value = ""; // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
    })
    .catch((error) => {
        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼: ", error);
        alert("é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸ");
    });
}
    

// --- â˜…â˜…â˜… æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ (Firestoreç‰ˆ) â˜…â˜…â˜… ---

let chatUnsubscribe = null; // ç›£è¦–è§£é™¤ç”¨ã®å¤‰æ•°

// ãƒãƒ£ãƒƒãƒˆã®åˆæœŸåŒ–ãƒ»ç›£è¦–é–‹å§‹
function initLobbyChat() {
    const historyDiv = document.getElementById("lobbyChatHistory");
    if (!historyDiv) return;

    // äºŒé‡ç›£è¦–ã‚’é˜²ããŸã‚ã€æ—¢ã«ç›£è¦–ä¸­ãªã‚‰è§£é™¤
    if (chatUnsubscribe) {
        chatUnsubscribe();
    }

    console.log("ãƒãƒ£ãƒƒãƒˆæ¥ç¶šé–‹å§‹...");

    // Firestoreã® "lobby_chat" ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–
    chatUnsubscribe = db.collection("lobby_chat")
        .orderBy("createdAt", "desc") // æ–°ã—ã„é †ã«å–å¾—
        .limit(50)                    // æœ€æ–°50ä»¶
        .onSnapshot((snapshot) => {
            const historyDiv = document.getElementById("lobbyChatHistory");
            // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãŒã‚ã‚‹ãŸã³ã«ã“ã“ãŒå‹•ã
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«ã¾ã¨ã‚ã‚‹
            let messages = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                data.id = doc.id;
                messages.push(data);
            });

            // æ–°ã—ã„é †(desc)ã§å–å¾—ã—ãŸã®ã§ã€è¡¨ç¤ºã®ãŸã‚ã«å¤ã„é †ã«ç›´ã™
            messages.reverse();

            // ç”»é¢ã‚’ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦å†æç”»
            historyDiv.innerHTML = "";
            messages.forEach(msg => {
                addMessageToLobbyChatFirestore(msg);
            });

            // ä¸€ç•ªä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            historyDiv.scrollTop = historyDiv.scrollHeight;
        });
}

// 1ä»¶åˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function addMessageToLobbyChatFirestore(data) {
    const historyDiv = document.getElementById("lobbyChatHistory");
    const user = firebase.auth().currentUser;
    
    // è‡ªåˆ†ã®IDã‹ã©ã†ã‹ã®åˆ¤å®š
    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ null ã¨æ¯”è¼ƒ
    const currentMyId = user ? user.uid : null;
    
    // ãƒ‡ãƒ¼ã‚¿ã«userIdãŒãªã„å ´åˆï¼ˆå¤ã„ãƒ­ã‚°ãªã©ï¼‰ã¸ã®å¯¾ç­–
    const msgUserId = data.userId || "unknown";

    const isMe = (msgUserId === currentMyId);

    // --- ã“ã“ã‹ã‚‰ã¯ãƒ‡ã‚¶ã‚¤ãƒ³ç”Ÿæˆï¼ˆä»¥å‰ã¨åŒã˜ï¼‰ ---
    const rowDiv = document.createElement("div");
    rowDiv.className = "chat-row";
    if (isMe) rowDiv.classList.add("mine");

    const iconCol = document.createElement("div");
    iconCol.className = "icon-container";

    const nameDiv = document.createElement("div");
    nameDiv.className = "chat-name-badge";
    
    // åå‰ãŒé•·ã™ããŸå ´åˆã«å‚™ãˆã¦ã€SVGã§æç”»ã™ã‚‹
    // preserveAspectRatio="xMidYMid meet" ãŒã€Œç¸¦æ¨ªæ¯”ã‚’ä¿ã£ã¦å…¨ä½“ã‚’åã‚ã‚‹ã€è¨­å®šã§ã™
    const safeName = data.name || "åç„¡ã—";
    
    // æ–‡å­—æ•°ã«å¿œã˜ã¦viewBoxã®å¹…ã‚’è¨ˆç®—ã™ã‚‹ï¼ˆç°¡æ˜“çš„ãªè‡ªå‹•èª¿æ•´ï¼‰
    // å…¨è§’æ–‡å­—ãªã‚‰å¹…12pxãã‚‰ã„ã¨ä»®å®šã—ã¦è¨ˆç®—
    // æœ€ä½ã§ã‚‚80pxï¼ˆCSSã®widthã¨åŒã˜ï¼‰ã¯ç¢ºä¿ã™ã‚‹
    const textWidth = Math.max(80, safeName.length * 12); 
    
    nameDiv.innerHTML = `
        <svg viewBox="0 0 ${textWidth} 20" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
            <text x="50%" y="50%" class="chat-name-text">${safeName}</text>
        </svg>
    `;

    const iconImg = document.createElement("img");
    iconImg.src = data.icon || "script/image/test.icon.PNG";
    iconImg.className = "chat-icon-img";
    // ç”»åƒã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚°ãƒ¬ãƒ¼ã«
    iconImg.onerror = function() { this.style.backgroundColor = "#ccc"; };

    iconCol.appendChild(nameDiv);
    iconCol.appendChild(iconImg);

    const bubbleDiv = document.createElement("div");
    bubbleDiv.className = "chat-bubble";
    bubbleDiv.textContent = data.text;

    // æ—¥ä»˜ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’è¿½åŠ 
    /*
    if (data.createdAt) {
        const d = data.createdAt.toDate();
        const timeStr = `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        const timeSpan = document.createElement("div");
        timeSpan.style.fontSize = "0.6rem";
        timeSpan.style.textAlign = "right";
        timeSpan.style.opacity = "0.6";
        timeSpan.textContent = timeStr;
        bubbleDiv.appendChild(timeSpan);
    }
    */

    rowDiv.appendChild(iconCol);
    rowDiv.appendChild(bubbleDiv);
    historyDiv.appendChild(rowDiv);
}
    
    document.addEventListener("DOMContentLoaded", () => {
        const lobbyInput = document.getElementById("lobbyChatInput");
        if (lobbyInput) {
            lobbyInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendLobbyMessage();
            });
        }
    });

    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const openMenuId = urlParams.get('open');
      if (openMenuId) {
        const menuEl = document.getElementById(openMenuId);
        if (menuEl) {
          menuEl.style.display = 'flex';
          if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.pathname);
          }
        }
      }
    };

    firebase.auth().onAuthStateChanged((user) => {
        // â˜…ä¿®æ­£ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒ»æœªãƒ­ã‚°ã‚¤ãƒ³ã«é–¢ã‚ã‚‰ãšã€ãƒãƒ£ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿é–‹å§‹ã™ã‚‹
        setTimeout(() => {
            initLobbyChat();
        }, 500);

        if (user) {
            // ã“ã“ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ã€ã«å¿…è¦ãªå‡¦ç†ï¼ˆæ‰€æŒé‡‘ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãªã©ï¼‰
            db.collection("users").doc(user.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    // 1. æ‰€æŒé‡‘
                    const currentGold = data.gold || 0;
                    const goldEl = document.getElementById("userGoldDisplay");
                    if (goldEl) {
                        goldEl.textContent = currentGold.toLocaleString();
                    }

                    // 2. ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹
                    const mailbox = data.mailbox || [];
                    updateMailBadge(mailbox);
                    if (document.getElementById("mailboxModal").style.display === "flex") {
                         renderMailList(mailbox);
                    }
                    window.currentUserMailbox = mailbox;

                    // 3. ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒãƒƒã‚¸
                    const missions = data.missions || {};
                    let claimableCount = 0;
                    if (typeof GAME_MISSIONS !== 'undefined') {
                        GAME_MISSIONS.forEach(m => {
                            const uData = missions[m.id];
                            if (uData && uData.progress >= m.target && !uData.collected) {
                                claimableCount++;
                            }
                        });
                    }
                    const mBadge = document.getElementById("missionBadge");
                    if (mBadge) {
                        if (claimableCount > 0) {
                            mBadge.style.display = "flex";
                            mBadge.textContent = claimableCount;
                        } else {
                            mBadge.style.display = "none";
                        }
                    }
                }
            });
        } else {
            const goldEl = document.getElementById("userGoldDisplay");
            if (goldEl) goldEl.textContent = "0";
        }
    });

    // --- ç”»é¢å›è»¢ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ ---
    function autoRotateTitle() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const isPortrait = h > w;
        if (isPortrait) {
            document.body.style.width = h + "px";
            document.body.style.height = w + "px";
            document.body.style.transform = "translate(-50%, -50%) rotate(90deg)";
            document.body.style.position = "fixed";
            document.body.style.top = "50%";
            document.body.style.left = "50%";
        } else {
            document.body.style.width = "100%";
            document.body.style.height = "100%";
            document.body.style.transform = "";
            document.body.style.top = "0";
            document.body.style.left = "0";
        }
    }

    window.addEventListener('load', () => {
        autoRotateTitle();
        window.addEventListener('resize', autoRotateTitle);
        window.addEventListener('contextmenu', (e) => e.preventDefault());

        history.pushState(null, null, location.href);
        window.addEventListener('popstate', (e) => {
            history.pushState(null, null, location.href);
        });

        let startX = 0;
        let startY = 0;

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) return;
            startX = e.touches[0].pageX;
            startY = e.touches[0].pageY;
            if (startX < 30 || startX > window.innerWidth - 30) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) return;
            const x = e.touches[0].pageX;
            const y = e.touches[0].pageY;
            const deltaX = Math.abs(x - startX);
            const deltaY = Math.abs(y - startY);
            const isScrollable = e.target.closest('#lobbyChatHistory, .modal-box, #statsHistory, .help-content');

            if (isScrollable) {
                e.stopPropagation(); 
            } else {
                e.preventDefault();
            }
            if (deltaX > deltaY && deltaX > 10) {
                e.preventDefault();
            }
        }, { passive: false });
    });

    // --- ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ ---

  // ãƒãƒƒã‚¸ï¼ˆèµ¤ä¸¸ï¼‰ã®æ›´æ–°
  // --- â˜…â˜…â˜… ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ï¼ˆä»•æ§˜å¤‰æ›´ç‰ˆï¼‰ â˜…â˜…â˜… ---

    // ãƒãƒƒã‚¸æ›´æ–°
    function updateMailBadge(mailbox) {
        // æœªèª­ã€ã‹ã¤ã€Œå ±é…¬ãŒã‚ã‚‹ã®ã«ã¾ã å—ã‘å–ã£ã¦ã„ãªã„ã€ãƒ¡ãƒ¼ãƒ«ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        // (å˜ã«æœªèª­ç®¡ç†ã—ãŸã„å ´åˆã¯æ—¢èª­ãƒ•ãƒ©ã‚°ãŒå¿…è¦ã§ã™ãŒã€ä»Šå›ã¯ã€Œæœªå—å–ã€ã‚’é€šçŸ¥ã—ã¾ã™)
        let unreadCount = 0;
        mailbox.forEach(m => {
            // å ±é…¬ãŒã‚ã‚‹ ã‹ã¤ ã¾ã å—ã‘å–ã£ã¦ã„ãªã„(claimedãƒ•ãƒ©ã‚°ãŒãªã„/false)
            if (m.reward && !m.claimed) {
                unreadCount++;
            }
            // â€»ã‚‚ã—ã€Œå ±é…¬ãªã—ã€ã®ãƒ¡ãƒ¼ãƒ«ã‚‚å«ã‚ã¦å˜ã«ã€Œæœªèª­ã€ã‚’ç®¡ç†ã—ãŸã„å ´åˆã¯
            // åˆ¥é€” read: false ãªã©ã®ãƒ•ãƒ©ã‚°ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        });
        
        const badge = document.getElementById("mailBadge");
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = "flex";
        } else {
            badge.style.display = "none";
        }
    }

    // ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’é–‹ã
    function openMailbox() {
        openModal('mailboxModal');
        backToMailList(); 
        if (window.currentUserMailbox) {
            renderMailList(window.currentUserMailbox);
        }
    }

    // ãƒªã‚¹ãƒˆæç”»ï¼ˆè‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ï¼‰
    function renderMailList(mailbox) {
        const listEl = document.getElementById("mailList");
        const noMsg = document.getElementById("noMailMsg");
        listEl.innerHTML = "";

        // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedMail = [...mailbox].reverse();

        if (sortedMail.length === 0) {
            noMsg.style.display = "block";
        } else {
            noMsg.style.display = "none";
            sortedMail.forEach((mail) => {
                const li = document.createElement("li");
                
                // â˜…â˜…â˜… è‰²åˆ†ã‘ã®ã‚¯ãƒ©ã‚¹é©ç”¨ â˜…â˜…â˜…
                let itemClass = "mail-item";
                
                if (mail.reward) {
                    if (mail.claimed) {
                        // æ·»ä»˜ã‚ã‚Šãƒ»å—å–æ¸ˆ â†’ è–„ã„ç°è‰²
                        itemClass += " type-reward-claimed";
                    } else {
                        // æ·»ä»˜ã‚ã‚Šãƒ»æœªå—å– â†’ è–„ã„é’
                        itemClass += " type-reward-active";
                    }
                } else {
                    // æ·»ä»˜ãªã— â†’ è–„ã„èµ¤
                    itemClass += " type-normal";
                }
                
                li.className = itemClass;
                
                // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                let dateStr = "---";
                if (mail.date && mail.date.toDate) {
                    const d = mail.date.toDate();
                    dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                } else if (mail.date) {
                    dateStr = "æ—¥ä»˜ä¸æ˜"; 
                }

                // ä»¶åã®è¡¨ç¤ºï¼ˆå—å–æ¸ˆãªã‚‰ã€Œ(æ¸ˆ)ã€ã‚’ã¤ã‘ã‚‹ãªã©ã—ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ï¼‰
                let subjectText = mail.subject;
                if (mail.reward && mail.claimed) {
                    subjectText = "ã€æ¸ˆã€‘ " + subjectText;
                }

                li.innerHTML = `
                    <div class="mail-subject">${subjectText}</div>
                    <div class="mail-date">${dateStr}</div>
                `;
                
                li.onclick = () => showMailDetail(mail);
                
                listEl.appendChild(li);
            });
        }
    }

    // è©³ç´°ç”»é¢ã‚’è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³åˆ¶å¾¡è¿½åŠ ï¼‰
    function showMailDetail(mail) {
        document.getElementById("mailListView").style.display = "none";
        document.getElementById("mailDetailView").style.display = "flex";

        document.getElementById("detailSubject").textContent = mail.subject;
        
        let dateStr = "";
        if (mail.date && mail.date.toDate) {
             dateStr = mail.date.toDate().toLocaleString();
        }
        document.getElementById("detailDate").textContent = dateStr;
        
        document.getElementById("detailBody").textContent = mail.body;

        const rewardArea = document.getElementById("rewardArea");
        const rewardBtn = document.getElementById("claimRewardBtn");
        
        if (mail.reward) {
            rewardArea.style.display = "block";
            document.getElementById("rewardContent").textContent = mail.reward.name || "å ±é…¬ã‚ã‚Š";
            
            // â˜…â˜…â˜… å—å–çŠ¶æ³ã«ã‚ˆã£ã¦ãƒœã‚¿ãƒ³ã‚’å¤‰ãˆã‚‹ â˜…â˜…â˜…
            if (mail.claimed) {
                // å—å–æ¸ˆã¿ã®å ´åˆ
                rewardBtn.textContent = "å—å–æ¸ˆã¿";
                rewardBtn.style.background = "#ccc";
                rewardBtn.disabled = true;
                rewardBtn.onclick = null;
            } else {
                // æœªå—å–ã®å ´åˆ
                rewardBtn.textContent = "å—ã‘å–ã‚‹";
                rewardBtn.style.background = "#28a745";
                rewardBtn.disabled = false;
                rewardBtn.onclick = () => claimMailReward(mail);
            }
        } else {
            rewardArea.style.display = "none";
        }
    }

    // ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
    function backToMailList() {
        document.getElementById("mailListView").style.display = "flex";
        document.getElementById("mailDetailView").style.display = "none";
    }

    // å ±é…¬å—ã‘å–ã‚Šå‡¦ç†ï¼ˆå‰Šé™¤ã›ãšãƒ•ãƒ©ã‚°æ›´æ–°ï¼‰
    async function claimMailReward(mail) {
        const user = firebase.auth().currentUser;
        if (!user) return;
        
        if (!confirm("å ±é…¬ã‚’å—ã‘å–ã‚Šã¾ã™ã‹ï¼Ÿ")) return;

        const userRef = db.collection("users").doc(user.uid);

        try {
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(userRef);
                if (!doc.exists) throw "User not found";

                const userData = doc.data();
                const currentMailbox = userData.mailbox || [];
                
                // å¯¾è±¡ã®ãƒ¡ãƒ¼ãƒ«ã‚’æ¢ã™
                const targetIndex = currentMailbox.findIndex(m => m.id === mail.id);
                if (targetIndex === -1) {
                      throw "ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                }
                
                // æ—¢ã«å—ã‘å–ã£ã¦ã„ãªã„ã‹å¿µã®ãŸã‚ãƒã‚§ãƒƒã‚¯
                if (currentMailbox[targetIndex].claimed) {
                    throw "ã“ã®å ±é…¬ã¯æ—¢ã«å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚";
                }

                const updates = {};

                // å ±é…¬ã®ä»˜ä¸
                if (mail.reward.type === "gold") {
                    updates.gold = (userData.gold || 0) + Number(mail.reward.value);
                } else if (mail.reward.type === "item") {
                    const currentInv = userData.inventory || [];
                    if (!currentInv.includes(mail.reward.value)) {
                        updates.inventory = firebase.firestore.FieldValue.arrayUnion(mail.reward.value);
                    }
                }

                // â˜…â˜…â˜… ãƒ¡ãƒ¼ãƒ«ã‚’å‰Šé™¤ã›ãšã€claimedãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦æ›´æ–°ã™ã‚‹ â˜…â˜…â˜…
                // é…åˆ—å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥æ›¸ãæ›ãˆã‚‹
                currentMailbox[targetIndex].claimed = true;
                
                // æ›´æ–°ã—ãŸé…åˆ—å…¨ä½“ã‚’ã‚»ãƒƒãƒˆ
                updates.mailbox = currentMailbox;

                transaction.update(userRef, updates);
            });

            alert(`å—ã‘å–ã‚Šã¾ã—ãŸï¼\n${mail.reward.name}`);
            
            // æˆåŠŸã—ãŸã‚‰ãƒªã‚¹ãƒˆã«æˆ»ã‚‹ï¼ˆè‡ªå‹•çš„ã«å†æç”»ã•ã‚Œã€ã‚°ãƒ¬ãƒ¼ã«ãªã‚Šã¾ã™ï¼‰
            backToMailList(); 

        } catch (e) {
            console.error(e);
            alert("å—ã‘å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ: " + e);
        }
    }
    
</script>

</body>
</html>

