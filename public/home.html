<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>ã—ãŠã‚„å°†æ£‹ - ãƒ›ãƒ¼ãƒ </title>
  <link rel="icon" href="script/image/komiya_icon.png"> 
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="script/image/komiya_icon.png">
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      position: fixed; 
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-image: url('script/image/shogi_title.PNG');
      background-color: #2c3e50;
      background-size: cover;
      background-position: center;
    }

    /* å¹ãå‡ºã—ã®è¨­å®š */
    .speech-bubble {
      display: none;
      position: absolute;
      bottom: 50vh;
      left: 50%;
      transform: translateX(-50%);
      background: #fff8dc;
      border: 3px solid #8b4513;
      border-radius: 20px;
      padding: 12px 20px;
      min-width: 160px;
      max-width: 220px;
      color: #333;
      font-weight: bold;
      font-size: 0.95rem;
      z-index: 100;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      pointer-events: none;
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .speech-bubble::after {
      content: '';
      position: absolute;
      bottom: 100%;
      right: 20%;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 15px solid #8b4513;
    }

    @keyframes pop-in {
      0% { transform: translateX(-50%) scale(0); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    .character-stand {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      height: 85vh;
      width: auto;
      max-width: 95%;
      z-index: 1;
      content: url('script/image/komiya_touka.png'); 
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
      cursor: pointer;
      pointer-events: auto;
    }

    .user-info-bar {
      position: absolute;
      top: 0;
      width: 100%;
      /* ä¸Šä¸‹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’10pxã‹ã‚‰5pxã¸å¤‰æ›´ã—ã¦ç´°ãã—ã¾ã—ãŸ */
      padding: 10px 20px; 
      background: rgba(0, 0, 0, 0.6);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
      z-index: 5;
    }

    .user-name { font-weight: bold; font-size: 1.1rem; }
    
    .top-btn {
      border: none;
      color: white;
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 5px;
      font-weight: bold;
    }
    .stats-btn { background: #ff9800; }
    .news-btn { background: #28a745; }

    .bottom-menu {
      position: absolute;
      bottom: 10px;
      width: 96%;
      left: 2%;
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      gap: 5px;
      z-index: 10;
    }

    .menu-btn {
      flex: 1;
      height: 60px;
      background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
      border: 2px solid white;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .menu-btn:active { transform: scale(0.95); }

    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
      overscroll-behavior: none;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-box {
      position: relative;
      background: #fff8dc;
      padding: 15px;
      border-radius: 10px;
      border: 4px solid #8b4513;
      text-align: center;
      width: 80%;
      max-width: 800px;
      max-height: 90vh; 
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    
    /* â˜…è¿½åŠ : ãƒœã‚¿ãƒ³ã‚’2åˆ—ã«ä¸¦ã¹ã‚‹ãŸã‚ã®ã‚°ãƒªãƒƒãƒ‰è¨­å®š */
    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr; /* æ¨ª2åˆ— */
      gap: 10px; /* ãƒœã‚¿ãƒ³åŒå£«ã®éš™é–“ */
      margin: 10px 0;
    }

    /* æ±ç”¨ã‚µãƒ–ãƒœã‚¿ãƒ³ã®å¾®èª¿æ•´ */
    .sub-btn {
      display: block;
      width: 100%;
      margin: 0; /* â˜…ã“ã“ã‚’0ã«ã™ã‚‹ï¼ˆéš™é–“ã¯grid-gapã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ï¼‰ */
      padding: 12px 5px;
      font-size: 1rem;
      background: #8b4513;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .sub-btn:active { transform: scale(0.98); opacity: 0.9; }

    /* ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .close-small-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      background: #666;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      cursor: pointer;
      z-index: 101;
    }

    #lobbyChatTitle {
      color: #005bea;
      margin: 0 0 5px 0;
      text-align: left;
      padding-left: 5px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    #lobbyChatHistory {
      flex: 1; 
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-height: 100px;
    }

    .chat-input-area {
      display: flex;
      gap: 5px;
      margin-top: 8px;
    }

    /* ãƒãƒ£ãƒƒãƒˆå¹ãå‡ºã—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³é–¢é€£ */
    .chat-row { display: flex; align-items: flex-start; gap: 10px; max-width: 95%; }
    .chat-row.mine { align-self: flex-end; flex-direction: row-reverse; }
    .icon-container { display: flex; flex-direction: column; align-items: center; width: 60px; }
    .chat-name-badge { background: #fff; border: 1px solid #8b4513; border-radius: 10px; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; z-index: 2; margin-bottom: -10px; white-space: nowrap; }
    .chat-icon-img { width: 50px; height: 50px; border: 3px solid #56ab2f; border-radius: 12px; background: #fff; object-fit: cover; }
    .chat-row.mine .chat-icon-img { border: 3px solid #FFA500; }
    .chat-bubble { position: relative; padding: 10px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; word-break: break-all; }
    .chat-row .chat-bubble { background: #fff; border: 2px solid #e0e0e0; border-top-left-radius: 0; }
    .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; border-top-right-radius: 0; }

    /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
    .offline-color { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%) !important; }
    .online-color { background: linear-gradient(to bottom, #ff758c 0%, #ff7eb3 100%) !important; }
    .mypage-color { background: linear-gradient(to bottom, #f6d365 0%, #fda085 100%) !important; }
    .ready-color { background: linear-gradient(to bottom, #a8e063 0%, #56ab2f 100%) !important; }
    .chat-color { background: linear-gradient(to bottom, #da92ec 0%, #a06ee1 100%) !important; }

    /* ãƒ¢ãƒã‚¤ãƒ«æ¨ªå‘ãèª¿æ•´ */
    @media screen and (max-height: 450px) {
      .modal-box { padding: 10px; }
      #lobbyChatHistory { padding: 8px; }
    }
  </style>
</head>
<body>

  <div class="user-info-bar">
    <div>
      <span id="userNameDisplay" class="user-name">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“
      <button id="editNameBtn" onclick="showNameEditModal()" style="display:none; background:none; border:none; cursor:pointer; font-size:1rem;">âœï¸</button>
    </div>

    <div>
      <button class="top-btn news-btn" onclick="openModal('newsModal')">ãŠçŸ¥ã‚‰ã›</button>
      <button class="top-btn stats-btn" onclick="showMyStats()">æˆ¦ç¸¾</button>
      <button class="top-btn" style="background: #17a2b8;" onclick="openModal('helpMainMenu')">ãƒ˜ãƒ«ãƒ—</button>
      <button class="top-btn" style="background: #6f42c1;" onclick="openModal('helpContact')">ä¸å…·åˆãƒ»ã”è¦æœ›</button>
      <button class="top-btn" style="background: #6c757d;" onclick="openModal('settingsMainMenu')">âš™ï¸</button>
    </div>
  </div>


  <div id="characterBubble" class="speech-bubble"></div>

  <img class="character-stand" src="script/image/char_a.png" alt="Character" onclick="talkCharacter()">

  <div class="bottom-menu">
    <button class="menu-btn offline-color" onclick="openModal('offlineMenu')">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</button>
    <button class="menu-btn online-color" onclick="goToCharacterSelect('online')">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</button>
    <button class="menu-btn chat-color" onclick="openLobbyChat()">ãƒãƒ£ãƒƒãƒˆ</button> <button class="menu-btn ready-color" onclick="window.location.href='kaiseki.html'">è§£æ</button>
    <button class="menu-btn mypage-color" onclick="window.location.href='mypage.html'">æ£‹è­œ</button>
  </div>

  <div id="newsModal" class="overlay">
    <div class="modal-box">
      <h3 style="color:#d35400; margin-top:0;">ğŸ”” æœ€æ–°æƒ…å ±</h3>
      <div style="text-align: left; margin: 20px 0; line-height: 1.6; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;">
        ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ å®Ÿè£…ï¼<br>
        ãƒ»ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ è¿½åŠ ï¼<br>
        ãƒ»æ£‹è­œè§£ææ©Ÿèƒ½ å®Ÿè£…ï¼<br>
        ãƒ»æœ€å¼·CPUã€Œè©¦é¨“å®Ÿè£…ã€è¿½åŠ 
      </div>
      <button onclick="closeModal('newsModal')" style="background: #ccc; border: none; color: black; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="settingsMainMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">è¨­å®š</h3>
      <div class="modal-grid">
        <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'volumeMenu')">éŸ³é‡è¨­å®š</button>
        <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'languageMenu')">è¨€èªè¨­å®š</button>
        <button class="sub-btn" onclick="openAccountFromSettings()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('settingsMainMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="volumeMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">éŸ³é‡è¨­å®š</h3>
      <div style="margin: 20px 0;">
        <p>BGM</p><input type="range" style="width:80%;">
        <p>åŠ¹æœéŸ³</p><input type="range" style="width:80%;">
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('volumeMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="languageMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">è¨€èªè¨­å®š / Language</h3>
      
      <div class="modal-grid">
        <button class="sub-btn">æ—¥æœ¬èª</button>
        <button class="sub-btn" style="background:#555;">ã‚¹ãƒ¯ãƒ’ãƒªèªï¼ˆæº–å‚™ä¸­ï¼‰</button>
      </div>
      
      <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="switchModal('languageMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="authModal" class="overlay">
    <div class="modal-box">
      <h2 id="authTitle" style="margin-top: 0; color: #8b4513;">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
      <div id="authInputs">
        <div style="text-align: left; margin: 15px 0;">
          <label>ãŠåå‰ï¼ˆæ–°è¦ç™»éŒ²æ™‚ã®ã¿ï¼‰</label><br>
          <input type="text" id="authName" placeholder="ãªã¾ãˆ" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="text-align: left; margin: 15px 0;">
          <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><br>
          <input type="email" id="authEmail" placeholder="example@mail.com" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="text-align: left; margin: 15px 0;">
          <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label><br>
          <input type="password" id="authPass" placeholder="******" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
          <button onclick="loginUser()" style="background: #007bff; color: white; width: 45%; height: 40px; border:none; border-radius:5px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button onclick="registerUser()" style="background: #28a745; color: white; width: 45%; height: 40px; border:none; border-radius:5px;">æ–°è¦ç™»éŒ²</button>
        </div>
      </div>
      <div style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">
         <button id="logoutBtnInModal" onclick="logoutUser(); closeAuthModal()" style="display:none; background: #6c757d; border:none; border-radius:5px; color: white; width: 100%; height: 40px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <button onclick="closeAuthModal()" style="margin-top: 15px; background: #ccc; border: none; padding: 5px 15px; border-radius: 5px;">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="nameEditModal" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">åå‰ã‚’å¤‰æ›´</h3>
      <div style="margin: 20px 0;">
        <input type="text" id="newNameInput" style="width: 80%; padding: 10px; font-size: 16px; border: 2px solid #8b4513; border-radius: 5px; text-align: center;">
      </div>
      <div style="display: flex; justify-content: space-around; gap: 10px;">
        <button onclick="saveNewName()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">æ±ºå®š</button>
        <button onclick="closeNameEditModal()" style="background: #ccc; color: black; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="statsModal" class="overlay">
    <div class="modal-box" style="max-height: 80vh; display: flex; flex-direction: column;">
      <h2 style="margin-top: 0; color: #8b4513;">ã‚ãªãŸã®æˆ¦ç¸¾</h2>
      <div style="display: flex; justify-content: space-around; font-size: 24px; margin-bottom: 15px;">
        <div style="color: red;">å‹: <span id="statsWin">0</span></div>
        <div style="color: blue;">æ•—: <span id="statsLose">0</span></div>
      </div>
      <div style="text-align: left; background: white; border: 1px solid #ccc; flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px;">
        <ul id="statsHistory" style="list-style: none; padding: 0; margin: 0;"></ul>
      </div>
      <button onclick="closeStatsModal()" style="background: #ccc; border: none; color: black; padding: 10px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<div id="lobbyChatModal" class="overlay">
  <div class="modal-box">
    <button class="close-small-btn" onclick="closeModal('lobbyChatModal')">é–‰ã˜ã‚‹</button>
    
    <h3 id="lobbyChatTitle">ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</h3>
    
    <div id="lobbyChatHistory"></div>
    
    <div class="chat-input-area">
      <input type="text" id="lobbyChatInput" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; font-size: 16px;">
      <button onclick="sendLobbyMessage()" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; font-weight:bold;">é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>
</div>

  <script src="script/auth.js"></script>
  <script>
    // --- Socket.io åˆæœŸåŒ– (ãƒãƒ£ãƒƒãƒˆç”¨) ---
    // â€»ã‚µãƒ¼ãƒãƒ¼ãŒç«‹ã£ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€é€šå¸¸å‹•ä½œã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“
    let socket = null;
    let globalChatHistory = []; // â˜…â˜…â˜… è¿½åŠ ï¼šãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¨˜æ†¶ã—ã¦ãŠãå¤‰æ•° â˜…â˜…â˜…
    try {
        socket = io();
    } catch(e) {
        console.log("ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ");
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function switchModal(closeId, openId) { closeModal(closeId); openModal(openId); }

    function openAccountFromSettings() {
      closeModal('settingsMainMenu');
      showAuthModal(); 
    }

    // --- ç”»é¢é·ç§» ---
    function goToCharacterSelect(mode) { window.location.href = "character.html?mode=" + mode; }

    function startGame(difficulty) {
      if (difficulty === 'ex_hard3') {
          window.location.href = "cpu_yaneuraou.html";
      } else {
          window.location.href = "game_cpu.html?opponent=" + difficulty;
      }
    }

    // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å–‹ã‚Šæ©Ÿèƒ½ ---
    let bubbleTimer = null;
    function talkCharacter() {
        const bubble = document.getElementById("characterBubble");
        const userName = document.getElementById("userNameDisplay").textContent || "ã‚²ã‚¹ãƒˆ";
        const now = new Date();
        const hour = now.getHours();

        const baseMessages = [
            `ãŠæ‰‹åˆã‚ã›ã€\nã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼\n${userName}ã•ã‚“ï¼`,
            `${userName}ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼\nä»Šæ—¥ã‚‚å°†æ£‹ã§ã™ã‹ï¼Ÿ`,
            `æ¬¡ã®ä¸€æ‰‹ã€\nã˜ã£ãã‚Šè€ƒãˆã¾ã—ã‚‡ã†â€¦`,
            `å°†æ£‹ã¯æ¥½ã—ã‚€ã“ã¨ãŒä¸€ç•ªã§ã™ã‚ˆã­ï¼\n${userName}ã•ã‚“ï¼`,
            `ã•ã‚ã€å¯¾å±€ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼\n${userName}ã•ã‚“ï¼`,
            `ã“ã“ã¯ã©ã“ã§ã—ã‚‡ã†ã‹â€¦ï¼Ÿ`,
            `å¯¾å±€ãŒçµ‚ã‚ã£ãŸã‚‰ã€\nã‚«ãƒ¬ãƒ¼ã‚’é£Ÿã¹ã¾ã—ã‚‡ã†â€¦`,
            `ä¸€æ­©åƒé‡‘â€¦\næ­©ã‚‚å¤§åˆ‡ã«ã—ã¾ã—ã‚‡ã†ã­ã€\n${userName}ã•ã‚“ã€‚`,
            `${userName}ã•ã‚“ã®å¾—æ„æˆ¦æ³•ã¯\nãªã‚“ã§ã™ã‹ï¼Ÿ`,
            `è©°å°†æ£‹ãŒè§£ã‘ã‚‹ã¨ã€\né ­ãŒã‚¹ãƒƒã‚­ãƒªã—ã¾ã™ã‚ˆã­ï¼`,
            `è² ã‘ã¦ã‚‚è…ã‚‰ãšã€\næ¬¡ã®ä¸€æ‰‹ã‚’è¦‹æ®ãˆã¾ã—ã‚‡ã†ã€‚`,
            `æ”»ã‚ã‚‹æ™‚ã¯å¤§èƒ†ã«ã€\nå®ˆã‚‹æ™‚ã¯æ…é‡ã«ã€ã§ã™ã‚ˆã€‚`,
            `äºŒæ­©ã«ã ã‘ã¯æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã­ï¼`,
            `${userName}ã•ã‚“ã¨æŒ‡ã™æ™‚é–“ã¯ã€\nç§ã«ã¨ã£ã¦å®ç‰©ã§ã™ã€‚`,
            `ç‹æ‰‹ï¼ã¨ã„ããŸã„ã¨ã“ã‚ã§ã™ãŒã€\nã¾ãšã¯è½ã¡ç€ãã¾ã—ã‚‡ã†ã€‚`,
            `ä»Šæ—¥ã‚‚ä¸€æ—¥ã€\nãŠç–²ã‚Œæ§˜ã§ã™ã€${userName}ã•ã‚“ã€‚`,
            `${userName}ã•ã‚“ã€\nå°‘ã—ä¼‘æ†©ã—ã¾ã›ã‚“ã‹ï¼Ÿ\nãŠèŒ¶ã‚’æ·¹ã‚Œã¾ã™ã­ã€‚`,
            `å¤–ã®ç©ºæ°—ã¯ã€\nä»Šã©ã‚“ãªæ„Ÿã˜ã§ã™ã‹ï¼Ÿ`,
            `å¤œæ›´ã‹ã—ã¯ç¦ç‰©ã§ã™ã‚ˆï¼Ÿ\nâ€¦ã¨è¨€ã„ã¤ã¤ã€\nå°†æ£‹ã—ã¡ã‚ƒã„ã¾ã™ã‚ˆã­ã€‚`,
            `${userName}ã•ã‚“ï¼\nä¼šã„ã«æ¥ã¦ãã‚Œã¦å¬‰ã—ã„ã§ã™ï¼`,
            `ãªã‚“ã ã‹ä»Šæ—¥ã¯ã€\nè‰¯ã„ã“ã¨ãŒã‚ã‚Šãã†ãªäºˆæ„Ÿã§ã™ï¼`,
            `ç”»é¢ã®å‘ã“ã†å´ã£ã¦ã€\nã©ã‚“ãªæ™¯è‰²ãªã‚“ã§ã™ã‹ï¼Ÿ`,
            `ã‚ãŸã—ã®ã“ã®æœã€\nå®Ÿã¯å‹•ãã‚„ã™ã„ã‚“ã§ã™ã‚ˆã€‚`,
            `æ¬¡ã¯ã©ã‚“ãªæ£‹è­œã‚’\nè¦‹ã›ã¦ãã‚Œã‚‹ã‚“ã§ã™ã‹ï¼Ÿ`,
            `ã€Œç‹ã‚ˆã‚Šé£›è»Šã‚’å¯æ„›ãŒã‚‹ã€\nãªã‚“ã¦è¨€ã£ã¡ã‚ƒãƒ€ãƒ¡ã§ã™ã‚ˆï¼Ÿ`,
            `éŠ€ã®å‹•ãã£ã¦ã€å¯æ„›ã„ã§ã™ã‚ˆã­ã€‚`,
            `å¯¾å±€ã®å¾Œã®ã‚«ãƒ¬ãƒ¼ã¯ã€\næ ¼åˆ¥ã®å‘³ãŒã—ã¾ã™ã€‚`,
            `é§’ã®éŸ³ã£ã¦ã€\nå¿ƒãŒè½ã¡ç€ãã¾ã›ã‚“ã‹ï¼Ÿ`,
            `é›†ä¸­ã—ã™ãã¦ã€\nç¬ãã‚’å¿˜ã‚Œã¦ã¾ã›ã‚“ã‹ï¼Ÿç›®ãŒä¹¾ã„ã¡ã‚ƒã„ã¾ã™ã‚ˆï½`,
            `èƒŒç­‹ã‚’ä¼¸ã°ã™ã¨ã€\nè‰¯ã„æ‰‹ãŒæµ®ã‹ã³ã¾ã™ã‚ˆã€‚`,
            `ä»Šæ—¥ã¯ã©ã‚“ãªåå±€ãŒ\nç”Ÿã¾ã‚Œã‚‹ã‚“ã§ã—ã‚‡ã†ã‹ã€‚`,
            `ç„¡ç†ãªæ”»ã‚ã‚ˆã‚Šã€\nç²˜ã‚Šå¼·ã„å—ã‘ãŒå‹æ©Ÿã‚’å‘¼ã³ã¾ã™ã€‚`,
            `æŒã¡æ™‚é–“ã‚’ä½¿ã„åˆ‡ã‚‹ãã‚‰ã„ã€\nã˜ã£ãã‚Šè€ƒãˆã¡ã‚ƒã„ã¾ã—ã‚‡ã†ï¼`,
            `ãŸã¾ã«ã¯ã€ŒæŠ•äº†ã€ã‚‚å¤§äº‹ãªå‹‡æ°—ã€\nã§ã™ã‚ˆã­â€¦ï¼Ÿ`,
            `æ”»ã‚ã¦ã„ã‚‹æ™‚ã“ãã€\nè‡ªç‰ã®å®‰å…¨ã‚’ç¢ºèªã€ã§ã™ã‚ˆã€‚`,
            `å°†æ£‹ã®é§’ã£ã¦ã€\nãšã£ã¨è§¦ã£ã¦ã„ãŸã„ãã‚‰ã„\næ‰‹è§¦ã‚ŠãŒã„ã„ã§ã™ã‚ˆã­ã€‚`,
            `å®Ÿã¯ç§ã€\næ‰‡å­ã‚’åºƒã’ã‚‹ã®ãŒ\nã¡ã‚‡ã£ã¨è‹¦æ‰‹ãªã‚“ã§ã™â€¦ã€‚`,
            `ãŸã¾ã«ã¯ç©ºã§ã‚‚çœºã‚ã¦ã€\né ­ã‚’ç©ºã£ã½ã«ã™ã‚‹ã®ã‚‚\nå¤§åˆ‡ã§ã™ã‚ˆã€‚`,
            `å°†æ£‹ã‚’å¥½ãã«ãªã£ã¦ãã‚Œã¦ã€\næœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚`,
            `è‹¦ã—ã„æ™‚ã“ãã€ç›¸æ‰‹ã®è¦–ç‚¹ã«ãªã£ã¦ç›¤é¢ã‚’çœºã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`,
            `å°†æ£‹ã‚‚ã‚«ãƒ¬ãƒ¼ã‚‚ã€ä¸€æ™©å¯ã‹ã›ã‚‹ã¨æ·±ã¿ãŒå‡ºã‚‹ã‚“ã§ã™ã‚ˆã€‚`,
            `ç„¡ç†ã—ã¦å¼·ããªã‚ã†ã¨ã—ãªãã¦ã‚‚ã€æ¥½ã—ãæŒ‡ã™ã®ãŒä¸€ç•ªã®è¿‘é“ã§ã™ã‚ˆã€‚`,
            `æ°—åˆ†è»¢æ›ã«éº»é›€ã§ã‚‚â€¦\nã‚ã€éº»é›€æ©Ÿèƒ½ã¯ãªã„ã‚“ã§ã—ãŸã€‚`,
            `ã©ã‚“ãªæ©Ÿèƒ½ãŒæ¬²ã—ã„ã§ã™ã‹ï¼ŸãŠã—ãˆã¦ãã ã•ã„ï¼`,
            `ãƒã‚°ã‚’è¦‹ã¤ã‘ãŸã‚‰ãŠã—ãˆã¦ãã ã•ã„ã­ï¼`,
            `ã“ã®ã‚²ãƒ¼ãƒ ã«é–¢ã™ã‚‹è¦æœ›ã‚„æ”¹å–„æ¡ˆãŒã‚ã£ãŸã‚‰ã„ã¤ã§ã‚‚ãŠã—ãˆã¦ãã ã•ã„ï¼`,
            `å°†æ£‹ã£ã¦ã€ãšã£ã¨åŒã˜å§¿å‹¢ã§ã‚„ã‚‹ã¨ç–²ã‚Œã¡ã‚ƒã„ã¾ã™ã€‚`,
            `é›†ä¸­ã™ã‚‹ã¨ã€ãŠãªã‹ãŒã™ã„ã¦ã„ã‚‹ã®ã‚‚å¿˜ã‚Œã¡ã‚ƒã„ã¾ã™ã­ã€‚`,
            `æ–°å›½ç«‹ç«¶æŠ€å ´ã®è¿‘ãã«ã€å°†æ£‹ç›¤ã¿ãŸã„ãªå»ºç‰©ã‚ã‚Šã¾ã›ã‚“ï¼Ÿ`,
            `${userName}ã•ã‚“ã¯ã€å¥½ããªé§’ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿ`,
            `å°†æ£‹ã®å¤¢ã£ã¦ãƒ¬ã‚¢ã˜ã‚ƒãªã„ã§ã™ã‹ï¼Ÿ`,
            `èª­ã¿è¾¼ã¿ãŒé…ã„æ™‚ã¯ã€ç§ãŒè£ã§é§’ã‚’ä¸¦ã¹ã¦ã„ã‚‹æœ€ä¸­ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`,
            `å……é›»ã€å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿç†±ããªã£ãŸã‚‰å°‘ã—ä¼‘æ†©ã§ã™ã‚ˆã€‚`,
            `ã“ã®ã‚²ãƒ¼ãƒ ã€${userName}ã•ã‚“ã®ä½¿ã„ã‚„ã™ã„ã‚ˆã†ã«é€²åŒ–ã—ã¦ã„ããŸã„ã§ã™ã€‚`,
            `ã‚¹ãƒãƒ›ã®é›»æ± ã€å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿç†±ããªã£ãŸã‚‰å°‘ã—ä¼‘æ†©ã§ã™ã‚ˆã€‚`,
            `é•·è€ƒã—ãŸæœ«ã«ã€çµå±€ç›´æ„Ÿã§æŒ‡ã—ã¡ã‚ƒã†ã“ã¨ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚`,
            `ã€Œæ¡‚é¦¬ã®é«˜è·³ã³æ­©ã®é¤Œé£Ÿã€â€¦ãã‚Œã§ã‚‚è·³ã­ãŸããªã‚‹ã®ãŒæ¡‚é¦¬ãªã‚“ã§ã™ã‚ˆã­ã€‚`,
            `æ¡‚é¦¬ã‚’ã¯ã­ã‚‹ã¨ããŒä¸€ç•ªæ°—æŒã¡ã„ã„ã¨ã„ã£ã¦ã‚‚éè¨€ã˜ã‚ƒãªã„ã§ã™ã€‚`,
            `å¯¾å±€ãŒçµ‚ã‚ã£ã¦ã‚‚ã€ã‚‚ã†å°‘ã—ã ã‘ã“ã†ã—ã¦ãŠè©±ã—ã—ã¦ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ`,
            `é¦–ãŒå‡ã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿãã‚‹ã£ã¨å›ã—ã¦ã‚¹ãƒˆãƒ¬ãƒƒãƒã—ã¾ã—ã‚‡ã†ã€‚`,
            `ç›®ãŒç–²ã‚ŒãŸã‚‰ã€é ãã®ç·‘ã‚’è¦‹ã‚‹ã¨ã„ã„ã‚‰ã—ã„ã§ã™ã‚ˆã€‚â€¦ã‚ã€ã‚ãŸã—ã®æœç·‘è‰²ã§ã™ã­ã€é ãã«ã„ãã¾ã™ï¼`,
            `ã€Œç‹ã®æ—©é€ƒã’å…«æ‰‹ã®å¾—ã€ã£ã¦è¨€ã„ã¾ã™ã—ã€å«Œãªäºˆæ„ŸãŒã—ãŸã‚‰ã™ãä¼‘æ†©ã§ã™ã‚ˆï¼`,
            `ã€Œé è¦‹ã®è§’ã«å¥½æ‰‹ã‚ã‚Šã€â€¦å°‘ã—é›¢ã‚ŒãŸè¦–ç‚¹ã‹ã‚‰è‡ªåˆ†ã‚’è¦‹ã¤ã‚ã‚‹ã®ã‚‚å¤§åˆ‡ã§ã™ã€‚`,
            `ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ã«ä»˜ãåˆã£ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚åŠ©ã‹ã‚Šã¾ã™ï¼`,
            `æ˜¨æ—¥ã€è©°å°†æ£‹ã®å¤¢ã‚’\nè¦‹ã¡ã‚ƒã„ã¾ã—ãŸã€‚`
        ];

        let timeMessages = [];
        if (hour >= 5 && hour < 11) {
            timeMessages = [
                `ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼\næœã®å°†æ£‹ã¯é ­ãŒå†´ãˆã¾ã™ã­ã€‚`,
                `${userName}ã•ã‚“ã€\næœã”ã¯ã‚“ã¯é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ\nç§ã¯ã‚«ãƒ¬ãƒ¼ã§ã—ãŸï¼`,
                `ä»Šæ—¥ã‚‚ä¸€æ—¥ã€\næ¸…ã€…ã—ãæŒ‡ã—ã¾ã—ã‚‡ã†ï¼`,
                `æœã®å…‰ã‚’æµ´ã³ãªãŒã‚‰ã®\nå¯¾å±€â€¦è´…æ²¢ã§ã™ã­ã€‚`
            ];
        } else if (hour >= 11 && hour < 17) {
            timeMessages = [
                `ãŠæ˜¼ä¼‘ã¿ã§ã™ã‹ï¼Ÿ\nå¯¾å±€ã—ã¦ã‹ã‚‰æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ`,
                `åˆå¾Œã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼\nå¿œæ´ã—ã¦ã„ã¾ã™ã­ã€‚`,
                `ã‚ã€ãŠæ˜¼ã”ã¯ã‚“ã®åŒ‚ã„â€¦`,
                `ä¸€ç•ªçœ ããªã‚‹æ™‚é–“ã§ã™ã­ã€‚\nå°‘ã—æ·±å‘¼å¸ã—ã¾ã—ã‚‡ã†ï¼`
            ];
        } else if (hour >= 17 && hour < 22) {
            timeMessages = [
                `ä»Šæ—¥ã‚‚ãŠç–²ã‚Œæ§˜ã§ã™ï¼\nä¸€å±€æŒ‡ã—ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚`,
                `å¤œã®é™ã‹ãªå¯¾å±€ã€\nç§ã¯å¤§å¥½ãã§ã™ã‚ˆã€‚`,
                `æ™©ã”ã¯ã‚“ã¯ã€\nã‚‚ã†é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ`,
            ];
        } else {
            timeMessages = [
                `${userName}ã•ã‚“ã€\nå¤œæ›´ã‹ã—ã¯ç¦ç‰©ã§ã™ã‚ˆï¼Ÿ`,
                `ã“ã‚“ãªæ™‚é–“ã¾ã§ç†±å¿ƒã§ã™ã­ã€‚\nâ€¦ç„¡ç†ã¯ã—ãªã„ã§ãã ã•ã„ã­ã€‚`,
                `ç¾Šã‚’æ•°ãˆã‚‹ã‚ˆã‚Šã€\nè©°å°†æ£‹ã‚’è§£ãæ–¹ãŒ\nçœ ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã‚ˆï¼Ÿ`,
                `æ·±å¤œã®å¯¾å±€ã¯ã€è² ã‘ã‚‹ã¨æ‚”ã—ãã¦çœ ã‚Œãªããªã£ã¡ã‚ƒã„ã¾ã™ã‚ˆï¼Ÿ`,
                `é™ã‹ãªçœŸå¤œä¸­â€¦\né§’ã®éŸ³ãŒéŸ¿ã„ã¦å¿ƒåœ°ã„ã„ã§ã™ã­ã€‚`
            ];
        }

        const charMessages = baseMessages.concat(timeMessages);
        const randomMsg = charMessages[Math.floor(Math.random() * charMessages.length)];
        
        bubble.textContent = randomMsg;
        bubble.style.display = "block";

        clearTimeout(bubbleTimer);
        bubbleTimer = setTimeout(() => {
            bubble.style.display = "none";
        }, 2000);
    }

    // --- â˜…â˜…â˜… è¿½åŠ : ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ â˜…â˜…â˜… ---
    function openLobbyChat() {
        openModal('lobbyChatModal');
        // ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã„ãŸã‚‰å…¥å®¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ï¼ˆä»»æ„ï¼‰
        const myName = document.getElementById("userNameDisplay").textContent || "ã‚²ã‚¹ãƒˆ";
        // socket.emit('chat message', { name: "ã‚·ã‚¹ãƒ†ãƒ ", text: `${myName}ã•ã‚“ãŒãƒ­ãƒ“ãƒ¼ã«æ¥ã¾ã—ãŸ`, isSystem: true });
    }

    function sendLobbyMessage() {
        if (!socket) return alert("ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        const input = document.getElementById("lobbyChatInput");
        const text = input.value.trim();
        if (!text) return;

        const myName = document.getElementById("userNameDisplay").textContent || "ã‚²ã‚¹ãƒˆ";
        socket.emit('chat message', {
            name: myName,
            text: text,
            role: 'lobby' // ãƒ­ãƒ“ãƒ¼ç”¨ã¨ã—ã¦åŒºåˆ¥ï¼ˆè‰²åˆ†ã‘ãªã©ã«åˆ©ç”¨å¯èƒ½ï¼‰
        });
        input.value = "";
    }

    // ãƒãƒ£ãƒƒãƒˆå—ä¿¡å‡¦ç†
    if (socket) {
        // â˜…â˜…â˜… ä¿®æ­£ï¼šå±¥æ­´ã‚’å—ã‘å–ã£ãŸã‚‰å¤‰æ•°ã«ä¿å­˜ã—ã¦æç”» â˜…â˜…â˜…
        socket.on('chat history', (history) => {
            globalChatHistory = history; // å¤‰æ•°ã«ä¿å­˜
            renderLobbyChat();           // æç”»é–¢æ•°ã‚’å‘¼ã¶
        });

        // é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆå—ä¿¡
        socket.on('chat message', (data) => {
            globalChatHistory.push(data); // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ä¿å­˜
            // 1ä»¶ã ã‘è¿½åŠ ã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€å¿µã®ãŸã‚å†æç”»ï¼ˆã¾ãŸã¯addMessageã‚’ä½¿ã†ï¼‰
            addMessageToLobbyChat(data); 
        });
    }
// â˜…â˜…â˜… è¿½åŠ ï¼šå±¥æ­´å…¨ä½“ã‚’å†æç”»ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
    function renderLobbyChat() {
        const historyDiv = document.getElementById("lobbyChatHistory");
        if (!historyDiv) return;

        historyDiv.innerHTML = ""; // ä¸€åº¦ã‚¯ãƒªã‚¢
        
        // ä¿å­˜ã—ã¦ãŠã„ãŸå±¥æ­´ã‚’ä½¿ã£ã¦å…¨éƒ¨è¡¨ç¤ºã—ãªãŠã™
        globalChatHistory.forEach(data => {
            addMessageToLobbyChat(data);
        });
    }
    // â˜…â˜…â˜… ä¿®æ­£ç‰ˆï¼šç”»åƒã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•° â˜…â˜…â˜…
    function addMessageToLobbyChat(data) {
        const historyDiv = document.getElementById("lobbyChatHistory");
        if (!historyDiv) return;

        // è‡ªåˆ†ã‹ã©ã†ã‹ã®åˆ¤å®š
        const domName = document.getElementById("userNameDisplay").textContent;
        const storageName = localStorage.getItem('shogi_username');
        const isMe = (data.name.trim() === (domName || "").trim()) || 
                     (data.name.trim() === (storageName || "").trim());

        if (data.isSystem) {
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const sysDiv = document.createElement("div");
            sysDiv.className = "chat-system-box";
            sysDiv.textContent = data.text;
            historyDiv.appendChild(sysDiv);
        } else {
            // --- è¡Œã®ã‚³ãƒ³ãƒ†ãƒŠ ---
            const rowDiv = document.createElement("div");
            rowDiv.className = "chat-row";
            if (isMe) rowDiv.classList.add("mine");

            // --- 1. ã‚¢ã‚¤ã‚³ãƒ³ã¨åå‰ã®åˆ— ---
            const iconCol = document.createElement("div");
            iconCol.className = "icon-container";

            // åå‰
            const nameDiv = document.createElement("div");
            nameDiv.className = "chat-name-badge";
            nameDiv.textContent = data.name;

            // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ (test.icon.PNG ã‚’ä½¿ç”¨)
            const iconImg = document.createElement("img");
            // â˜…ç”»åƒã‚’ä¿å­˜ã—ã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
            iconImg.src = "script/image/test.icon.PNG"; 
            iconImg.className = "chat-icon-img";
            // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ€ãƒŸãƒ¼
            iconImg.onerror = function() { this.style.backgroundColor = "#ccc"; };

            iconCol.appendChild(nameDiv);
            iconCol.appendChild(iconImg);

            // --- 2. å¹ãå‡ºã— ---
            const bubbleDiv = document.createElement("div");
            bubbleDiv.className = "chat-bubble";
            bubbleDiv.textContent = data.text;

            // çµ„ã¿ç«‹ã¦
            rowDiv.appendChild(iconCol);
            rowDiv.appendChild(bubbleDiv);

            historyDiv.appendChild(rowDiv);
        }

        historyDiv.scrollTop = historyDiv.scrollHeight;
    }

    // Enterã‚­ãƒ¼é€ä¿¡å¯¾å¿œ
    document.addEventListener("DOMContentLoaded", () => {
        const lobbyInput = document.getElementById("lobbyChatInput");
        if (lobbyInput) {
            lobbyInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendLobbyMessage();
            });
        }
    });

    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const openMenuId = urlParams.get('open');
      
      if (openMenuId) {
        const menuEl = document.getElementById(openMenuId);
        if (menuEl) {
          menuEl.style.display = 'flex';
          if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.pathname);
          }
        }
      }
    };


// â˜…â˜…â˜… è¿½åŠ ï¼šãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒç¢ºå®šã—ãŸã‚‰ã€ãƒãƒ£ãƒƒãƒˆã®è‰²ã‚’æ›´æ–°ã™ã‚‹ â˜…â˜…â˜…
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ï¼
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ï¼ˆåå‰ã®è¡¨ç¤ºæ›´æ–°ã‚’å¾…ã¤ãŸã‚ï¼‰å†æç”»
            setTimeout(() => {
                renderLobbyChat();
            }, 500); 
        }
    });
  </script>

  <div id="practiceMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ç·´ç¿’ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
      <button class="sub-btn" onclick="startGame('saijaku')">ãŸã‚ã‚€ã‚Œ (æœ€å¼±)</button>
      <button class="sub-btn" onclick="startGame('easy')">ãŠã‚ãã³ (å…¥é–€)</button>
      <button class="sub-btn" onclick="startGame('normal')">ãŸã—ãªã¿ (æ™®é€š)</button>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('practiceMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="onePlayerModeSelect" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">å¯¾æˆ¦ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
      <button class="sub-btn" onclick="startGame('hard1')">ã“ã¿ã‚„</button>
      <button class="sub-btn" onclick="startGame('hard2')">ã—ãŠã‚„</button>
      <button class="sub-btn" onclick="startGame('ex_hard1')">ã“ã¿ã‚„EX</button>
      <button class="sub-btn" onclick="startGame('ex_hard2')">ã—ãŠã‚„EX</button>
      <button class="sub-btn" style="background:#d35400;" onclick="startGame('ex_hard3')">è©¦é¨“å®Ÿè£… (æœ€å¼·)</button>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('onePlayerModeSelect')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="helpMainMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #17a2b8; margin-top: 0;">ãƒ˜ãƒ«ãƒ—</h3>
      <div class="modal-grid">
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpMode')">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</button>
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpDifficulty')">é›£æ˜“åº¦ã«ã¤ã„ã¦</button>
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpChar')">ã‚­ãƒ£ãƒ©ã«ã¤ã„ã¦</button>
        <button class="sub-btn" style="background: #6f42c1;" onclick="switchModal('helpMainMenu', 'helpContact')">ä¸å…·åˆãƒ»è¦æœ›</button>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('helpMainMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="helpMode" class="overlay">
    <div class="modal-box" style="max-width: 350px;">
      <h3 style="color: #8b4513;">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</h3>
      <div style="text-align: left; font-size: 0.85rem; line-height: 1.5; overflow-y: auto; max-height: 50vh;">
        <p><strong>ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆã‚Œã‚“ã—ã‚…ã†ï¼ã²ã¨ã‚Šã§ï¼ãµãŸã‚Šã§ï¼‰</strong><br>CPUã¨ã®å¯¾æˆ¦ãŒã§ãã¾ã™ã€‚ã“ã®ç«¯æœ«ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒå£«ã§ã‚‚å¯¾æˆ¦ãŒã§ãã¾ã™ã€‚</p>
        <p><strong>ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</strong><br>é ãã«ã„ã‚‹äººã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ãŒã§ãã¾ã™ã€‚å…ˆã«å…¥å®¤ã—ãŸäººãŒå…ˆæ‰‹ã«ãªã‚Šã¾ã™ã€‚ã€Œå¾…ã£ãŸã€ãŒç¦æ­¢ã§ã™ã€‚</p>
        <p><strong>ãƒ»ãƒãƒ£ãƒƒãƒˆ</strong><br>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ­ãƒ“ãƒ¼ã«ã„ã‚‹äººãŸã¡ã¨ä¼šè©±ãŒã§ãã¾ã™ã€‚</p> <p><strong>ãƒ»è§£æ</strong><br>æ£‹è­œã‚’è²¼ã‚Šä»˜ã‘ã¦ã€è§£æã‚„æŒ¯ã‚Šè¿”ã‚ŠãŒã§ãã¾ã™ã€‚</p>
        <p><strong>ãƒ»æ£‹è­œ</strong><br>è‡ªèº«ã®éå»ã®æ£‹è­œãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚è§£æã‚„æŒ¯ã‚Šè¿”ã‚Šã‚‚ã§ãã¾ã™ã€‚â€»ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('helpMode', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

<div id="helpDifficulty" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin: 0 0 10px 0;">é›£æ˜“åº¦ã«ã¤ã„ã¦</h3>
      
      <div style="text-align: left; font-size: 0.85rem; line-height: 1.4;">
        <p style="margin: 0 0 5px 0;">CPUã®é›£æ˜“åº¦ã¯ã€ä¸‹ã«è¡Œãã»ã©å¼·ã„ã§ã™ã€‚</p>
        <ul style="padding-left: 20px; margin: 0 0 10px 0;">
          <li>ãŸã‚ã‚€ã‚Œ</li>
          <li>ãŠã‚ãã³</li>
          <li>ãŸã—ãªã¿</li>
          <li>ã—ãŠã‚„ / ã“ã¿ã‚„</li>
          <li>ã—ãŠã‚„EX / ã“ã¿ã‚„EX</li>
          <li style="font-weight: bold; color: #d35400;">è©¦é¨“å®Ÿè£…ï¼ˆæœ€å¼·ï¼‰</li>
        </ul>
        <p style="margin: 0; font-size: 0.75rem;">â€»ã—ãŠã‚„ç³»ã¨ã“ã¿ã‚„ç³»ã®å¼·ã•ã¯åŒã˜ã§ã™ãŒã€æ€§æ ¼ãŒç•°ãªã‚Šã¾ã™ã€‚</p>
      </div>
      
      <button class="sub-btn" style="background:#666; margin: 15px 0 0 0;" onclick="switchModal('helpDifficulty', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>
  <div id="helpChar" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¤ã„ã¦</h3>
      <div style="text-align: left; font-size: 0.9rem; line-height: 1.6;">
        <p>ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å¯¾å±€å‰ã«è‡ªèº«ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚</p>
        <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ãã‚Œãã‚Œç‹¬è‡ªã®<strong>ã€Œå¿…æ®ºæŠ€ã€</strong>ã‚’æŒã£ã¦ãŠã‚Šã€å¯¾å±€ã‚’æœ‰åˆ©ã«é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('helpChar', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="helpContact" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513;">ä¸å…·åˆãƒ»ã”è¦æœ›</h3>
      <div style="margin: 20px 0; line-height: 1.6;">
        <p>ã“ã¡ã‚‰ã‹ã‚‰ã„ã¤ã§ã‚‚å—ã‘ä»˜ã‘ã¦ãŠã‚Šã¾ã™ã€‚<br>ã¾ãŸã¯ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
        <button class="sub-btn" style="background: #28a745; margin-top: 10px;" 
          onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSc5Ry7hikuBYzDp7lTVLtO74zWabVlvvsjc3a0HgqrIuT8Dww/viewform', '_blank')">
          å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã â†—
        </button>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('helpContact', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="offlineMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h3>
      <button class="sub-btn" onclick="goToCharacterSelect('practice')">ã‚Œã‚“ã—ã‚…ã†</button>
      <button class="sub-btn" onclick="goToCharacterSelect('cpu')">ã²ã¨ã‚Šã§</button>
      <button class="sub-btn" onclick="goToCharacterSelect('pvp')">ãµãŸã‚Šã§</button>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('offlineMenu')">æˆ»ã‚‹</button>
    </div>
  </div>

</body>
</html>
