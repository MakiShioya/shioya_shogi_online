<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>ã—ãŠã‚„å°†æ£‹ - ãƒ›ãƒ¼ãƒ </title>
  <link rel="icon" href="script/image/komiya_icon.png"> 
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="script/image/komiya_icon.png">
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* --- ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š --- */
    @font-face {
      font-family: 'SetoFont';
      src: url('script/font/setofont.ttf') format('truetype');
      font-display: block; /* èª­ã¿è¾¼ã¿å®Œäº†ã¾ã§æ–‡å­—ã‚’å‡ºã•ãªã„ */
    }

    * {
      font-family: "SetoFont", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif !important;
    }

    /* --- â˜…çˆ†é€Ÿãƒ­ãƒ¼ãƒ‰ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    #loading-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: #2c3e50; /* æœ€åˆã‹ã‚‰ã“ã®è‰²ã§ç”»é¢ã‚’è¦†ã† */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      transition: opacity 0.5s ease;
      visibility: visible;
    }

    .loader-content {
      text-align: center;
      color: white;
      /* æœ€åˆã¯ä¸­èº«ï¼ˆç”»åƒã‚„ãƒãƒƒãƒ—ã‚¹ï¼‰ã‚’éš ã—ã€ãƒ•ã‚©ãƒ³ãƒˆå®Œäº†å¾Œã«è¡¨ç¤º */
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    /* ãƒ•ã‚©ãƒ³ãƒˆæº–å‚™å®Œäº†å¾Œã«ä»˜ä¸ã™ã‚‹ã‚¯ãƒ©ã‚¹ */
    #loading-screen.font-ready .loader-content {
      visibility: visible;
      opacity: 1;
    }

    .spinner {
      width: 50px; height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .loading-char {
      width: 80px; height: 80px; margin-bottom: 20px;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
      animation: float 2s infinite ease-in-out;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    #loading-tips {
      margin-top: 20px; padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 0.9rem; max-width: 250px; line-height: 1.5; min-height: 3em;
    }

    /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body {
      margin: 0; padding: 0;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #2c3e50;
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }

    html { width: 100%; height: 100%; overflow: hidden; overscroll-behavior: none; }

    input, textarea { user-select: text; -webkit-user-select: text; touch-action: auto; }

    #bg-image {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1;
      background-image: url('script/image/shogi_title.PNG');
      background-size: cover; background-position: center; background-repeat: no-repeat;
    }

    .speech-bubble {
      display: none; position: absolute; bottom: 30vh; left: 50%; transform: translateX(-50%);
      background: #fff8dc; border: 3px solid #8b4513; border-radius: 20px; padding: 12px 20px;
      min-width: 160px; max-width: 220px; color: #333; font-weight: bold; font-size: 0.95rem;
      z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: none;
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); white-space: pre-wrap; line-height: 1.4;
    }

    .speech-bubble::after {
      content: ''; position: absolute; bottom: 100%; right: 20%;
      border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 15px solid #8b4513;
    }

    @keyframes pop-in {
      0% { transform: translateX(-50%) scale(0); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    .character-stand {
      position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      height: 85vh; width: auto; max-width: 95%; z-index: 1;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); cursor: pointer; pointer-events: auto;
    }

    .user-info-bar {
      position: absolute; top: 0; width: 100%; padding: 10px 20px; 
      background: rgba(0, 0, 0, 0.6); color: white;
      display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 5;
    }

    .user-name { font-weight: bold; font-size: 1.1rem; }
    
    .bottom-menu {
      position: absolute; bottom: 10px; width: 96%; left: 2%;
      display: flex; justify-content: space-around; align-items: flex-end; gap: 5px; z-index: 10;
    }

    .menu-btn {
      flex: 1; height: 60px;
      background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
      border: 2px solid white; border-radius: 10px; color: white; font-weight: bold; font-size: 1.1rem;
      cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .menu-btn:active { transform: scale(0.95); }

    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; overscroll-behavior: none;
    }

    .modal-box {
      position: relative; background: #fff8dc; padding: 15px; border-radius: 10px; border: 4px solid #8b4513;
      text-align: center; width: 80%; max-width: 800px; max-height: 85vh; display: flex; flex-direction: column; box-sizing: border-box;
    }

    .modal-body {
      flex: 1; overflow-y: auto; margin: 10px 0; padding: 5px; -webkit-overflow-scrolling: touch; 
    }
    
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }

    .sub-btn {
      display: block; width: 100%; padding: 12px 5px; font-size: 1rem; background: #8b4513;
      color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
    }
    .sub-btn:active { transform: scale(0.98); opacity: 0.9; }

    .close-small-btn {
      position: absolute; top: 8px; right: 8px; padding: 4px 10px; background: #666;
      color: white; border: none; border-radius: 12px; font-size: 0.75rem; font-weight: bold; cursor: pointer; z-index: 101;
    }

    #lobbyChatHistory {
      flex: 1; overflow-y: auto; background: rgba(255, 255, 255, 0.5);
      border: 1px solid #ccc; padding: 8px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; min-height: 100px;
    }

    .chat-input-area { display: flex; gap: 5px; margin-top: 8px; }

    .notification-badge {
      position: absolute; top: -5px; right: -5px; background-color: red; color: white;
      border-radius: 50%; width: 20px; height: 20px; font-size: 12px;
      display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid white; z-index: 10; display: none;
    }

    .mail-item { background: white; border-bottom: 1px solid #ccc; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .mail-item.type-reward-active { background-color: #e3f2fd; border-left: 5px solid #2196f3; }
    .mail-item.type-reward-claimed { background-color: #f5f5f5; color: #888; border-left: 5px solid #bdbdbd; }
    .mail-item.type-normal { background-color: #ffebee; border-left: 5px solid #ef5350; }

    .right-side-menu { position: absolute; left: 15px; top: 100px; display: flex; flex-direction: column; gap: 15px; z-index: 20; }
    .mission-main-btn, .mail-main-btn { width: 70px; height: 70px; border: 3px solid #fff; border-radius: 50%; color: #fff; font-weight: bold; font-size: 0.8rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; animation: float-btn 3s infinite ease-in-out; }
    .mission-main-btn { background: linear-gradient(to bottom, #fff176, #fbc02d); color: #5d4037; }
    .mail-main-btn { background: linear-gradient(to bottom, #ffcc80, #ef6c00); animation-delay: 1.5s; }

    .chat-row { display: flex; align-items: flex-start; gap: 10px; max-width: 95%; }
    .chat-row.mine { align-self: flex-end; flex-direction: row-reverse; }
    .icon-container { display: flex; flex-direction: column; align-items: center; width: 60px; }
    .chat-name-badge { background: #fff; border: 1px solid #8b4513; border-radius: 10px; z-index: 2; margin-bottom: -10px; width: 60px; height: 18px; display: flex; justify-content: center; align-items: center; padding: 0 4px; overflow: hidden; }
    .chat-icon-img { width: 50px; height: 50px; border: 3px solid #56ab2f; border-radius: 12px; background: #fff; object-fit: cover; }
    .chat-bubble { position: relative; padding: 10px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; word-break: break-all; background: #fff; border: 2px solid #e0e0e0; }
    .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; }

    .offline-color { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%) !important; }
    .online-color { background: linear-gradient(to bottom, #ff758c 0%, #ff7eb3 100%) !important; }
    .mypage-color { background: linear-gradient(to bottom, #f6d365 0%, #fda085 100%) !important; }
    .ready-color { background: linear-gradient(to bottom, #a8e063 0%, #56ab2f 100%) !important; }
  </style>
</head>
<body>

  <div id="loading-screen">
    <div class="loader-content">
      <img src="script/image/komiya_icon.png" class="loading-char" alt="Loading">
      <div class="spinner"></div>
      <div id="loading-tips">èª­ã¿è¾¼ã¿ä¸­...</div>
      <p style="font-size: 0.7rem; opacity: 0.6; margin-top:10px;">LOADING...</p>
    </div>
  </div>

  <script>
    // --- ãƒ­ãƒ¼ãƒ‰ç”»é¢å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ---
    const loadingTipsList = [
        "ã€tipsã€‘ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¯ãã‚Œãã‚Œå›ºæœ‰ã®å¿…æ®ºæŠ€ãŒã‚ã‚Šã¾ã™ã€‚",
        "ã€tipsã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ã¯ã€å…ˆã«å…¥å®¤ã—ãŸæ–¹ãŒå…ˆæ‰‹ã«ãªã‚Šã¾ã™ã€‚",
        "ã€tipsã€‘ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰BGMã®å¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚",
        "ã€tipsã€‘æ‰€æŒå“ã‹ã‚‰å¯¾å±€ã§ä½¿ãˆã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç¢ºèªã§ãã¾ã™ã€‚"
    ];
    
    document.getElementById('loading-tips').textContent = loadingTipsList[Math.floor(Math.random() * loadingTipsList.length)];

    // ç€¬æˆ¸ãƒ•ã‚©ãƒ³ãƒˆãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ä¸­èº«ã‚’è¡¨ç¤º
    document.fonts.ready.then(function() {
        document.getElementById('loading-screen').classList.add('font-ready');
    });

    // ãƒšãƒ¼ã‚¸å…¨ä½“ã®ç´ æèª­ã¿è¾¼ã¿å®Œäº†ã§ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’æ¶ˆã™
    window.addEventListener('load', function() {
        const loader = document.getElementById('loading-screen');
        setTimeout(() => {
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
        }, 1000); // æ¼”å‡ºã®ãŸã‚æœ€ä½1ç§’
    });
  </script>

  <div id="bg-image"></div>

  <div class="user-info-bar">
    <div>
      <span id="userNameDisplay" class="user-name">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“
      <button id="editNameBtn" onclick="showNameEditModal()" style="display:none; background:none; border:none; cursor:pointer; font-size:1rem;">âœï¸</button>
      <span style="margin-left: 15px; font-weight: bold; color: #ffd700; text-shadow: 1px 1px 2px #000;">
        ğŸ’° <span id="userGoldDisplay">0</span> G
      </span>
    </div>
    <div></div>
  </div>

  <div class="right-side-menu">
    <button class="mail-main-btn" onclick="openMailbox()">
      <span class="mail-icon-emoji">âœ‰</span>
      <div>ãƒ¡ãƒ¼ãƒ«</div>
      <span id="mailBadge" class="notification-badge">0</span>
    </button>
    <button class="mission-main-btn" onclick="window.location.href='mission.html'">
      <span class="mission-icon-emoji">ğŸ“œ</span>
      <div>ç›®æ¨™</div>
      <span id="missionBadge" class="mission-badge">!</span>
    </button>
  </div>

  <div id="characterBubble" class="speech-bubble"></div>
  <img class="character-stand" src="script/image/komiya_touka.png" alt="Character" onclick="talkCharacter()">

  <div class="bottom-menu">
    <button class="menu-btn offline-color" onclick="openModal('offlineMenu')">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</button>
    <button onclick="goToCharacterSelect('online')" class="menu-btn online-color">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</button>
    <button class="menu-btn" style="background: linear-gradient(to bottom, #da92ec 0%, #a06ee1 100%);" onclick="openLobbyChat()">ãƒãƒ£ãƒƒãƒˆ</button>
    <button class="menu-btn ready-color" onclick="window.location.href='shop.html'">ã‚·ãƒ§ãƒƒãƒ—</button>
    <button class="menu-btn mypage-color" onclick="window.location.href='mypage.html'">æ£‹è­œ</button>
    <button class="menu-btn" style="background: linear-gradient(to bottom, #607d8b 0%, #455a64 100%);" onclick="openModal('unifiedMenuModal')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
  </div>

  <div id="unifiedMenuModal" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <div class="modal-grid">
        <button class="sub-btn" style="background: linear-gradient(to bottom, #FF9800 0%, #F57C00 100%);" onclick="window.location.href='inventory.html'">ğŸ’ æ‰€æŒå“</button>
        <button class="sub-btn" style="background: #e91e63;" onclick="switchModal('unifiedMenuModal', 'characterSettingsMenu')">ğŸ‘¤ ã‚­ãƒ£ãƒ©</button>
        <button class="sub-btn" style="background: #ff9800;" onclick="showMyStats()">ğŸ“Š æˆ¦ç¸¾</button>
        <button class="sub-btn" style="background: #17a2b8;" onclick="switchModal('unifiedMenuModal', 'helpMainMenu')">â“ ãƒ˜ãƒ«ãƒ—</button>
        <button class="sub-btn" style="background: #6f42c1;" onclick="switchModal('unifiedMenuModal', 'helpContact')">ğŸ”§ ä¸å…·åˆ</button>
        <button class="sub-btn" style="background: #6c757d;" onclick="switchModal('unifiedMenuModal', 'settingsMainMenu')">âš™ï¸ è¨­å®š</button>
      </div>
      <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('unifiedMenuModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="settingsMainMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">è¨­å®š</h3>
      <div class="modal-grid">
        <button class="sub-btn" style="background: #e91e63;" onclick="switchModal('settingsMainMenu', 'characterSettingsMenu')">ã‚­ãƒ£ãƒ©è¨­å®š</button>
        <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'volumeMenu')">éŸ³é‡è¨­å®š</button>
        <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'languageMenu')">è¨€èªè¨­å®š</button>
        <button class="sub-btn" onclick="openAccountFromSettings()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('settingsMainMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="lobbyChatModal" class="overlay">
    <div class="modal-box">
      <button class="close-small-btn" onclick="closeModal('lobbyChatModal')">é–‰ã˜ã‚‹</button>
      <h3 style="color: #005bea; margin: 0 0 5px 0; text-align: left; font-size: 0.9rem;">ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</h3>
      <div id="lobbyChatHistory"></div>
      <div class="chat-input-area">
        <input type="text" id="lobbyChatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px;">
        <button onclick="sendLobbyMessage()" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; font-weight:bold;">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div id="systemAlertModal" class="overlay" style="z-index: 200;"><div class="modal-box"><p id="sysAlertMsg"></p><button id="sysAlertBtn" class="sub-btn">OK</button></div></div>
  <div id="mailboxModal" class="overlay">
    <div class="modal-box">
       <div id="mailListView" style="display:flex; flex-direction:column; height:100%;">
         <h3 style="color:#8b4513; margin-top:0;">å—ä¿¡ãƒˆãƒ¬ã‚¤</h3>
         <div class="modal-body" style="background:#eee; border-radius:5px;"><ul id="mailList"></ul></div>
         <button class="sub-btn" style="background:#666; margin-top:10px;" onclick="closeModal('mailboxModal')">é–‰ã˜ã‚‹</button>
       </div>
       <div id="mailDetailView" style="display:none;">
         <div id="detailSubject" style="font-weight:bold; font-size:1.2rem;"></div>
         <div id="detailBody" class="modal-body" style="text-align:left; background:white; padding:10px; margin:10px 0;"></div>
         <button class="sub-btn" onclick="backToMailList()">æˆ»ã‚‹</button>
       </div>
    </div>
  </div>

  <script src="script/missions.js"></script>
  <script src="script/serifu/komiya.js"></script>
  <script src="script/auth.js"></script>

  <script>
    let socket = null;
    try { socket = io(); } catch(e) { console.log("Socket Error"); }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function switchModal(c, o) { closeModal(c); openModal(o); }
    // --- ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•° ---
function openLobbyChat() {
    openModal('lobbyChatModal');
}

    // --- ãƒãƒ£ãƒƒãƒˆ (Firestoreç‰ˆ) ---
    let chatUnsubscribe = null;
    function initLobbyChat() {
        if (chatUnsubscribe) chatUnsubscribe();
        chatUnsubscribe = db.collection("lobby_chat").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
            const historyDiv = document.getElementById("lobbyChatHistory");
            let msgs = [];
            snap.forEach(doc => msgs.push(doc.data()));
            msgs.reverse();
            historyDiv.innerHTML = "";
            msgs.forEach(m => addMessageToLobbyChatFirestore(m));
            historyDiv.scrollTop = historyDiv.scrollHeight;
        });
    }

    function addMessageToLobbyChatFirestore(data) {
        const historyDiv = document.getElementById("lobbyChatHistory");
        const user = firebase.auth().currentUser;
        const isMe = (data.userId === (user ? user.uid : null));
        const row = document.createElement("div");
        row.className = `chat-row ${isMe ? 'mine' : ''}`;
        
        const safeName = data.name || "ã‚²ã‚¹ãƒˆ";
        const tw = Math.max(60, safeName.length * 12);
        
        row.innerHTML = `
          <div class="icon-container">
            <div class="chat-name-badge">
              <svg viewBox="0 0 ${tw} 20" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" style="font-size:12px; fill:#333; font-weight:bold;">${safeName}</text>
              </svg>
            </div>
            <img src="${data.icon || 'script/image/test.icon.PNG'}" class="chat-icon-img">
          </div>
          <div class="chat-bubble">${data.text}</div>
        `;
        historyDiv.appendChild(row);
    }

    function sendLobbyMessage() {
        const input = document.getElementById("lobbyChatInput");
        const text = input.value.trim();
        if (!text) return;
        const user = firebase.auth().currentUser;
        db.collection("lobby_chat").add({
            text: text,
            name: document.getElementById("userNameDisplay").textContent,
            userId: user ? user.uid : "guest",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => input.value = "");
    }

    // --- Firebase Auth é€£æº ---
    firebase.auth().onAuthStateChanged(user => {
        initLobbyChat();
        if (user) {
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    document.getElementById("userGoldDisplay").textContent = doc.data().gold || 0;
                    updateMailBadge(doc.data().mailbox || []);
                }
            });
        }
    });

    // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆ ---
    let currentCharacterId = localStorage.getItem('selected_character_id') || 'komiya';
    function changeCharacter(id) {
        currentCharacterId = id;
        localStorage.setItem('selected_character_id', id);
        const img = document.querySelector('.character-stand');
        if (img && window.CHARACTERS[id]) img.src = window.CHARACTERS[id].image;
        switchModal('characterSettingsMenu', 'unifiedMenuModal');
    }

    function talkCharacter() {
        const bubble = document.getElementById("characterBubble");
        const char = window.CHARACTERS[currentCharacterId];
        if (!char) return;
        const msgs = char.base;
        bubble.textContent = msgs[Math.floor(Math.random() * msgs.length)].replace('{name}', document.getElementById("userNameDisplay").textContent);
        bubble.style.display = "block";
        setTimeout(() => bubble.style.display = "none", 3000);
    }
    
    // ãƒ¡ãƒ¼ãƒ«ãƒãƒƒã‚¸æ›´æ–°
    function updateMailBadge(mailbox) {
        const count = mailbox.filter(m => m.reward && !m.claimed).length;
        const badge = document.getElementById("mailBadge");
        badge.style.display = count > 0 ? "flex" : "none";
        badge.textContent = count;
    }

    function openMailbox() {
        openModal('mailboxModal');
        // è©³ç´°ãªãƒ¡ãƒ¼ãƒ«æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒæ§˜
    }
  </script>
</body>
</html>

