<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
Â  <title>ã—ãŠã‚„å°†æ£‹ - ãƒ›ãƒ¼ãƒ </title>
Â  <link rel="icon" href="script/image/komiya_icon.png">Â 
Â  <link rel="manifest" href="manifest.json">
Â  <link rel="apple-touch-icon" href="script/image/komiya_icon.png">
Â Â 
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
Â  <script src="/socket.io/socket.io.js"></script>

Â  <style>

Â  Â  @font-face {
Â  Â  Â  font-family: 'SetoFont';Â  /* å¥½ããªåå‰ã§OK */
Â  Â  Â  src: url('script/font/setofont.ttf') format('truetype'); /* ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ */
Â  Â  Â  font-display: block;
Â  Â  }

Â  Â  * {
Â  font-family: "SetoFont", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif !important;
}
Â  Â Â 
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  font-family: "SetoFont", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
Â  Â  Â  position: fixed;Â 
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;Â  Â /* vw, vh ã§ã¯ãªã % ã‚’ä½¿ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆ */
Â  Â  height: 100%;
Â  Â Â 
Â  Â  background-color: #2c3e50;
Â  Â  background-size: cover;
Â  Â  background-position: center;
Â  Â  overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å‡ºã•ãªã„ */

Â  Â  /* â˜…â˜…â˜… ã“ã“ãŒæœ€é‡è¦ï¼šã‚¹ãƒ¯ã‚¤ãƒ—ã«ã‚ˆã‚‹ç”»é¢é·ç§»ï¼ˆãƒã‚¦ãƒ³ã‚¹ï¼‰ã‚’ç¦æ­¢ã™ã‚‹ â˜…â˜…â˜… */
Â  Â  overscroll-behavior-x: none;Â 
Â  Â  overscroll-behavior-y: none;
Â  Â  overscroll-behavior: none;

Â  Â  -webkit-user-select: none;
Â  Â  -webkit-touch-callout: none;
Â  Â  user-select: none;
Â  Â  touch-action: none; /* ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ãªã©ã‚‚ç„¡åŠ¹åŒ– */
}

/* â˜…â˜…â˜… è¿½åŠ ï¼šhtmlã‚¿ã‚°ã«ã‚‚é©ç”¨ã—ãªã„ã¨åŠ¹ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ â˜…â˜…â˜… */
html {
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  overflow: hidden;
Â  Â  overscroll-behavior: none;
}

input, textarea {
Â  Â user-select: text;
Â  Â -webkit-user-select: text;
Â  Â touch-action: auto; /* ã“ã“ã‚‚å¿˜ã‚Œãšã«ï¼ */
Â }

/* èƒŒæ™¯å°‚ç”¨ã®è¨­å®š */
Â  Â  #bg-image {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100vw;
Â  Â  Â  height: 100vh;
Â  Â  Â  z-index: -1; /* ä»–ã®è¦ç´ ã‚ˆã‚ŠèƒŒé¢ã«é…ç½® */
Â  Â  Â  background-image: url('script/image/shogi_title.PNG');
Â  Â  Â  background-size: cover;
Â  Â  Â  background-position: center;
Â  Â  Â  background-repeat: no-repeat;
Â  Â  }
Â  Â  /* å¹ãå‡ºã—ã®è¨­å®š */
Â  Â  .speech-bubble {
Â  Â  Â  display: none;
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 30vh;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: #fff8dc;
Â  Â  Â  border: 3px solid #8b4513;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  min-width: 160px;
Â  Â  Â  max-width: 220px;
Â  Â  Â  color: #333;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  z-index: 100;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
Â  Â  Â  pointer-events: none;
Â  Â  Â  animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  Â  white-space: pre-wrap;
Â  Â  Â  line-height: 1.4;
Â  Â  }

Â  Â  .speech-bubble::after {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 100%;
Â  Â  Â  right: 20%;
Â  Â  Â  border-left: 10px solid transparent;
Â  Â  Â  border-right: 10px solid transparent;
Â  Â  Â  border-bottom: 15px solid #8b4513;
Â  Â  }

Â  Â  @keyframes pop-in {
Â  Â  Â  0% { transform: translateX(-50%) scale(0); opacity: 0; }
Â  Â  Â  100% { transform: translateX(-50%) scale(1); opacity: 1; }
Â  Â  }

Â  Â  .character-stand {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 0;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  height: 85vh;
Â  Â  Â  width: auto;
Â  Â  Â  max-width: 95%;
Â  Â  Â  z-index: 1;

Â  Â  Â  filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
Â  Â  Â  cursor: pointer;
Â  Â  Â  pointer-events: auto;
Â  Â  }

Â  Â  .user-info-bar {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px 20px;Â 
Â  Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  Â  color: white;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  z-index: 5;
Â  Â  }

Â  Â  .user-name { font-weight: bold; font-size: 1.1rem; }
Â  Â Â 
Â  Â  .top-btn {
Â  Â  Â  border: none;
Â  Â  Â  color: white;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 5px 15px;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  margin-left: 5px;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .stats-btn { background: #ff9800; }
Â  Â  .news-btn { background: #28a745; }

Â  Â  .bottom-menu {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 10px;
Â  Â  Â  width: 96%;
Â  Â  Â  left: 2%;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-around;
Â  Â  Â  align-items: flex-end;
Â  Â  Â  gap: 5px;
Â  Â  Â  z-index: 10;
Â  Â  }

Â  Â  .menu-btn {
Â  Â  Â  flex: 1;
Â  Â  Â  height: 60px;
Â  Â  Â  background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
Â  Â  Â  border: 2px solid white;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
Â  Â  Â  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
Â  Â  }
Â  Â  .menu-btn:active { transform: scale(0.95); }

Â  Â  .overlay {
Â  Â  Â  display: none;
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  background: rgba(0,0,0,0.7);
Â  Â  Â  z-index: 100;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  overscroll-behavior: none;
Â  Â  }

Â  Â  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  .modal-box {
Â  Â  position: relative;
Â  Â  background: #fff8dc;
Â  Â  padding: 15px;
Â  Â  border-radius: 10px;
Â  Â  border: 4px solid #8b4513;
Â  Â  text-align: center;
Â  Â  width: 80%;
Â  Â  max-width: 800px;
Â  Â Â 
Â  Â  /* â˜…â˜…â˜… ã“ã“ãŒé‡è¦ï¼šç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„è¨­å®š â˜…â˜…â˜… */
Â  Â  max-height: 85vh; /* ç”»é¢ã®é«˜ã•ã®85%ã¾ã§ã«åˆ¶é™ */
Â  Â  display: flex;Â  Â  /* ä¸­èº«ã‚’ç¸¦ä¸¦ã³ã®Flexãƒœãƒƒã‚¯ã‚¹ã«ã™ã‚‹ */
Â  Â  flex-direction: column; /* ç¸¦æ–¹å‘ã«ä¸¦ã¹ã‚‹ */
Â  Â  box-sizing: border-box;
}

Â  Â  .modal-body {
Â  Â  flex: 1;Â  Â  Â  Â  Â  Â  /* ä½™ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨éƒ¨ä½¿ã† */
Â  Â  overflow-y: auto;Â  Â /* ä¸­èº«ãŒæº¢ã‚ŒãŸã‚‰ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å‡ºã™ */
Â  Â  margin: 10px 0;Â  Â  Â /* ä¸Šä¸‹ã®ä½™ç™½ */
Â  Â  padding: 5px;Â  Â  Â  Â /* å†…å´ã®ä½™ç™½ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨æ–‡å­—ãŒè¢«ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
Â  Â Â 
Â  Â  /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®æ“ä½œæ€§ã‚’è‰¯ãã™ã‚‹è¨­å®š */
Â  Â  -webkit-overflow-scrolling: touch;Â 
}
Â  Â Â 
Â  Â  /* ãƒœã‚¿ãƒ³ã‚’2åˆ—ã«ä¸¦ã¹ã‚‹ãŸã‚ã®ã‚°ãƒªãƒƒãƒ‰è¨­å®š */
Â  Â  .modal-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  gap: 10px;
Â  Â  Â  margin: 10px 0;
Â  Â  }

Â  Â  .sub-btn {
Â  Â  Â  display: block;
Â  Â  Â  width: 100%;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 12px 5px;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  background: #8b4513;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .sub-btn:active { transform: scale(0.98); opacity: 0.9; }

Â  Â  /* ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  .close-small-btn {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 8px;
Â  Â  Â  right: 8px;
Â  Â  Â  padding: 4px 10px;
Â  Â  Â  background: #666;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  cursor: pointer;
Â  Â  Â  z-index: 101;
Â  Â  }

Â  Â  #lobbyChatTitle {
Â  Â  Â  color: #005bea;
Â  Â  Â  margin: 0 0 5px 0;
Â  Â  Â  text-align: left;
Â  Â  Â  padding-left: 5px;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  line-height: 1.5;
Â  Â  }

Â  Â  #lobbyChatHistory {
Â  Â  Â  flex: 1;Â 
Â  Â  Â  overflow-y: auto;
Â  Â  Â  background: rgba(255, 255, 255, 0.5);
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  padding: 8px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 5px;
Â  Â  Â  min-height: 100px;
Â  Â  }

Â  Â  .chat-input-area {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 5px;
Â  Â  Â  margin-top: 8px;
Â  Â  }

Â  Â  /* --- ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
Â  Â  .mail-btn {
Â  Â  Â  position: relative;
Â  Â  Â  background: #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
Â  Â  }
Â  Â Â 
Â  Â  /* æœªèª­ãƒãƒƒã‚¸ï¼ˆèµ¤ä¸¸ï¼‰ */
Â  Â  .notification-badge {
Â  Â  Â  position: absolute;
Â  Â  Â  top: -5px;
Â  Â  Â  right: -5px;
Â  Â  Â  background-color: red;
Â  Â  Â  color: white;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  font-weight: bold;
Â  Â  Â  border: 2px solid white;
Â  Â  Â  z-index: 10;
Â  Â  Â  display: none; /* åˆæœŸã¯éè¡¨ç¤º */
Â  Â  }

Â  Â  /* ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ */
Â  Â  #mailList {
Â  Â  Â  list-style: none;
Â  Â  Â  padding: 0;
Â  Â  Â  margin: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  .mail-item {
Â  Â  Â  background: white;
Â  Â  Â  border-bottom: 1px solid #ccc;
Â  Â  Â  padding: 15px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
Â  Â  .mail-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
Â  Â  .mail-item:last-child { border-bottom: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
Â  Â  .mail-item:active { background: #f0f0f0; }
Â  Â Â 
Â  Â  .mail-item.unread {
Â  Â  Â  background: #fff8dc; /* æœªèª­ã¯å°‘ã—é»„è‰²ã */
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .mail-item.unread::before {
Â  Â  Â  content: 'â—';
Â  Â  Â  color: #d35400;
Â  Â  Â  margin-right: 8px;
Â  Â  }

Â  Â  .mail-subject { font-size: 1rem; color: #333; flex: 1; }
Â  Â  .mail-date { font-size: 0.8rem; color: #888; margin-left: 10px; }

Â  Â  /* ãƒ¡ãƒ¼ãƒ«è©³ç´°ç”»é¢ */
Â  Â  #mailDetailView {
Â  Â  Â  display: none; /* åˆæœŸéè¡¨ç¤º */
Â  Â  Â  flex-direction: column;
Â  Â  Â  height: 100%;
Â  Â  Â  text-align: left;
Â  Â  }
Â  Â  .mail-header {
Â  Â  Â  border-bottom: 2px solid #8b4513;
Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }
Â  Â  .mail-detail-subject { font-size: 1.2rem; font-weight: bold; color: #8b4513; }
Â  Â  .mail-detail-date { font-size: 0.85rem; color: #666; margin-top: 5px; }
Â  Â  .mail-body {
Â  Â  Â  flex: 1;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  line-height: 1.6;
Â  Â  Â  white-space: pre-wrap; /* æ”¹è¡Œã‚’åæ˜  */
Â  Â  Â  background: rgba(255,255,255,0.6);
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  overflow-y: auto;
Â  Â  }
Â  Â  .mail-reward-area {
Â  Â  Â  margin-top: 15px;
Â  Â  Â  padding: 15px;
Â  Â  Â  background: #fff;
Â  Â  Â  border: 2px dashed #ff9800;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  /* --- å·¦å´ã®æµ®éŠãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ --- */
Â  Â  .right-side-menu {
Â  Â  Â  position: absolute;
Â  Â  Â  left: 15px;
Â  Â  Â  top: 100px; /* ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸‹ã‚ãŸã‚Š */
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 15px;
Â  Â  Â  z-index: 20; /* ã‚­ãƒ£ãƒ©ç”»åƒã‚ˆã‚Šæ‰‹å‰ã« */
Â  Â  }

Â  Â  .mission-main-btn {
Â  Â  Â  width: 70px;
Â  Â  Â  height: 70px;
Â  Â  Â  background: linear-gradient(to bottom, #fff176, #fbc02d); /* é‡‘è‰²ã£ã½ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
Â  Â  Â  border: 3px solid #fff;
Â  Â  Â  border-radius: 50%; /* ä¸¸ã„ãƒœã‚¿ãƒ³ */
Â  Â  Â  color: #5d4037;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  position: relative;
Â  Â  Â  animation: float-btn 3s infinite ease-in-out; /* ãµã‚ãµã‚å‹•ã */
Â  Â  }
Â  Â Â 
Â  Â  .mission-main-btn:active {
Â  Â  Â  transform: scale(0.95);
Â  Â  }

Â  Â  .mission-icon-emoji {
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  margin-bottom: 2px;
Â  Â  Â  display: block;
Â  Â  }

Â  Â  /* ãµã‚ãµã‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
Â  Â  @keyframes float-btn {
Â  Â  Â  0%, 100% { transform: translateY(0); }
Â  Â  Â  50% { transform: translateY(-5px); }
Â  Â  }

Â  Â  /* ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨ãƒãƒƒã‚¸ï¼ˆæœªé”æˆãƒ»å ±é…¬ã‚ã‚Šã®æ•°ãªã©ï¼‰ */
Â  Â  .mission-badge {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  right: 0;
Â  Â  Â  background-color: #d32f2f;
Â  Â  Â  color: white;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 22px;
Â  Â  Â  height: 22px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  border: 2px solid white;
Â  Â  Â  font-weight: bold;
Â  Â  Â  display: none; /* JSã§åˆ¶å¾¡ */
Â  Â  }

Â  Â  /* --- æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆå³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ï¼‰ --- */
Â  Â  .mail-main-btn {
Â  Â  Â  width: 70px;
Â  Â  Â  height: 70px;
Â  Â  Â  background: linear-gradient(to bottom, #ffcc80, #ef6c00); /* ã‚ªãƒ¬ãƒ³ã‚¸ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
Â  Â  Â  border: 3px solid #fff;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  color: #fff;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  position: relative;
Â  Â  Â  animation: float-btn 3s infinite ease-in-out;
Â  Â  Â  animation-delay: 1.5s; /* ä»»å‹™ãƒœã‚¿ãƒ³ã¨å‹•ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã‚ºãƒ©ã™ */
Â  Â  }
Â  Â Â 
Â  Â  .mail-main-btn:active {
Â  Â  Â  transform: scale(0.95);
Â  Â  }

Â  Â  .mail-icon-emoji {
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  margin-bottom: 2px;
Â  Â  Â  display: block;
Â  Â  }

Â  Â  /* â˜…â˜…â˜… ãƒ¡ãƒ¼ãƒ«ã®çŠ¶æ…‹ã”ã¨ã®è‰²åˆ†ã‘ â˜…â˜…â˜… */
Â  Â  /* 1. æ·»ä»˜ã‚ã‚Šãƒ»æœªå—ã‘å–ã‚Šï¼ˆè–„ã„é’ï¼‰ */
Â  Â  .mail-item.type-reward-active {
Â  Â  Â  background-color: #e3f2fd;
Â  Â  Â  border-left: 5px solid #2196f3; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
Â  Â  }
Â  Â Â 
Â  Â  /* 2. æ·»ä»˜ã‚ã‚Šãƒ»å—å–æ¸ˆã¿ï¼ˆè–„ã„ç°è‰²ï¼‰ */
Â  Â  .mail-item.type-reward-claimed {
Â  Â  Â  background-color: #f5f5f5;
Â  Â  Â  color: #888;
Â  Â  Â  border-left: 5px solid #bdbdbd;
Â  Â  }

Â  Â  /* 3. æ·»ä»˜ãªã—ï¼ˆè–„ã„èµ¤ï¼‰ */
Â  Â  .mail-item.type-normal {
Â  Â  Â  background-color: #ffebee;
Â  Â  Â  border-left: 5px solid #ef5350;
Â  Â  }

Â  Â  /* ãƒãƒ£ãƒƒãƒˆå¹ãå‡ºã—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³é–¢é€£ */
Â  Â  .chat-row { display: flex; align-items: flex-start; gap: 10px; max-width: 95%; }
Â  Â  .chat-row.mine { align-self: flex-end; flex-direction: row-reverse; }
Â  Â  .icon-container { display: flex; flex-direction: column; align-items: center; width: 60px; }
Â  Â  .chat-name-badge {
Â  Â  /* æ è‡ªä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  background: #fff;
Â  Â  border: 1px solid #8b4513;
Â  Â  border-radius: 10px;
Â  Â  z-index: 2;
Â  Â  margin-bottom: -10px;
Â  Â Â 
Â  Â  /* â˜…â˜…â˜… ã“ã“ãŒé‡è¦ï¼šã‚µã‚¤ã‚ºã‚’å›ºå®šã™ã‚‹ â˜…â˜…â˜… */
Â  Â  width: 60px;Â  Â  Â  Â  /* å¹…ã‚’å›ºå®š */
Â  Â  height: 18px;Â  Â  Â  Â /* é«˜ã•ã‚’å›ºå®š */
Â  Â  display: flex;Â  Â  Â  /* ä¸­èº«ï¼ˆSVGï¼‰ã‚’ä¸­å¤®å¯„ã› */
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  padding: 0 4px;Â  Â  Â /* å·¦å³ã«å°‘ã—ä½™ç™½ */
Â  Â  overflow: hidden;Â  Â /* ã¯ã¿å‡ºã—é˜²æ­¢ï¼ˆå¿µã®ãŸã‚ï¼‰ */
}

Â  Â  .chat-name-text {
Â  Â  font-size: 12px;Â  Â  Â  Â /* åŸºæº–ã®æ–‡å­—ã‚µã‚¤ã‚º */
Â  Â  font-weight: bold;
Â  Â  fill: #333;Â  Â  Â  Â  Â  Â  /* æ–‡å­—è‰² */
Â  Â  text-anchor: middle;Â  Â /* ä¸­å¤®æƒãˆ */
Â  Â  dominant-baseline: central; /* ä¸Šä¸‹ä¸­å¤®æƒãˆ */
}
Â  Â  .chat-icon-img { width: 50px; height: 50px; border: 3px solid #56ab2f; border-radius: 12px; background: #fff; object-fit: cover; }
Â  Â  .chat-row.mine .chat-icon-img { border: 3px solid #FFA500; }
Â  Â  .chat-bubble { position: relative; padding: 10px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; word-break: break-all; }
Â  Â  .chat-row .chat-bubble { background: #fff; border: 2px solid #e0e0e0; border-top-left-radius: 0; }
Â  Â  .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; border-top-right-radius: 0; }

Â  Â  /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
Â  Â  .offline-color { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%) !important; }
Â  Â  .online-color { background: linear-gradient(to bottom, #ff758c 0%, #ff7eb3 100%) !important; }
Â  Â  .mypage-color { background: linear-gradient(to bottom, #f6d365 0%, #fda085 100%) !important; }
Â  Â  .ready-color { background: linear-gradient(to bottom, #a8e063 0%, #56ab2f 100%) !important; }
Â  Â  .chat-color { background: linear-gradient(to bottom, #da92ec 0%, #a06ee1 100%) !important; }

Â  Â  /* â˜…â˜…â˜… è¿½åŠ ï¼šãƒãƒ£ãƒƒãƒˆã¨ãƒ¡ãƒ¼ãƒ«ã®ç”»é¢ã‚’æœ€å¤§ã‚µã‚¤ã‚ºã«å›ºå®šã™ã‚‹ â˜…â˜…â˜… */
Â  Â  #lobbyChatModal .modal-box,
Â  Â  #mailboxModal .modal-box {
Â 
Â  Â  Â  height: 85vh;Â  Â  Â  Â /* ç¸¦å¹…ã„ã£ã±ã„ï¼ˆç”»é¢ã®85%ï¼‰ */
Â  Â  Â  max-width: 800px;Â  Â /* PCã§è¦‹ã¦ã‚‚åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â Â 
Â  Â  /* ãƒ¢ãƒã‚¤ãƒ«æ¨ªå‘ãèª¿æ•´ */
Â  Â  @media screen and (max-height: 450px) {
Â  Â  Â  .modal-box { padding: 10px; }
Â  Â  Â  #lobbyChatHistory { padding: 8px; }
Â  Â  }

Â  Â  /* â˜…è¿½åŠ ï¼šãƒ­ãƒ¼ãƒ‰ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#loading-screen {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background-color: #2c3e50;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  transition: opacity 0.5s ease;
  visibility: visible; /* æœ€åˆã¯è¡¨ç¤ºï¼ˆèƒŒæ™¯è‰²ã ã‘è¦‹ãˆã‚‹ï¼‰ */
}

.loader-content {
  text-align: center;
  color: white;
  visibility: hidden; /* â˜…ãƒ•ã‚©ãƒ³ãƒˆãŒæ¥ã‚‹ã¾ã§ä¸­èº«ã‚’éš ã™ */
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* â˜…ã‚¯ãƒ©ã‚¹åã‚’ font-ready ã«çµ±ä¸€ */
#loading-screen.font-ready .loader-content {
  visibility: visible;
  opacity: 1;
}

.loader-content {
  text-align: center;
  color: white;
  visibility: hidden; /* â˜…æœ€åˆã¯éš ã™ */
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* ãã‚‹ãã‚‹å›ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.spinner {
Â  width: 50px;
Â  height: 50px;
Â  border: 5px solid rgba(255, 255, 255, 0.3);
Â  border-top: 5px solid #fff;
Â  border-radius: 50%;
Â  animation: spin 1s linear infinite;
Â  margin: 0 auto 15px;
}

@keyframes spin {
Â  0% { transform: rotate(0deg); }
Â  100% { transform: rotate(360deg); }
}

Â  Â  /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãµã‚ãµã‚æµ®ã‹ã›ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.loading-char {
Â  width: 80px;
Â  height: 80px;
Â  margin-bottom: 20px;
Â  filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
Â  animation: float 2s infinite ease-in-out;
}

@keyframes float {
Â  0%, 100% { transform: translateY(0); }
Â  50% { transform: translateY(-10px); }
}

/* ãƒãƒƒãƒ—ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
#loading-tips {
Â  margin-top: 20px;
Â  padding: 10px 20px;
Â  background: rgba(255, 255, 255, 0.1);
Â  border-radius: 10px;
Â  font-size: 0.9rem;
Â  max-width: 250px;
Â  line-height: 1.5;
Â  min-height: 3em; /* é«˜ã•ã‚’ç¢ºä¿ã—ã¦ã‚¬ã‚¿ã¤ãã‚’é˜²æ­¢ */
}
Â  Â Â 
Â  </style>

</head>
<body>

Â  <div id="loading-screen">
    <div class="loader-content">
      <img src="script/image/komiya_icon.png" class="loading-char" alt="Loading">
      <div class="spinner"></div>
      <div id="loading-tips"></div>
      <p style="font-size: 0.7rem; opacity: 0.6; margin-top:10px;">LOADING...</p>
    </div>
  </div>

  <script>
    // --- ãƒ­ãƒ¼ãƒ‰ç”»é¢å°‚ç”¨ï¼šHTMLã®è§£æç›´å¾Œã«å®Ÿè¡Œ ---
    (function() {
        const tips = [
            "ã€tipsã€‘ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¯ãã‚Œãã‚Œå›ºæœ‰ã®å¿…æ®ºæŠ€ãŒã‚ã‚Šã¾ã™ã€‚",
            "ã€tipsã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ã¯ã€å…ˆã«å…¥å®¤ã—ãŸæ–¹ãŒå…ˆæ‰‹ã«ãªã‚Šã¾ã™ã€‚",
            "ã€tipsã€‘ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰BGMã®å¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚"
        ];
        const tipEl = document.getElementById('loading-tips');
        if (tipEl) tipEl.textContent = tips[Math.floor(Math.random() * tips.length)];

        // ç€¬æˆ¸ãƒ•ã‚©ãƒ³ãƒˆãŒæº–å‚™ã§ããŸã‚‰ã€Œä¸­èº«ã€ã‚’ãµã‚ã£ã¨å‡ºã™
        document.fonts.ready.then(function() {
            document.getElementById('loading-screen').classList.add('font-ready');
        });

        // ç”»é¢å…¨ä½“ãŒèª­ã¿çµ‚ã‚ã£ãŸã‚‰ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’æ¶ˆã™
        window.addEventListener('load', function() {
            const loader = document.getElementById('loading-screen');
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            }, 800);
        });
    })();
  </script>

  <div id="bg-image"></div>



Â Â 


Â  <div class="user-info-bar">
Â  Â  <div>
Â  Â  Â  <span id="userNameDisplay" class="user-name">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“
Â  Â  Â  <button id="editNameBtn" onclick="showNameEditModal()" style="display:none; background:none; border:none; cursor:pointer; font-size:1rem;">âœï¸</button>
Â  Â  Â Â 
Â  Â  Â  <span style="margin-left: 15px; font-weight: bold; color: #ffd700; text-shadow: 1px 1px 2px #000;">
Â  Â  Â  Â  ğŸ’° <span id="userGoldDisplay">0</span> G
Â  Â  Â  </span>
Â  Â  </div>

Â  Â  <div></div>
Â  </div>

Â  <div class="right-side-menu">
Â  Â  <button class="mail-main-btn" onclick="openMailbox()">
Â  Â  Â  <span class="mail-icon-emoji">âœ‰</span>
Â  Â  Â  <div>ãƒ¡ãƒ¼ãƒ«</div>
Â  Â  Â  <span id="mailBadge" class="notification-badge">0</span>
Â  Â  </button>
Â  Â  <button class="mission-main-btn" onclick="window.location.href='mission.html'">
Â  Â  Â  <span class="mission-icon-emoji">ğŸ“œ</span>
Â  Â  Â  <div>ç›®æ¨™</div>
Â  Â  Â  <span id="missionBadge" class="mission-badge">!</span>
Â  Â  </button>
Â  </div>

Â  <div id="characterBubble" class="speech-bubble"></div>

Â  <img class="character-stand" src="script/image/komiya_touka.png" alt="Character" onclick="talkCharacter()">

Â  <div class="bottom-menu">
Â  Â  <button class="menu-btn offline-color" onclick="openModal('offlineMenu')">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</button>
Â  Â Â 
Â  Â  <button onclick="goToCharacterSelect('online')" class="menu-btn online-color">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</button>
Â  Â Â 
Â  Â  <button class="menu-btn chat-color" onclick="openLobbyChat()">ãƒãƒ£ãƒƒãƒˆ</button>
Â  Â Â 
Â  Â  <button class="menu-btn ready-color" onclick="window.location.href='shop.html'">ã‚·ãƒ§ãƒƒãƒ—</button>
Â  Â Â 
Â  Â Â 
Â  Â Â 
Â  Â  <button class="menu-btn mypage-color" onclick="window.location.href='mypage.html'">æ£‹è­œ</button>
Â  Â Â 
Â  Â  <button class="menu-btn" style="background: linear-gradient(to bottom, #607d8b 0%, #455a64 100%);" onclick="openModal('unifiedMenuModal')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
Â  </div>

Â  <div id="unifiedMenuModal" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
Â  Â  Â  <div class="modal-grid">
Â  Â  Â  Â  <button class="sub-btn" style="background: linear-gradient(to bottom, #FF9800 0%, #F57C00 100%);" onclick="window.location.href='inventory.html'">ğŸ’ æ‰€æŒå“</button>
Â  Â  Â  Â  <button class="sub-btn" style="background: #e91e63;" onclick="switchModal('unifiedMenuModal', 'characterSettingsMenu')">ğŸ‘¤ ã‚­ãƒ£ãƒ©</button>
Â  Â  Â  Â  <button class="sub-btn" style="background: #ff9800;" onclick="showMyStats()">ğŸ“Š æˆ¦ç¸¾</button>
Â  Â  Â  Â  <button class="sub-btn" style="background: #17a2b8;" onclick="switchModal('unifiedMenuModal', 'helpMainMenu')">â“ ãƒ˜ãƒ«ãƒ—</button>
Â  Â  Â  Â  <button class="sub-btn" style="background: #6f42c1;" onclick="switchModal('unifiedMenuModal', 'helpContact')">ğŸ”§ ä¸å…·åˆ</button>
Â  Â  Â  Â  <button class="sub-btn" style="background: #6c757d;" onclick="switchModal('unifiedMenuModal', 'settingsMainMenu')">âš™ï¸ è¨­å®š</button>
Â  Â  Â  </div>
Â  Â  Â  <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('unifiedMenuModal')">é–‰ã˜ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="newsModal" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color:#d35400; margin-top:0;">ğŸ”” æœ€æ–°æƒ…å ±</h3>
Â  Â  Â  <div style="text-align: left; margin: 20px 0; line-height: 1.6; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;">
Â  Â  Â  Â  ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ å®Ÿè£…ï¼<br>
Â  Â  Â  Â  ãƒ»ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ è¿½åŠ ï¼<br>
Â  Â  Â  Â  ãƒ»æ£‹è­œè§£ææ©Ÿèƒ½ å®Ÿè£…ï¼<br>
Â  Â  Â  Â  ãƒ»æœ€å¼·CPUå®Ÿè£…ï¼
Â  Â  Â  </div>
Â  Â  Â  <button onclick="closeModal('newsModal')" style="background: #ccc; border: none; color: black; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="settingsMainMenu" class="overlay">
Â  <div class="modal-box">
Â  Â  <h3 style="color: #8b4513; margin-top: 0;">è¨­å®š</h3>
Â  Â  <div class="modal-grid">
Â  Â  Â  <button class="sub-btn" style="background: #e91e63;" onclick="switchModal('settingsMainMenu', 'characterSettingsMenu')">ã‚­ãƒ£ãƒ©è¨­å®š</button>
Â  Â  Â Â 
Â  Â  Â  <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'volumeMenu')">éŸ³é‡è¨­å®š</button>
Â  Â  Â  <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'languageMenu')">è¨€èªè¨­å®š</button>
Â  Â  Â  <button class="sub-btn" onclick="openAccountFromSettings()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
Â  Â  </div>
Â  Â  <button class="sub-btn" style="background:#666;" onclick="closeModal('settingsMainMenu')">é–‰ã˜ã‚‹</button>
Â  </div>
</div>

<div id="volumeMenu" class="overlay">
Â  <div class="modal-box">
Â  Â  <h3 style="color: #8b4513; margin-top: 0;">éŸ³é‡è¨­å®š</h3>
Â  Â  <div style="margin: 20px 0;">
Â  Â  Â  <p>BGM</p><input type="range" style="width:80%;">
Â  Â  Â  <p>åŠ¹æœéŸ³</p><input type="range" style="width:80%;">
Â  Â  </div>
Â  Â  <button class="sub-btn" style="background:#666;" onclick="switchModal('volumeMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
Â  </div>
</div>

<div id="languageMenu" class="overlay">
Â  <div class="modal-box">
Â  Â  <h3 style="color: #8b4513; margin-top: 0;">è¨€èªè¨­å®š / Language</h3>
Â  Â  <div class="modal-grid">
Â  Â  Â  <button class="sub-btn">æ—¥æœ¬èª</button>
Â  Â  Â  <button class="sub-btn" style="background:#555;">ã‚¹ãƒ¯ãƒ’ãƒªèªï¼ˆæº–å‚™ä¸­ï¼‰</button>
Â  Â  </div>
Â  Â  <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="switchModal('languageMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
Â  </div>
</div>

Â 
<div id="authModal" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â Â 
Â  Â  Â  <h2 id="authTitle" style="margin-top: 0; color: #8b4513; flex-shrink: 0;">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
Â  Â  Â Â 
Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="authInputs">
Â  Â  Â  Â  Â  <div style="text-align: left; margin: 15px 0;">
Â  Â  Â  Â  Â  Â  <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><br>
Â  Â  Â  Â  Â  Â  <input type="email" id="authEmail" placeholder="example@mail.com" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="text-align: left; margin: 15px 0;">
Â  Â  Â  Â  Â  Â  <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label><br>
Â  Â  Â  Â  Â  Â  <input type="password" id="authPass" placeholder="******" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  <button onclick="loginUser()" style="background: #007bff; color: white; width: 45%; height: 45px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
Â  Â  Â  Â  Â  Â  <button onclick="registerUser()" style="background: #28a745; color: white; width: 45%; height: 45px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">æ–°è¦ç™»éŒ²</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:20px; padding-top:10px;">
Â  Â  <button id="logoutBtnInModal" onclick="logoutUser(); closeAuthModal()" style="display:none; background: #6c757d; border:none; border-radius:5px; color: white; width: 100%; height: 40px; font-weight:bold;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

Â  Â  Â  </div> <div style="margin-top: 0; border-top: 1px solid #ccc; padding-top: 15px; flex-shrink: 0;">
Â  Â  Â  Â  <button onclick="closeAuthModal()" style="background: #ccc; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; font-weight:bold;">ã‚‚ã©ã‚‹</button>
Â  Â  Â  </div>

Â  Â  </div>
Â  </div>

Â  <div id="nameEditModal" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">åå‰ã‚’å¤‰æ›´</h3>
Â  Â  Â  <div style="margin: 20px 0;">
Â  Â  Â  Â  <input type="text" maxlength="8" id="newNameInput" style="width: 80%; padding: 10px; font-size: 16px; border: 2px solid #8b4513; border-radius: 5px; text-align: center;">
Â  Â  Â  </div>
Â  Â  Â  <div style="display: flex; justify-content: space-around; gap: 10px;">
Â  Â  Â  Â  <button onclick="saveNewName()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">æ±ºå®š</button>
Â  Â  Â  Â  <button onclick="closeNameEditModal()" style="background: #ccc; color: black; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="statsModal" class="overlay">
Â  Â  <div class="modal-box" style="max-height: 80vh; display: flex; flex-direction: column;">
Â  Â  Â  <h2 style="margin-top: 0; color: #8b4513;">ã‚ãªãŸã®æˆ¦ç¸¾</h2>
Â  Â  Â  <div style="display: flex; justify-content: space-around; font-size: 24px; margin-bottom: 15px;">
Â  Â  Â  Â  <div style="color: red;">å‹: <span id="statsWin">0</span></div>
Â  Â  Â  Â  <div style="color: blue;">æ•—: <span id="statsLose">0</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div style="text-align: left; background: white; border: 1px solid #ccc; flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px;">
Â  Â  Â  Â  <ul id="statsHistory" style="list-style: none; padding: 0; margin: 0;"></ul>
Â  Â  Â  </div>
Â  Â  Â  <button onclick="closeStatsModal()" style="background: #ccc; border: none; color: black; padding: 10px;">é–‰ã˜ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="lobbyChatModal" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <button class="close-small-btn" onclick="closeModal('lobbyChatModal')">é–‰ã˜ã‚‹</button>
Â  Â  Â Â 
Â  Â  Â  <h3 id="lobbyChatTitle">ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</h3>
Â  Â  Â Â 
Â  Â  Â  <div id="lobbyChatHistory"></div>
Â  Â  Â Â 
Â  Â  Â  <div class="chat-input-area">
Â  Â  Â  Â  <input type="text" id="lobbyChatInput" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; font-size: 16px;">
Â  Â  Â  Â  <button onclick="sendLobbyMessage()" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; font-weight:bold;">é€ä¿¡ã™ã‚‹</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="practiceMenu" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">ç·´ç¿’ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
Â  Â  Â  <div class="modal-grid"> <button class="sub-btn" onclick="startGame('saijaku')">ãŸã‚ã‚€ã‚Œ (æœ€å¼±)</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="startGame('easy')">ãŠã‚ãã³ (å…¥é–€)</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="startGame('normal')">ãŸã—ãªã¿ (æ™®é€š)</button>
Â  Â  Â  </div> <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('practiceMenu')">é–‰ã˜ã‚‹</button>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div id="onePlayerModeSelect" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">å¯¾å±€ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
Â  Â  Â  <div class="modal-grid"> <button class="sub-btn" onclick="startGame('hard1')">ã“ã¿ã‚„</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="startGame('hard2')">ã—ãŠã‚„</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="startGame('ex_hard1')">ã“ã¿ã‚„EX</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="startGame('ex_hard2')">ã—ãŠã‚„EX</button>
Â  Â  Â  </div> <button class="sub-btn" style="background:#d35400; margin-top: 5px;" onclick="startGame('ex_hard3')">æœ€å¼·AIï¼ˆPCé™å®šï¼‰</button>
Â  Â  Â  <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('onePlayerModeSelect')">é–‰ã˜ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="helpMainMenu" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #17a2b8; margin-top: 0;">ãƒ˜ãƒ«ãƒ—</h3>
Â  Â  Â  <div class="modal-grid">
Â  Â  Â  Â  <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpMode')">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpDifficulty')">é›£æ˜“åº¦ã«ã¤ã„ã¦</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpChar')">ã‚­ãƒ£ãƒ©ã«ã¤ã„ã¦</button>
Â  Â  Â  Â  <button class="sub-btn" style="background: #6f42c1;" onclick="switchModal('helpMainMenu', 'helpContact')">ä¸å…·åˆãƒ»è¦æœ›</button>
Â  Â  Â  </div>
Â  Â  Â  <button class="sub-btn" style="background:#666;" onclick="closeModal('helpMainMenu')">é–‰ã˜ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="helpMode" class="overlay">
Â  Â  <div class="modal-box" style="max-width: 350px;">
Â  Â  Â  <h3 style="color: #8b4513;">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</h3>
Â  Â  Â  <div style="text-align: left; font-size: 0.85rem; line-height: 1.5; overflow-y: auto; max-height: 50vh;">
Â  Â  Â  Â  <p><strong>ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆã‚Œã‚“ã—ã‚…ã†ï¼ã²ã¨ã‚Šã§ï¼ãµãŸã‚Šã§ï¼‰</strong><br>CPUã¨ã®å¯¾å±€ãŒã§ãã¾ã™ã€‚ã“ã®ç«¯æœ«ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒå£«ã§ã‚‚å¯¾å±€ãŒã§ãã¾ã™ã€‚</p>
Â  Â  Â  Â  <p><strong>ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</strong><br>é ãã«ã„ã‚‹äººã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ãŒã§ãã¾ã™ã€‚å…ˆã«å…¥å®¤ã—ãŸäººãŒå…ˆæ‰‹ã«ãªã‚Šã¾ã™ã€‚</p>
Â  Â  Â  Â  <p><strong>ãƒ»ãƒãƒ£ãƒƒãƒˆ</strong><br>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ­ãƒ“ãƒ¼ã«ã„ã‚‹äººãŸã¡ã¨ä¼šè©±ãŒã§ãã¾ã™ã€‚</p> <p><strong>ãƒ»è§£æ</strong><br>æ£‹è­œã‚’è²¼ã‚Šä»˜ã‘ã¦ã€è§£æã‚„æŒ¯ã‚Šè¿”ã‚ŠãŒã§ãã¾ã™ã€‚</p>
Â  Â  Â  Â  <p><strong>ãƒ»æ£‹è­œ</strong><br>è‡ªèº«ã®éå»ã®æ£‹è­œãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚è§£æã‚„æŒ¯ã‚Šè¿”ã‚Šã‚‚ã§ãã¾ã™ã€‚â€»ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚â€»PCé™å®šã®æ©Ÿèƒ½ã§ã™ã€‚</p>
Â  Â  Â  </div>
Â  Â  Â  <button class="sub-btn" style="background:#666;" onclick="switchModal('helpMode', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="helpDifficulty" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #8b4513; margin: 0 0 10px 0;">é›£æ˜“åº¦ã«ã¤ã„ã¦</h3>
Â  Â  Â Â 
Â  Â  Â  <div style="text-align: left; font-size: 0.85rem; line-height: 1.4;">
Â  Â  Â  Â  <p style="margin: 0 0 5px 0;">CPUã®é›£æ˜“åº¦ã¯ã€ä¸‹ã«è¡Œãã»ã©å¼·ã„ã§ã™ã€‚</p>
Â  Â  Â  Â  <ul style="padding-left: 20px; margin: 0 0 10px 0;">
Â  Â  Â  Â  Â  <li>ãŸã‚ã‚€ã‚Œ</li>
Â  Â  Â  Â  Â  <li>ãŠã‚ãã³</li>
Â  Â  Â  Â  Â  <li>ãŸã—ãªã¿</li>
Â  Â  Â  Â  Â  <li>ã—ãŠã‚„ / ã“ã¿ã‚„</li>
Â  Â  Â  Â  Â  <li>ã—ãŠã‚„EX / ã“ã¿ã‚„EX</li>
Â  Â  Â  Â  Â  <li style="font-weight: bold; color: #d35400;">è©¦é¨“å®Ÿè£…ï¼ˆæœ€å¼·ï¼‰</li>
Â  Â  Â  Â  </ul>
Â  Â  Â  Â  <p style="margin: 0; font-size: 0.75rem;">â€»ã—ãŠã‚„ç³»ã¨ã“ã¿ã‚„ç³»ã®å¼·ã•ã¯åŒã˜ã§ã™ãŒã€æ€§æ ¼ãŒç•°ãªã‚Šã¾ã™ã€‚</p>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <button class="sub-btn" style="background:#666; margin: 15px 0 0 0;" onclick="switchModal('helpDifficulty', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="helpChar" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #8b4513;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¤ã„ã¦</h3>
Â  Â  Â  <div style="text-align: left; font-size: 0.9rem; line-height: 1.6;">
Â  Â  Â  Â  <p>ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å¯¾å±€å‰ã«è‡ªèº«ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚</p>
Â  Â  Â  Â  <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ãã‚Œãã‚Œç‹¬è‡ªã®<strong>ã€Œå¿…æ®ºæŠ€ã€</strong>ã‚’æŒã£ã¦ãŠã‚Šã€å¯¾å±€ã‚’æœ‰åˆ©ã«é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
Â  Â  Â  </div>
Â  Â  Â  <button class="sub-btn" style="background:#666;" onclick="switchModal('helpChar', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="helpContact" class="overlay">
Â  <div class="modal-box">
Â  Â  <h3 style="color: #8b4513;">ä¸å…·åˆãƒ»ã”è¦æœ›</h3>
Â  Â  <div style="margin: 20px 0; line-height: 1.6;">
Â  Â  Â  <p>ã“ã¡ã‚‰ã‹ã‚‰ã„ã¤ã§ã‚‚å—ã‘ä»˜ã‘ã¦ãŠã‚Šã¾ã™ã€‚<br>ã¾ãŸã¯ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
Â  Â  Â  <button class="sub-btn" style="background: #28a745; margin-top: 10px;"Â 
Â  Â  Â  Â  onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSc5Ry7hikuBYzDp7lTVLtO74zWabVlvvsjc3a0HgqrIuT8Dww/viewform', '_blank')">
Â  Â  Â  Â  å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã â†—
Â  Â  Â  </button>
Â  Â  </div>
Â  Â  <button class="sub-btn" style="background:#666;" onclick="closeModal('helpContact')">é–‰ã˜ã‚‹</button>
Â  </div>
</div>

Â  <div id="offlineMenu" class="overlay">
Â  Â  <div class="modal-box">
Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å±€</h3>
Â  Â  Â  <div class="modal-grid"> <button class="sub-btn" onclick="goToCharacterSelect('practice')">ã‚Œã‚“ã—ã‚…ã†</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="goToCharacterSelect('cpu')">ã²ã¨ã‚Šã§</button>
Â  Â  Â  Â  <button class="sub-btn" onclick="goToCharacterSelect('pvp')">ãµãŸã‚Šã§</button>
Â  Â  Â  </div> <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('offlineMenu')">æˆ»ã‚‹</button>
Â  Â  </div>
Â  </div>

Â  <div id="systemAlertModal" class="overlay" style="z-index: 200;">
Â  Â  <div class="modal-box" style="max-width: 400px;">
Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">ãŠçŸ¥ã‚‰ã›</h3>
Â  Â  Â  <p id="sysAlertMsg" style="margin: 20px 0; line-height: 1.5; white-space: pre-wrap;"></p>
Â  Â  Â  <button id="sysAlertBtn" style="background: #28a745; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">OK</button>
Â  Â  </div>
Â  </div>

Â  <div id="systemConfirmModal" class="overlay" style="z-index: 200;">
Â  Â  <div class="modal-box" style="max-width: 400px;">
Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">ç¢ºèª</h3>
Â  Â  Â  <p id="sysConfirmMsg" style="margin: 20px 0; line-height: 1.5; white-space: pre-wrap;"></p>
Â  Â  Â  <div style="display: flex; justify-content: center; gap: 20px;">
Â  Â  Â  Â  <button id="sysConfirmYesBtn" style="background: #007bff; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">ã¯ã„</button>
Â  Â  Â  Â  <button id="sysConfirmNoBtn" style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">ã„ã„ãˆ</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="characterSettingsMenu" class="overlay">
Â  <div class="modal-box">
Â  Â  <h3 style="color: #8b4513; margin-top: 0;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h3>
Â  Â  <p style="font-size:0.9rem;">ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’é¸ã¹ã¾ã™</p>
Â  Â Â 
Â  Â  <div class="modal-grid">
Â  Â  Â  <button class="sub-btn" onclick="changeCharacter('komiya')">ã‚­ãƒ£ãƒ©A</button>
Â  Â  Â  <button class="sub-btn" onclick="changeCharacter('a')">ã‚­ãƒ£ãƒ©B</button>
Â  Â  Â  <button class="sub-btn" onclick="changeCharacter('b')">ã‚­ãƒ£ãƒ©C</button>
Â  Â  Â  <button class="sub-btn" onclick="changeCharacter('d')">ã‚­ãƒ£ãƒ©D</button>
Â  Â  </div>
Â  Â Â 
Â  Â  <button class="sub-btn" style="background:#666;" onclick="closeModal('characterSettingsMenu')">é–‰ã˜ã‚‹</button>
Â  </div>
</div>

Â  <div id="mailboxModal" class="overlay">
Â  Â <div class="modal-box">
Â  Â  Â Â 
Â  Â  Â  <div id="mailListView" style="display: flex; flex-direction: column; height: 100%;">
Â  Â  Â  Â  <h3 style="color: #8b4513; margin-top: 0;">å—ä¿¡ãƒˆãƒ¬ã‚¤</h3>
Â  Â  Â  Â  <div class="modal-body" style="background: #eee; border-radius: 5px; padding: 0;">
Â  Â  Â  Â  Â  <ul id="mailList">
Â  Â  Â  Â  Â  Â  <li style="padding:20px; color:#666;">èª­ã¿è¾¼ã¿ä¸­...</li>
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  <div id="noMailMsg" style="display:none; padding:20px; color:#666;">ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="sub-btn" style="background:#666; margin-top:10px;" onclick="closeModal('mailboxModal')">é–‰ã˜ã‚‹</button>
Â  Â  Â  </div>

Â  Â  Â  <div id="mailDetailView">
Â  Â  Â  Â  <div class="mail-header">
Â  Â  Â  Â  Â  <div class="mail-detail-subject" id="detailSubject">ä»¶å</div>
Â  Â  Â  Â  Â  <div class="mail-detail-date" id="detailDate">æ—¥ä»˜</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mail-body" id="detailBody">
Â  Â  Â  Â  Â  æœ¬æ–‡
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="rewardArea" class="mail-reward-area">
Â  Â  Â  Â  Â  <div style="font-weight:bold; margin-bottom:5px;">ğŸ æ·»ä»˜ã‚¢ã‚¤ãƒ†ãƒ </div>
Â  Â  Â  Â  Â  <div id="rewardContent" style="color:#d35400; font-size:1.1rem; margin-bottom:10px;">1000 G</div>
Â  Â  Â  Â  Â  <button id="claimRewardBtn" class="sub-btn" style="background: #28a745;">å—ã‘å–ã‚‹</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button class="sub-btn" style="background:#666; margin-top:10px;" onclick="backToMailList()">æˆ»ã‚‹</button>
Â  Â  Â  </div>

Â  Â  </div>
Â  </div>

Â  <script src="script/missions.js"></script>
Â  <script src="script/serifu/komiya.js"></script>
<script src="script/serifu/a.js"></script>
<script src="script/serifu/b.js"></script>
<script src="script/serifu/d.js"></script>
Â  <script src="script/auth.js"></script>
Â  <script>

Â  Â Â 
Â  Â  // --- â˜…â˜…â˜… ä¿®æ­£ç‚¹ï¼šSocket.ioåˆæœŸåŒ– â˜…â˜…â˜… ---
Â  Â  let socket = null;

Â  Â  try {
Â  Â  Â  Â  socket = io();
Â  Â  } catch(e) {
Â  Â  Â  Â  console.log("ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ");
Â  Â  }

Â  Â  // --- ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ---
Â  Â  function showSystemAlert(msg, callback) {
Â  Â  Â  Â  document.getElementById("sysAlertMsg").textContent = msg;
Â  Â  Â  Â  const modal = document.getElementById("systemAlertModal");
Â  Â  Â  Â  modal.style.display = "flex";
Â  Â  Â  Â  const btn = document.getElementById("sysAlertBtn");
Â  Â  Â  Â  btn.onclick = function() {
Â  Â  Â  Â  Â  Â  modal.style.display = "none";
Â  Â  Â  Â  Â  Â  if (callback) callback();
Â  Â  Â  Â  };
Â  Â  }

Â  Â  function showSystemConfirm(msg, yesCallback, noCallback) {
Â  Â  Â  Â  document.getElementById("sysConfirmMsg").textContent = msg;
Â  Â  Â  Â  const modal = document.getElementById("systemConfirmModal");
Â  Â  Â  Â  modal.style.display = "flex";
Â  Â  Â  Â  document.getElementById("sysConfirmYesBtn").onclick = function() {
Â  Â  Â  Â  Â  Â  modal.style.display = "none";
Â  Â  Â  Â  Â  Â  if (yesCallback) yesCallback();
Â  Â  Â  Â  };
Â  Â  Â  Â  document.getElementById("sysConfirmNoBtn").onclick = function() {
Â  Â  Â  Â  Â  Â  modal.style.display = "none";
Â  Â  Â  Â  Â  Â  if (noCallback) noCallback();
Â  Â  Â  Â  };
Â  Â  }
Â  Â Â 
Â  Â  // --- å¾©å¸°æ©Ÿèƒ½ ---
Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  Â  const savedRoomId = localStorage.getItem('current_shogi_room');
Â  Â  Â  Â  if (savedRoomId && socket) {
Â  Â  Â  Â  Â  Â  if (socket.connected) {
Â  Â  Â  Â  Â  Â  Â  Â  checkReconnection(savedRoomId);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  socket.on('connect', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â checkReconnection(savedRoomId);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // â˜…â˜…â˜… è¿½åŠ ï¼šä¿å­˜ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ç”»åƒã‚’æ›´æ–°ã™ã‚‹å‡¦ç† â˜…â˜…â˜…
Â  Â  Â  Â  const savedCharId = localStorage.getItem('selected_character_id');
Â  Â  Â  Â  if (savedCharId && window.CHARACTERS && window.CHARACTERS[savedCharId]) {
Â  Â  Â  Â  Â  Â  currentCharacterId = savedCharId; // IDã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  const imgEl = document.querySelector('.character-stand');
Â  Â  Â  Â  Â  Â  if (imgEl) {
Â  Â  Â  Â  Â  Â  Â  Â  imgEl.src = window.CHARACTERS[savedCharId].image;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  function checkReconnection(roomId) {
Â  Â  Â  Â  socket.emit('check reconnection', roomId, (response) => {
Â  Â  Â  Â  Â  Â  if (response.canReconnect) {
Â  Â  Â  Â  Â  Â  Â  Â  showSystemConfirm(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "ä¸­æ–­ã•ã‚ŒãŸå¯¾å±€ãŒã‚ã‚Šã¾ã™ã€‚\nå¾©å¸°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã„ã„ãˆã€ã‚’é¸ã¶ã¨å¯¾å±€ã‚’ç ´æ£„ã—ã¾ã™ï¼‰",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  () => { window.location.href = `player_vs_player_online.html?room=${roomId}`; },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  () => { localStorage.removeItem('current_shogi_room'); }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('current_shogi_room');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
Â  Â  function openModal(id) { document.getElementById(id).style.display = 'flex'; }
Â  Â  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
Â  Â  function switchModal(closeId, openId) { closeModal(closeId); openModal(openId); }

Â  Â  function openAccountFromSettings() {
Â  Â  Â  closeModal('settingsMainMenu');
Â  Â  Â  showAuthModal();Â 
Â  Â  }

Â  Â  // --- ç”»é¢é·ç§» ---
Â  Â  function goToCharacterSelect(mode) {Â 
Â  Â  Â  Â  if (mode === 'online') {
Â  Â  Â  Â  Â  Â  const user = firebase.auth().currentUser;
Â  Â  Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  Â  Â  showSystemAlert("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚", () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAuthModal();Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.location.replace("character.html?mode=" + mode);
Â  Â  }

Â  Â  function startGame(difficulty) {
Â  Â  Â  if (difficulty === 'ex_hard3') {
Â  Â  Â  Â  Â  window.location.replace("cpu_yaneuraou.html");
Â  Â  Â  } else {
Â  Â  Â  Â  Â  window.location.replace("game_cpu.html?opponent=" + difficulty);
Â  Â  Â  }
Â  Â  }

Â  Â  // --- â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ â˜…â˜…â˜… ---
Â  Â  // ç¾åœ¨é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©IDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ komiyaï¼‰
Â  Â  let currentCharacterId = localStorage.getItem('selected_character_id') || 'komiya';

Â  Â  function changeCharacter(charId) {
Â  Â  Â  Â  // å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸ CHARACTERS ãŒã‚ã‚‹ã‹ç¢ºèª
Â  Â  Â  Â  if (!window.CHARACTERS || !window.CHARACTERS[charId]) {
Â  Â  Â  Â  Â  Â  console.error("æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", charId);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 1. IDã‚’æ›´æ–°ãƒ»ä¿å­˜
Â  Â  Â  Â  currentCharacterId = charId;
Â  Â  Â  Â  localStorage.setItem('selected_character_id', charId);

Â  Â  Â  Â  // 2. ç”»åƒã‚’æ›´æ–°
Â  Â  Â  Â  const imgEl = document.querySelector('.character-stand');
Â  Â  Â  Â  if (imgEl) {
Â  Â  Â  Â  Â  Â  imgEl.src = window.CHARACTERS[charId].image;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
Â  Â  Â  Â  switchModal('characterSettingsMenu', 'settingsMainMenu');

Â  Â  Â  Â  // 4. åˆ‡ã‚Šæ›¿ãˆç›´å¾Œã«æŒ¨æ‹¶ã•ã›ã‚‹ï¼ˆãŠå¥½ã¿ã§ï¼‰
Â  Â  Â  Â  setTimeout(talkCharacter, 500);
Â  Â  }

Â  Â  // --- â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å–‹ã‚Šæ©Ÿèƒ½ï¼ˆ{name}ç½®æ›å¯¾å¿œç‰ˆï¼‰ â˜…â˜…â˜… ---
Â  Â  let bubbleTimer = null;
Â  Â Â 
Â  Â  function talkCharacter() {
Â  Â  Â  Â  // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  if (!window.CHARACTERS || !window.CHARACTERS[currentCharacterId]) return;

Â  Â  Â  Â  const bubble = document.getElementById("characterBubble");
Â  Â  Â  Â  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
Â  Â  Â  Â  const userName = document.getElementById("userNameDisplay").textContent || "ã‚²ã‚¹ãƒˆ";
Â  Â  Â  Â Â 
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const hour = now.getHours();

Â  Â  Â  Â  // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
Â  Â  Â  Â  const charData = window.CHARACTERS[currentCharacterId];

Â  Â  Â  Â  // æ™‚é–“å¸¯åˆ¥ã®ã‚»ãƒªãƒ•ãƒªã‚¹ãƒˆã‚’å–å¾—
Â  Â  Â  Â  let timeMessages = [];
Â  Â  Â  Â  if (hour >= 5 && hour < 11) {
Â  Â  Â  Â  Â  Â  timeMessages = charData.time.morning || [];
Â  Â  Â  Â  } else if (hour >= 11 && hour < 17) {
Â  Â  Â  Â  Â  Â  timeMessages = charData.time.noon || [];
Â  Â  Â  Â  } else if (hour >= 17 && hour < 22) {
Â  Â  Â  Â  Â  Â  timeMessages = charData.time.evening || [];
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  timeMessages = charData.time.night || [];
Â  Â  Â  Â  }

Â  Â  Â  Â  // åŸºæœ¬ã‚»ãƒªãƒ•ã¨çµåˆ
Â  Â  Â  Â  const allMessages = (charData.base || []).concat(timeMessages);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ã‚»ãƒªãƒ•ãŒ1ã¤ã‚‚ãªã„å ´åˆã¯çµ‚äº†
Â  Â  Â  Â  if (allMessages.length === 0) return;

Â  Â  Â  Â  // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
Â  Â  Â  Â  let rawMsg = allMessages[Math.floor(Math.random() * allMessages.length)];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // â˜… {name} ã‚’ å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ç½®ãæ›ãˆã‚‹å‡¦ç†
Â  Â  Â  Â  let finalMsg = rawMsg.split('{name}').join(userName);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // è¡¨ç¤º
Â  Â  Â  Â  bubble.textContent = finalMsg;
Â  Â  Â  Â  bubble.style.display = "block";

Â  Â  Â  Â  clearTimeout(bubbleTimer);
Â  Â  Â  Â  bubbleTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  bubble.style.display = "none";
Â  Â  Â  Â  }, 3000); // å°‘ã—é•·ã‚ã«è¡¨ç¤º(3ç§’)
Â  Â  }

Â  Â  // --- ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
Â  Â  function openLobbyChat() {
Â  Â  Â  Â  openModal('lobbyChatModal');
Â  Â  }

Â  Â  // ã€ä¿®æ­£ç‰ˆã€‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
// ã€ä¿®æ­£ç‰ˆã€‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•° (Firestoreç‰ˆ)
function sendLobbyMessage() {
Â  Â  const input = document.getElementById("lobbyChatInput");
Â  Â  const text = input.value.trim();
Â  Â  if (!text) return;

Â  Â  const user = firebase.auth().currentUser;
Â  Â Â 
Â  Â  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—
Â  Â  let myName = "ã‚²ã‚¹ãƒˆ";
Â  Â  let myId = "guest"; // ã‚²ã‚¹ãƒˆã‚‚è­˜åˆ¥ã—ãŸã„å ´åˆã¯æŒ‡ç´‹IDãªã©ãŒå¿…è¦ã§ã™ãŒä¸€æ—¦ç°¡æ˜“åŒ–
Â  Â  let iconUrl = "script/image/test.icon.PNG"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³

Â  Â  if (user) {
Â  Â  Â  Â  myId = user.uid;
Â  Â  Â  Â  myName = document.getElementById("userNameDisplay").textContent || "åç„¡ã—";
Â  Â  Â  Â  // â˜…å°†æ¥çš„ã«userãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã“ã“ã§è¨­å®š
Â  Â  }

Â  Â  // â˜…Socket.ioã§ã¯ãªãã€Firestoreã«ä¿å­˜ã™ã‚‹
Â  Â  // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å: "lobby_chat" (è‡ªç”±ã«ã¤ã‘ã¦OK)
Â  Â  db.collection("lobby_chat").add({
Â  Â  Â  Â  text: text,
Â  Â  Â  Â  name: myName,
Â  Â  Â  Â  userId: myId,
Â  Â  Â  Â  icon: iconUrl,
Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp(), // ã‚µãƒ¼ãƒãƒ¼æ™‚é–“
Â  Â  Â  Â  role: 'lobby'
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  console.log("é€ä¿¡æˆåŠŸ");
Â  Â  Â  Â  input.value = ""; // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
Â  Â  })
Â  Â  .catch((error) => {
Â  Â  Â  Â  console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼: ", error);
Â  Â  Â  Â  alert("é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸ");
Â  Â  });
}
Â  Â Â 

// --- â˜…â˜…â˜… æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ (Firestoreç‰ˆ) â˜…â˜…â˜… ---

let chatUnsubscribe = null; // ç›£è¦–è§£é™¤ç”¨ã®å¤‰æ•°

// ãƒãƒ£ãƒƒãƒˆã®åˆæœŸåŒ–ãƒ»ç›£è¦–é–‹å§‹
function initLobbyChat() {
Â  Â  const historyDiv = document.getElementById("lobbyChatHistory");
Â  Â  if (!historyDiv) return;

Â  Â  // äºŒé‡ç›£è¦–ã‚’é˜²ããŸã‚ã€æ—¢ã«ç›£è¦–ä¸­ãªã‚‰è§£é™¤
Â  Â  if (chatUnsubscribe) {
Â  Â  Â  Â  chatUnsubscribe();
Â  Â  }

Â  Â  console.log("ãƒãƒ£ãƒƒãƒˆæ¥ç¶šé–‹å§‹...");

Â  Â  // Firestoreã® "lobby_chat" ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–
Â  Â  chatUnsubscribe = db.collection("lobby_chat")
Â  Â  Â  Â  .orderBy("createdAt", "desc") // æ–°ã—ã„é †ã«å–å¾—
Â  Â  Â  Â  .limit(50)Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æœ€æ–°50ä»¶
Â  Â  Â  Â  .onSnapshot((snapshot) => {
Â  Â  Â  Â  Â  Â  const historyDiv = document.getElementById("lobbyChatHistory");
Â  Â  Â  Â  Â  Â  // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãŒã‚ã‚‹ãŸã³ã«ã“ã“ãŒå‹•ã
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«ã¾ã¨ã‚ã‚‹
Â  Â  Â  Â  Â  Â  let messages = [];
Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  data.id = doc.id;
Â  Â  Â  Â  Â  Â  Â  Â  messages.push(data);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // æ–°ã—ã„é †(desc)ã§å–å¾—ã—ãŸã®ã§ã€è¡¨ç¤ºã®ãŸã‚ã«å¤ã„é †ã«ç›´ã™
Â  Â  Â  Â  Â  Â  messages.reverse();

Â  Â  Â  Â  Â  Â  // ç”»é¢ã‚’ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦å†æç”»
Â  Â  Â  Â  Â  Â  historyDiv.innerHTML = "";
Â  Â  Â  Â  Â  Â  messages.forEach(msg => {
Â  Â  Â  Â  Â  Â  Â  Â  addMessageToLobbyChatFirestore(msg);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // ä¸€ç•ªä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
Â  Â  Â  Â  Â  Â  historyDiv.scrollTop = historyDiv.scrollHeight;
Â  Â  Â  Â  });
}

// 1ä»¶åˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function addMessageToLobbyChatFirestore(data) {
Â  Â  const historyDiv = document.getElementById("lobbyChatHistory");
Â  Â  const user = firebase.auth().currentUser;
Â  Â Â 
Â  Â  // è‡ªåˆ†ã®IDã‹ã©ã†ã‹ã®åˆ¤å®š
Â  Â  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ null ã¨æ¯”è¼ƒ
Â  Â  const currentMyId = user ? user.uid : null;
Â  Â Â 
Â  Â  // ãƒ‡ãƒ¼ã‚¿ã«userIdãŒãªã„å ´åˆï¼ˆå¤ã„ãƒ­ã‚°ãªã©ï¼‰ã¸ã®å¯¾ç­–
Â  Â  const msgUserId = data.userId || "unknown";

Â  Â  const isMe = (msgUserId === currentMyId);

Â  Â  // --- ã“ã“ã‹ã‚‰ã¯ãƒ‡ã‚¶ã‚¤ãƒ³ç”Ÿæˆï¼ˆä»¥å‰ã¨åŒã˜ï¼‰ ---
Â  Â  const rowDiv = document.createElement("div");
Â  Â  rowDiv.className = "chat-row";
Â  Â  if (isMe) rowDiv.classList.add("mine");

Â  Â  const iconCol = document.createElement("div");
Â  Â  iconCol.className = "icon-container";

Â  Â  const nameDiv = document.createElement("div");
Â  Â  nameDiv.className = "chat-name-badge";
Â  Â Â 
Â  Â  // åå‰ãŒé•·ã™ããŸå ´åˆã«å‚™ãˆã¦ã€SVGã§æç”»ã™ã‚‹
Â  Â  // preserveAspectRatio="xMidYMid meet" ãŒã€Œç¸¦æ¨ªæ¯”ã‚’ä¿ã£ã¦å…¨ä½“ã‚’åã‚ã‚‹ã€è¨­å®šã§ã™
Â  Â  const safeName = data.name || "åç„¡ã—";
Â  Â Â 
Â  Â  // æ–‡å­—æ•°ã«å¿œã˜ã¦viewBoxã®å¹…ã‚’è¨ˆç®—ã™ã‚‹ï¼ˆç°¡æ˜“çš„ãªè‡ªå‹•èª¿æ•´ï¼‰
Â  Â  // å…¨è§’æ–‡å­—ãªã‚‰å¹…12pxãã‚‰ã„ã¨ä»®å®šã—ã¦è¨ˆç®—
Â  Â  // æœ€ä½ã§ã‚‚80pxï¼ˆCSSã®widthã¨åŒã˜ï¼‰ã¯ç¢ºä¿ã™ã‚‹
Â  Â  const textWidth = Math.max(80, safeName.length * 12);Â 
Â  Â Â 
Â  Â  nameDiv.innerHTML = `
Â  Â  Â  Â  <svg viewBox="0 0 ${textWidth} 20" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
Â  Â  Â  Â  Â  Â  <text x="50%" y="50%" class="chat-name-text">${safeName}</text>
Â  Â  Â  Â  </svg>
Â  Â  `;

Â  Â  const iconImg = document.createElement("img");
Â  Â  iconImg.src = data.icon || "script/image/test.icon.PNG";
Â  Â  iconImg.className = "chat-icon-img";
Â  Â  // ç”»åƒã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚°ãƒ¬ãƒ¼ã«
Â  Â  iconImg.onerror = function() { this.style.backgroundColor = "#ccc"; };

Â  Â  iconCol.appendChild(nameDiv);
Â  Â  iconCol.appendChild(iconImg);

Â  Â  const bubbleDiv = document.createElement("div");
Â  Â  bubbleDiv.className = "chat-bubble";
Â  Â  bubbleDiv.textContent = data.text;

Â  Â  // æ—¥ä»˜ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’è¿½åŠ 
Â  Â  /*
Â  Â  if (data.createdAt) {
Â  Â  Â  Â  const d = data.createdAt.toDate();
Â  Â  Â  Â  const timeStr = `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
Â  Â  Â  Â  const timeSpan = document.createElement("div");
Â  Â  Â  Â  timeSpan.style.fontSize = "0.6rem";
Â  Â  Â  Â  timeSpan.style.textAlign = "right";
Â  Â  Â  Â  timeSpan.style.opacity = "0.6";
Â  Â  Â  Â  timeSpan.textContent = timeStr;
Â  Â  Â  Â  bubbleDiv.appendChild(timeSpan);
Â  Â  }
Â  Â  */

Â  Â  rowDiv.appendChild(iconCol);
Â  Â  rowDiv.appendChild(bubbleDiv);
Â  Â  historyDiv.appendChild(rowDiv);
}
Â  Â Â 
Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  Â  const lobbyInput = document.getElementById("lobbyChatInput");
Â  Â  Â  Â  if (lobbyInput) {
Â  Â  Â  Â  Â  Â  lobbyInput.addEventListener("keypress", (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === "Enter") sendLobbyMessage();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });

Â  Â  window.onload = function() {
Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  const openMenuId = urlParams.get('open');
Â  Â  Â  if (openMenuId) {
Â  Â  Â  Â  const menuEl = document.getElementById(openMenuId);
Â  Â  Â  Â  if (menuEl) {
Â  Â  Â  Â  Â  menuEl.style.display = 'flex';
Â  Â  Â  Â  Â  if (window.history.replaceState) {
Â  Â  Â  Â  Â  Â  window.history.replaceState(null, null, window.location.pathname);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };

Â  Â  firebase.auth().onAuthStateChanged((user) => {
Â  Â  Â  Â  // â˜…ä¿®æ­£ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒ»æœªãƒ­ã‚°ã‚¤ãƒ³ã«é–¢ã‚ã‚‰ãšã€ãƒãƒ£ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿é–‹å§‹ã™ã‚‹
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  initLobbyChat();
Â  Â  Â  Â  }, 500);

Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  // ã“ã“ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ã€ã«å¿…è¦ãªå‡¦ç†ï¼ˆæ‰€æŒé‡‘ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãªã©ï¼‰
Â  Â  Â  Â  Â  Â  db.collection("users").doc(user.uid).onSnapshot((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. æ‰€æŒé‡‘
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentGold = data.gold || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const goldEl = document.getElementById("userGoldDisplay");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (goldEl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  goldEl.textContent = currentGold.toLocaleString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mailbox = data.mailbox || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMailBadge(mailbox);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById("mailboxModal").style.display === "flex") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â renderMailList(mailbox);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.currentUserMailbox = mailbox;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒãƒƒã‚¸
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const missions = data.missions || {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let claimableCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof GAME_MISSIONS !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  GAME_MISSIONS.forEach(m => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uData = missions[m.id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uData && uData.progress >= m.target && !uData.collected) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  claimableCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mBadge = document.getElementById("missionBadge");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (mBadge) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (claimableCount > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mBadge.style.display = "flex";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mBadge.textContent = claimableCount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mBadge.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const goldEl = document.getElementById("userGoldDisplay");
Â  Â  Â  Â  Â  Â  if (goldEl) goldEl.textContent = "0";
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- ç”»é¢å›è»¢ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ ---
Â  Â  function autoRotateTitle() {
Â  Â  Â  Â  const w = window.innerWidth;
Â  Â  Â  Â  const h = window.innerHeight;
Â  Â  Â  Â  const isPortrait = h > w;
Â  Â  Â  Â  if (isPortrait) {
Â  Â  Â  Â  Â  Â  document.body.style.width = h + "px";
Â  Â  Â  Â  Â  Â  document.body.style.height = w + "px";
Â  Â  Â  Â  Â  Â  document.body.style.transform = "translate(-50%, -50%) rotate(90deg)";
Â  Â  Â  Â  Â  Â  document.body.style.position = "fixed";
Â  Â  Â  Â  Â  Â  document.body.style.top = "50%";
Â  Â  Â  Â  Â  Â  document.body.style.left = "50%";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.body.style.width = "100%";
Â  Â  Â  Â  Â  Â  document.body.style.height = "100%";
Â  Â  Â  Â  Â  Â  document.body.style.transform = "";
Â  Â  Â  Â  Â  Â  document.body.style.top = "0";
Â  Â  Â  Â  Â  Â  document.body.style.left = "0";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  autoRotateTitle();
Â  Â  Â  Â  window.addEventListener('resize', autoRotateTitle);
Â  Â  Â  Â  window.addEventListener('contextmenu', (e) => e.preventDefault());

Â  Â  Â  Â  history.pushState(null, null, location.href);
Â  Â  Â  Â  window.addEventListener('popstate', (e) => {
Â  Â  Â  Â  Â  Â  history.pushState(null, null, location.href);
Â  Â  Â  Â  });

Â  Â  Â  Â  let startX = 0;
Â  Â  Â  Â  let startY = 0;

Â  Â  Â  Â  document.addEventListener('touchstart', (e) => {
Â  Â  Â  Â  Â  Â  if (e.touches.length > 1) return;
Â  Â  Â  Â  Â  Â  startX = e.touches[0].pageX;
Â  Â  Â  Â  Â  Â  startY = e.touches[0].pageY;
Â  Â  Â  Â  Â  Â  if (startX < 30 || startX > window.innerWidth - 30) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, { passive: false });

Â  Â  Â  Â  document.addEventListener('touchmove', (e) => {
Â  Â  Â  Â  Â  Â  if (e.touches.length > 1) return;
Â  Â  Â  Â  Â  Â  const x = e.touches[0].pageX;
Â  Â  Â  Â  Â  Â  const y = e.touches[0].pageY;
Â  Â  Â  Â  Â  Â  const deltaX = Math.abs(x - startX);
Â  Â  Â  Â  Â  Â  const deltaY = Math.abs(y - startY);
Â  Â  Â  Â  Â  Â  const isScrollable = e.target.closest('#lobbyChatHistory, .modal-box, #statsHistory, .help-content');

Â  Â  Â  Â  Â  Â  if (isScrollable) {
Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (deltaX > deltaY && deltaX > 10) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, { passive: false });
Â  Â  });

Â  Â  // --- ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ ---

Â  // ãƒãƒƒã‚¸ï¼ˆèµ¤ä¸¸ï¼‰ã®æ›´æ–°
Â  // --- â˜…â˜…â˜… ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ï¼ˆä»•æ§˜å¤‰æ›´ç‰ˆï¼‰ â˜…â˜…â˜… ---

Â  Â  // ãƒãƒƒã‚¸æ›´æ–°
Â  Â  function updateMailBadge(mailbox) {
Â  Â  Â  Â  // æœªèª­ã€ã‹ã¤ã€Œå ±é…¬ãŒã‚ã‚‹ã®ã«ã¾ã å—ã‘å–ã£ã¦ã„ãªã„ã€ãƒ¡ãƒ¼ãƒ«ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
Â  Â  Â  Â  // (å˜ã«æœªèª­ç®¡ç†ã—ãŸã„å ´åˆã¯æ—¢èª­ãƒ•ãƒ©ã‚°ãŒå¿…è¦ã§ã™ãŒã€ä»Šå›ã¯ã€Œæœªå—å–ã€ã‚’é€šçŸ¥ã—ã¾ã™)
Â  Â  Â  Â  let unreadCount = 0;
Â  Â  Â  Â  mailbox.forEach(m => {
Â  Â  Â  Â  Â  Â  // å ±é…¬ãŒã‚ã‚‹ ã‹ã¤ ã¾ã å—ã‘å–ã£ã¦ã„ãªã„(claimedãƒ•ãƒ©ã‚°ãŒãªã„/false)
Â  Â  Â  Â  Â  Â  if (m.reward && !m.claimed) {
Â  Â  Â  Â  Â  Â  Â  Â  unreadCount++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // â€»ã‚‚ã—ã€Œå ±é…¬ãªã—ã€ã®ãƒ¡ãƒ¼ãƒ«ã‚‚å«ã‚ã¦å˜ã«ã€Œæœªèª­ã€ã‚’ç®¡ç†ã—ãŸã„å ´åˆã¯
Â  Â  Â  Â  Â  Â  // åˆ¥é€” read: false ãªã©ã®ãƒ•ãƒ©ã‚°ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const badge = document.getElementById("mailBadge");
Â  Â  Â  Â  if (unreadCount > 0) {
Â  Â  Â  Â  Â  Â  badge.textContent = unreadCount;
Â  Â  Â  Â  Â  Â  badge.style.display = "flex";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  badge.style.display = "none";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’é–‹ã
Â  Â  function openMailbox() {
Â  Â  Â  Â  openModal('mailboxModal');
Â  Â  Â  Â  backToMailList();Â 
Â  Â  Â  Â  if (window.currentUserMailbox) {
Â  Â  Â  Â  Â  Â  renderMailList(window.currentUserMailbox);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ãƒªã‚¹ãƒˆæç”»ï¼ˆè‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ï¼‰
Â  Â  function renderMailList(mailbox) {
Â  Â  Â  Â  const listEl = document.getElementById("mailList");
Â  Â  Â  Â  const noMsg = document.getElementById("noMailMsg");
Â  Â  Â  Â  listEl.innerHTML = "";

Â  Â  Â  Â  // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
Â  Â  Â  Â  const sortedMail = [...mailbox].reverse();

Â  Â  Â  Â  if (sortedMail.length === 0) {
Â  Â  Â  Â  Â  Â  noMsg.style.display = "block";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  noMsg.style.display = "none";
Â  Â  Â  Â  Â  Â  sortedMail.forEach((mail) => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // â˜…â˜…â˜… è‰²åˆ†ã‘ã®ã‚¯ãƒ©ã‚¹é©ç”¨ â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  Â  Â  let itemClass = "mail-item";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (mail.reward) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (mail.claimed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ·»ä»˜ã‚ã‚Šãƒ»å—å–æ¸ˆ â†’ è–„ã„ç°è‰²
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemClass += " type-reward-claimed";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ·»ä»˜ã‚ã‚Šãƒ»æœªå—å– â†’ è–„ã„é’
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemClass += " type-reward-active";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ·»ä»˜ãªã— â†’ è–„ã„èµ¤
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemClass += " type-normal";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  li.className = itemClass;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
Â  Â  Â  Â  Â  Â  Â  Â  let dateStr = "---";
Â  Â  Â  Â  Â  Â  Â  Â  if (mail.date && mail.date.toDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const d = mail.date.toDate();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (mail.date) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateStr = "æ—¥ä»˜ä¸æ˜";Â 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // ä»¶åã®è¡¨ç¤ºï¼ˆå—å–æ¸ˆãªã‚‰ã€Œ(æ¸ˆ)ã€ã‚’ã¤ã‘ã‚‹ãªã©ã—ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  let subjectText = mail.subject;
Â  Â  Â  Â  Â  Â  Â  Â  if (mail.reward && mail.claimed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subjectText = "ã€æ¸ˆã€‘ " + subjectText;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mail-subject">${subjectText}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mail-date">${dateStr}</div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  li.onclick = () => showMailDetail(mail);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  listEl.appendChild(li);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // è©³ç´°ç”»é¢ã‚’è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³åˆ¶å¾¡è¿½åŠ ï¼‰
Â  Â  function showMailDetail(mail) {
Â  Â  Â  Â  document.getElementById("mailListView").style.display = "none";
Â  Â  Â  Â  document.getElementById("mailDetailView").style.display = "flex";

Â  Â  Â  Â  document.getElementById("detailSubject").textContent = mail.subject;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let dateStr = "";
Â  Â  Â  Â  if (mail.date && mail.date.toDate) {
Â  Â  Â  Â  Â  Â  Â dateStr = mail.date.toDate().toLocaleString();
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById("detailDate").textContent = dateStr;
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById("detailBody").textContent = mail.body;

Â  Â  Â  Â  const rewardArea = document.getElementById("rewardArea");
Â  Â  Â  Â  const rewardBtn = document.getElementById("claimRewardBtn");
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (mail.reward) {
Â  Â  Â  Â  Â  Â  rewardArea.style.display = "block";
Â  Â  Â  Â  Â  Â  document.getElementById("rewardContent").textContent = mail.reward.name || "å ±é…¬ã‚ã‚Š";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // â˜…â˜…â˜… å—å–çŠ¶æ³ã«ã‚ˆã£ã¦ãƒœã‚¿ãƒ³ã‚’å¤‰ãˆã‚‹ â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  if (mail.claimed) {
Â  Â  Â  Â  Â  Â  Â  Â  // å—å–æ¸ˆã¿ã®å ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.textContent = "å—å–æ¸ˆã¿";
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.style.background = "#ccc";
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.onclick = null;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // æœªå—å–ã®å ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.textContent = "å—ã‘å–ã‚‹";
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.style.background = "#28a745";
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  rewardBtn.onclick = () => claimMailReward(mail);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  rewardArea.style.display = "none";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
Â  Â  function backToMailList() {
Â  Â  Â  Â  document.getElementById("mailListView").style.display = "flex";
Â  Â  Â  Â  document.getElementById("mailDetailView").style.display = "none";
Â  Â  }

Â  Â  // å ±é…¬å—ã‘å–ã‚Šå‡¦ç†ï¼ˆå‰Šé™¤ã›ãšãƒ•ãƒ©ã‚°æ›´æ–°ï¼‰
Â  Â  async function claimMailReward(mail) {
Â  Â  Â  Â  const user = firebase.auth().currentUser;
Â  Â  Â  Â  if (!user) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!confirm("å ±é…¬ã‚’å—ã‘å–ã‚Šã¾ã™ã‹ï¼Ÿ")) return;

Â  Â  Â  Â  const userRef = db.collection("users").doc(user.uid);

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  const doc = await transaction.get(userRef);
Â  Â  Â  Â  Â  Â  Â  Â  if (!doc.exists) throw "User not found";

Â  Â  Â  Â  Â  Â  Â  Â  const userData = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const currentMailbox = userData.mailbox || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // å¯¾è±¡ã®ãƒ¡ãƒ¼ãƒ«ã‚’æ¢ã™
Â  Â  Â  Â  Â  Â  Â  Â  const targetIndex = currentMailbox.findIndex(m => m.id === mail.id);
Â  Â  Â  Â  Â  Â  Â  Â  if (targetIndex === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw "ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // æ—¢ã«å—ã‘å–ã£ã¦ã„ãªã„ã‹å¿µã®ãŸã‚ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  if (currentMailbox[targetIndex].claimed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw "ã“ã®å ±é…¬ã¯æ—¢ã«å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚";
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const updates = {};

Â  Â  Â  Â  Â  Â  Â  Â  // å ±é…¬ã®ä»˜ä¸
Â  Â  Â  Â  Â  Â  Â  Â  if (mail.reward.type === "gold") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates.gold = (userData.gold || 0) + Number(mail.reward.value);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (mail.reward.type === "item") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentInv = userData.inventory || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!currentInv.includes(mail.reward.value)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates.inventory = firebase.firestore.FieldValue.arrayUnion(mail.reward.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // â˜…â˜…â˜… ãƒ¡ãƒ¼ãƒ«ã‚’å‰Šé™¤ã›ãšã€claimedãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦æ›´æ–°ã™ã‚‹ â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  Â  Â  // é…åˆ—å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥æ›¸ãæ›ãˆã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  currentMailbox[targetIndex].claimed = true;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // æ›´æ–°ã—ãŸé…åˆ—å…¨ä½“ã‚’ã‚»ãƒƒãƒˆ
Â  Â  Â  Â  Â  Â  Â  Â  updates.mailbox = currentMailbox;

Â  Â  Â  Â  Â  Â  Â  Â  transaction.update(userRef, updates);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  alert(`å—ã‘å–ã‚Šã¾ã—ãŸï¼\n${mail.reward.name}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // æˆåŠŸã—ãŸã‚‰ãƒªã‚¹ãƒˆã«æˆ»ã‚‹ï¼ˆè‡ªå‹•çš„ã«å†æç”»ã•ã‚Œã€ã‚°ãƒ¬ãƒ¼ã«ãªã‚Šã¾ã™ï¼‰
Â  Â  Â  Â  Â  Â  backToMailList();Â 

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  alert("å—ã‘å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ: " + e);
Â  Â  Â  Â  }
Â  Â  }



</script>

</body>
</html>


