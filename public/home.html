<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>ã—ãŠã‚„å°†æ£‹ - ãƒ›ãƒ¼ãƒ </title>
  <link rel="icon" href="script/image/komiya_icon.png"> 
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="script/image/komiya_icon.png">
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      position: fixed; 
      top: 0;
      left: 0;
      width: 100%;   /* vw, vh ã§ã¯ãªã % ã‚’ä½¿ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆ */
    height: 100%;
    
    background-color: #2c3e50;
    background-size: cover;
    background-position: center;
    overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å‡ºã•ãªã„ */

    /* â˜…â˜…â˜… ã“ã“ãŒæœ€é‡è¦ï¼šã‚¹ãƒ¯ã‚¤ãƒ—ã«ã‚ˆã‚‹ç”»é¢é·ç§»ï¼ˆãƒã‚¦ãƒ³ã‚¹ï¼‰ã‚’ç¦æ­¢ã™ã‚‹ â˜…â˜…â˜… */
    overscroll-behavior-x: none; 
    overscroll-behavior-y: none;
    overscroll-behavior: none;

    -webkit-user-select: none;
    -webkit-touch-callout: none;
    user-select: none;
    touch-action: none; /* ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ãªã©ã‚‚ç„¡åŠ¹åŒ– */
}

/* â˜…â˜…â˜… è¿½åŠ ï¼šhtmlã‚¿ã‚°ã«ã‚‚é©ç”¨ã—ãªã„ã¨åŠ¹ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ â˜…â˜…â˜… */
html {
    width: 100%;
    height: 100%;
    overflow: hidden;
    overscroll-behavior: none;
}

input, textarea {
   user-select: text;
   -webkit-user-select: text;
   touch-action: auto; /* ã“ã“ã‚‚å¿˜ã‚Œãšã«ï¼ */
 }

/* èƒŒæ™¯å°‚ç”¨ã®è¨­å®š */
    #bg-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1; /* ä»–ã®è¦ç´ ã‚ˆã‚ŠèƒŒé¢ã«é…ç½® */
      background-image: url('script/image/shogi_title.PNG');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    /* å¹ãå‡ºã—ã®è¨­å®š */
    .speech-bubble {
      display: none;
      position: absolute;
      bottom: 30vh;
      left: 50%;
      transform: translateX(-50%);
      background: #fff8dc;
      border: 3px solid #8b4513;
      border-radius: 20px;
      padding: 12px 20px;
      min-width: 160px;
      max-width: 220px;
      color: #333;
      font-weight: bold;
      font-size: 0.95rem;
      z-index: 100;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      pointer-events: none;
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .speech-bubble::after {
      content: '';
      position: absolute;
      bottom: 100%;
      right: 20%;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 15px solid #8b4513;
    }

    @keyframes pop-in {
      0% { transform: translateX(-50%) scale(0); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    .character-stand {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      height: 85vh;
      width: auto;
      max-width: 95%;
      z-index: 1;

      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
      cursor: pointer;
      pointer-events: auto;
    }

    .user-info-bar {
      position: absolute;
      top: 0;
      width: 100%;
      padding: 10px 20px; 
      background: rgba(0, 0, 0, 0.6);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
      z-index: 5;
    }

    .user-name { font-weight: bold; font-size: 1.1rem; }
    
    .top-btn {
      border: none;
      color: white;
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 5px;
      font-weight: bold;
    }
    .stats-btn { background: #ff9800; }
    .news-btn { background: #28a745; }

    .bottom-menu {
      position: absolute;
      bottom: 10px;
      width: 96%;
      left: 2%;
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      gap: 5px;
      z-index: 10;
    }

    .menu-btn {
      flex: 1;
      height: 60px;
      background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
      border: 2px solid white;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .menu-btn:active { transform: scale(0.95); }

    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
      overscroll-behavior: none;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-box {
    position: relative;
    background: #fff8dc;
    padding: 15px;
    border-radius: 10px;
    border: 4px solid #8b4513;
    text-align: center;
    width: 80%;
    max-width: 800px;
    
    /* â˜…â˜…â˜… ã“ã“ãŒé‡è¦ï¼šç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„è¨­å®š â˜…â˜…â˜… */
    max-height: 85vh; /* ç”»é¢ã®é«˜ã•ã®85%ã¾ã§ã«åˆ¶é™ */
    display: flex;    /* ä¸­èº«ã‚’ç¸¦ä¸¦ã³ã®Flexãƒœãƒƒã‚¯ã‚¹ã«ã™ã‚‹ */
    flex-direction: column; /* ç¸¦æ–¹å‘ã«ä¸¦ã¹ã‚‹ */
    box-sizing: border-box;
}

    .modal-body {
    flex: 1;            /* ä½™ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨éƒ¨ä½¿ã† */
    overflow-y: auto;   /* ä¸­èº«ãŒæº¢ã‚ŒãŸã‚‰ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å‡ºã™ */
    margin: 10px 0;     /* ä¸Šä¸‹ã®ä½™ç™½ */
    padding: 5px;       /* å†…å´ã®ä½™ç™½ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨æ–‡å­—ãŒè¢«ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®æ“ä½œæ€§ã‚’è‰¯ãã™ã‚‹è¨­å®š */
    -webkit-overflow-scrolling: touch; 
}
    
    /* ãƒœã‚¿ãƒ³ã‚’2åˆ—ã«ä¸¦ã¹ã‚‹ãŸã‚ã®ã‚°ãƒªãƒƒãƒ‰è¨­å®š */
    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }

    .sub-btn {
      display: block;
      width: 100%;
      margin: 0;
      padding: 12px 5px;
      font-size: 1rem;
      background: #8b4513;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .sub-btn:active { transform: scale(0.98); opacity: 0.9; }

    /* ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .close-small-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      background: #666;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      cursor: pointer;
      z-index: 101;
    }

    #lobbyChatTitle {
      color: #005bea;
      margin: 0 0 5px 0;
      text-align: left;
      padding-left: 5px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    #lobbyChatHistory {
      flex: 1; 
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-height: 100px;
    }

    .chat-input-area {
      display: flex;
      gap: 5px;
      margin-top: 8px;
    }

    /* ãƒãƒ£ãƒƒãƒˆå¹ãå‡ºã—ãƒ»ã‚¢ã‚¤ã‚³ãƒ³é–¢é€£ */
    .chat-row { display: flex; align-items: flex-start; gap: 10px; max-width: 95%; }
    .chat-row.mine { align-self: flex-end; flex-direction: row-reverse; }
    .icon-container { display: flex; flex-direction: column; align-items: center; width: 60px; }
    .chat-name-badge { background: #fff; border: 1px solid #8b4513; border-radius: 10px; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; z-index: 2; margin-bottom: -10px; white-space: nowrap; }
    .chat-icon-img { width: 50px; height: 50px; border: 3px solid #56ab2f; border-radius: 12px; background: #fff; object-fit: cover; }
    .chat-row.mine .chat-icon-img { border: 3px solid #FFA500; }
    .chat-bubble { position: relative; padding: 10px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; word-break: break-all; }
    .chat-row .chat-bubble { background: #fff; border: 2px solid #e0e0e0; border-top-left-radius: 0; }
    .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; border-top-right-radius: 0; }

    /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
    .offline-color { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%) !important; }
    .online-color { background: linear-gradient(to bottom, #ff758c 0%, #ff7eb3 100%) !important; }
    .mypage-color { background: linear-gradient(to bottom, #f6d365 0%, #fda085 100%) !important; }
    .ready-color { background: linear-gradient(to bottom, #a8e063 0%, #56ab2f 100%) !important; }
    .chat-color { background: linear-gradient(to bottom, #da92ec 0%, #a06ee1 100%) !important; }

    /* ãƒ¢ãƒã‚¤ãƒ«æ¨ªå‘ãèª¿æ•´ */
    @media screen and (max-height: 450px) {
      .modal-box { padding: 10px; }
      #lobbyChatHistory { padding: 8px; }
    }
  </style>

</head>
<body>
  <div id="bg-image"></div>

  <div class="user-info-bar">
    <div>
      <span id="userNameDisplay" class="user-name">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“
      <button id="editNameBtn" onclick="showNameEditModal()" style="display:none; background:none; border:none; cursor:pointer; font-size:1rem;">âœï¸</button>
      
      <span style="margin-left: 15px; font-weight: bold; color: #ffd700; text-shadow: 1px 1px 2px #000;">
        ğŸ’° <span id="userGoldDisplay">0</span> G
      </span>
    </div>

    <div>
      <button class="top-btn news-btn" onclick="openModal('newsModal')"> å‘ŠçŸ¥ </button>
      <button class="top-btn" style="background: #e91e63;" onclick="switchModal('settingsMainMenu', 'characterSettingsMenu')">ã‚­ãƒ£ãƒ©</button>
      <button class="top-btn stats-btn" onclick="showMyStats()"> æˆ¦ç¸¾ </button>
      <button class="top-btn" style="background: #17a2b8;" onclick="openModal('helpMainMenu')">ãƒ˜ãƒ«ãƒ—</button>
      <button class="top-btn" style="background: #6f42c1;" onclick="openModal('helpContact')">ä¸å…·åˆ</button>
      <button class="top-btn" style="background: #6c757d;" onclick="openModal('settingsMainMenu')"> è¨­å®š </button>
    </div>
  </div>

  <div id="characterBubble" class="speech-bubble"></div>

  <img class="character-stand" src="script/image/komiya_touka.png" alt="Character" onclick="talkCharacter()">

  <div class="bottom-menu">
    <button class="menu-btn offline-color" onclick="openModal('offlineMenu')">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</button>
    <button onclick="goToCharacterSelect('online')" class="menu-btn online-color">
  ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
</button>
    <button class="menu-btn chat-color" onclick="openLobbyChat()">ãƒãƒ£ãƒƒãƒˆ</button> <button class="menu-btn ready-color" onclick="window.location.href='kaiseki.html'">è§£æ</button>
    <button class="menu-btn mypage-color" onclick="window.location.href='mypage.html'">æ£‹è­œ</button>
  </div>

  <div id="newsModal" class="overlay">
    <div class="modal-box">
      <h3 style="color:#d35400; margin-top:0;">ğŸ”” æœ€æ–°æƒ…å ±</h3>
      <div style="text-align: left; margin: 20px 0; line-height: 1.6; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;">
        ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ å®Ÿè£…ï¼<br>
        ãƒ»ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ è¿½åŠ ï¼<br>
        ãƒ»æ£‹è­œè§£ææ©Ÿèƒ½ å®Ÿè£…ï¼<br>
        ãƒ»æœ€å¼·CPUã€Œè©¦é¨“å®Ÿè£…ã€è¿½åŠ 
      </div>
      <button onclick="closeModal('newsModal')" style="background: #ccc; border: none; color: black; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="settingsMainMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">è¨­å®š</h3>
    <div class="modal-grid">
      <button class="sub-btn" style="background: #e91e63;" onclick="switchModal('settingsMainMenu', 'characterSettingsMenu')">ã‚­ãƒ£ãƒ©è¨­å®š</button>
      
      <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'volumeMenu')">éŸ³é‡è¨­å®š</button>
      <button class="sub-btn" onclick="switchModal('settingsMainMenu', 'languageMenu')">è¨€èªè¨­å®š</button>
      <button class="sub-btn" onclick="openAccountFromSettings()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
    </div>
    <button class="sub-btn" style="background:#666;" onclick="closeModal('settingsMainMenu')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="volumeMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">éŸ³é‡è¨­å®š</h3>
    <div style="margin: 20px 0;">
      <p>BGM</p><input type="range" style="width:80%;">
      <p>åŠ¹æœéŸ³</p><input type="range" style="width:80%;">
    </div>
    <button class="sub-btn" style="background:#666;" onclick="switchModal('volumeMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
  </div>
</div>

<div id="languageMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">è¨€èªè¨­å®š / Language</h3>
    <div class="modal-grid">
      <button class="sub-btn">æ—¥æœ¬èª</button>
      <button class="sub-btn" style="background:#555;">ã‚¹ãƒ¯ãƒ’ãƒªèªï¼ˆæº–å‚™ä¸­ï¼‰</button>
    </div>
    <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="switchModal('languageMenu', 'settingsMainMenu')">ã‚‚ã©ã‚‹</button>
  </div>
</div>

 
<div id="authModal" class="overlay">
    <div class="modal-box">
      
      <h2 id="authTitle" style="margin-top: 0; color: #8b4513; flex-shrink: 0;">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
      
      <div class="modal-body">
        
        <div id="authInputs">
          <div style="text-align: left; margin: 15px 0;">
            <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><br>
            <input type="email" id="authEmail" placeholder="example@mail.com" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
          </div>
          <div style="text-align: left; margin: 15px 0;">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label><br>
            <input type="password" id="authPass" placeholder="******" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
          </div>

          <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
            <button onclick="loginUser()" style="background: #007bff; color: white; width: 45%; height: 45px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="registerUser()" style="background: #28a745; color: white; width: 45%; height: 45px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">æ–°è¦ç™»éŒ²</button>
          </div>
        </div>

        <div style="margin-top:20px; padding-top:10px;">
    <button id="logoutBtnInModal" onclick="logoutUser(); closeAuthModal()" style="display:none; background: #6c757d; border:none; border-radius:5px; color: white; width: 100%; height: 40px; font-weight:bold;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

      </div> <div style="margin-top: 0; border-top: 1px solid #ccc; padding-top: 15px; flex-shrink: 0;">
        <button onclick="closeAuthModal()" style="background: #ccc; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; font-weight:bold;">ã‚‚ã©ã‚‹</button>
      </div>

    </div>
  </div>

  <div id="nameEditModal" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">åå‰ã‚’å¤‰æ›´</h3>
      <div style="margin: 20px 0;">
        <input type="text" id="newNameInput" style="width: 80%; padding: 10px; font-size: 16px; border: 2px solid #8b4513; border-radius: 5px; text-align: center;">
      </div>
      <div style="display: flex; justify-content: space-around; gap: 10px;">
        <button onclick="saveNewName()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">æ±ºå®š</button>
        <button onclick="closeNameEditModal()" style="background: #ccc; color: black; border: none; padding: 10px 20px; border-radius: 5px; flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="statsModal" class="overlay">
    <div class="modal-box" style="max-height: 80vh; display: flex; flex-direction: column;">
      <h2 style="margin-top: 0; color: #8b4513;">ã‚ãªãŸã®æˆ¦ç¸¾</h2>
      <div style="display: flex; justify-content: space-around; font-size: 24px; margin-bottom: 15px;">
        <div style="color: red;">å‹: <span id="statsWin">0</span></div>
        <div style="color: blue;">æ•—: <span id="statsLose">0</span></div>
      </div>
      <div style="text-align: left; background: white; border: 1px solid #ccc; flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px;">
        <ul id="statsHistory" style="list-style: none; padding: 0; margin: 0;"></ul>
      </div>
      <button onclick="closeStatsModal()" style="background: #ccc; border: none; color: black; padding: 10px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="lobbyChatModal" class="overlay">
    <div class="modal-box">
      <button class="close-small-btn" onclick="closeModal('lobbyChatModal')">é–‰ã˜ã‚‹</button>
      
      <h3 id="lobbyChatTitle">ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</h3>
      
      <div id="lobbyChatHistory"></div>
      
      <div class="chat-input-area">
        <input type="text" id="lobbyChatInput" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; font-size: 16px;">
        <button onclick="sendLobbyMessage()" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; font-weight:bold;">é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="practiceMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ç·´ç¿’ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
      <div class="modal-grid"> <button class="sub-btn" onclick="startGame('saijaku')">ãŸã‚ã‚€ã‚Œ (æœ€å¼±)</button>
        <button class="sub-btn" onclick="startGame('easy')">ãŠã‚ãã³ (å…¥é–€)</button>
        <button class="sub-btn" onclick="startGame('normal')">ãŸã—ãªã¿ (æ™®é€š)</button>
      </div> <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('practiceMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div id="onePlayerModeSelect" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">å¯¾å±€ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
      <div class="modal-grid"> <button class="sub-btn" onclick="startGame('hard1')">ã“ã¿ã‚„</button>
        <button class="sub-btn" onclick="startGame('hard2')">ã—ãŠã‚„</button>
        <button class="sub-btn" onclick="startGame('ex_hard1')">ã“ã¿ã‚„EX</button>
        <button class="sub-btn" onclick="startGame('ex_hard2')">ã—ãŠã‚„EX</button>
      </div> <button class="sub-btn" style="background:#d35400; margin-top: 5px;" onclick="startGame('ex_hard3')">è©¦é¨“å®Ÿè£… (æœ€å¼·)</button>
      <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('onePlayerModeSelect')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="helpMainMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #17a2b8; margin-top: 0;">ãƒ˜ãƒ«ãƒ—</h3>
      <div class="modal-grid">
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpMode')">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</button>
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpDifficulty')">é›£æ˜“åº¦ã«ã¤ã„ã¦</button>
        <button class="sub-btn" onclick="switchModal('helpMainMenu', 'helpChar')">ã‚­ãƒ£ãƒ©ã«ã¤ã„ã¦</button>
        <button class="sub-btn" style="background: #6f42c1;" onclick="switchModal('helpMainMenu', 'helpContact')">ä¸å…·åˆãƒ»è¦æœ›</button>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="closeModal('helpMainMenu')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="helpMode" class="overlay">
    <div class="modal-box" style="max-width: 350px;">
      <h3 style="color: #8b4513;">ãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</h3>
      <div style="text-align: left; font-size: 0.85rem; line-height: 1.5; overflow-y: auto; max-height: 50vh;">
        <p><strong>ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆã‚Œã‚“ã—ã‚…ã†ï¼ã²ã¨ã‚Šã§ï¼ãµãŸã‚Šã§ï¼‰</strong><br>CPUã¨ã®å¯¾å±€ãŒã§ãã¾ã™ã€‚ã“ã®ç«¯æœ«ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒå£«ã§ã‚‚å¯¾å±€ãŒã§ãã¾ã™ã€‚</p>
        <p><strong>ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</strong><br>é ãã«ã„ã‚‹äººã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ãŒã§ãã¾ã™ã€‚å…ˆã«å…¥å®¤ã—ãŸäººãŒå…ˆæ‰‹ã«ãªã‚Šã¾ã™ã€‚ã€Œå¾…ã£ãŸã€ãŒç¦æ­¢ã§ã™ã€‚</p>
        <p><strong>ãƒ»ãƒãƒ£ãƒƒãƒˆ</strong><br>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ­ãƒ“ãƒ¼ã«ã„ã‚‹äººãŸã¡ã¨ä¼šè©±ãŒã§ãã¾ã™ã€‚</p> <p><strong>ãƒ»è§£æ</strong><br>æ£‹è­œã‚’è²¼ã‚Šä»˜ã‘ã¦ã€è§£æã‚„æŒ¯ã‚Šè¿”ã‚ŠãŒã§ãã¾ã™ã€‚</p>
        <p><strong>ãƒ»æ£‹è­œ</strong><br>è‡ªèº«ã®éå»ã®æ£‹è­œãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚è§£æã‚„æŒ¯ã‚Šè¿”ã‚Šã‚‚ã§ãã¾ã™ã€‚â€»ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('helpMode', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="helpDifficulty" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin: 0 0 10px 0;">é›£æ˜“åº¦ã«ã¤ã„ã¦</h3>
      
      <div style="text-align: left; font-size: 0.85rem; line-height: 1.4;">
        <p style="margin: 0 0 5px 0;">CPUã®é›£æ˜“åº¦ã¯ã€ä¸‹ã«è¡Œãã»ã©å¼·ã„ã§ã™ã€‚</p>
        <ul style="padding-left: 20px; margin: 0 0 10px 0;">
          <li>ãŸã‚ã‚€ã‚Œ</li>
          <li>ãŠã‚ãã³</li>
          <li>ãŸã—ãªã¿</li>
          <li>ã—ãŠã‚„ / ã“ã¿ã‚„</li>
          <li>ã—ãŠã‚„EX / ã“ã¿ã‚„EX</li>
          <li style="font-weight: bold; color: #d35400;">è©¦é¨“å®Ÿè£…ï¼ˆæœ€å¼·ï¼‰</li>
        </ul>
        <p style="margin: 0; font-size: 0.75rem;">â€»ã—ãŠã‚„ç³»ã¨ã“ã¿ã‚„ç³»ã®å¼·ã•ã¯åŒã˜ã§ã™ãŒã€æ€§æ ¼ãŒç•°ãªã‚Šã¾ã™ã€‚</p>
      </div>
      
      <button class="sub-btn" style="background:#666; margin: 15px 0 0 0;" onclick="switchModal('helpDifficulty', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="helpChar" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¤ã„ã¦</h3>
      <div style="text-align: left; font-size: 0.9rem; line-height: 1.6;">
        <p>ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å¯¾å±€å‰ã«è‡ªèº«ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚</p>
        <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ãã‚Œãã‚Œç‹¬è‡ªã®<strong>ã€Œå¿…æ®ºæŠ€ã€</strong>ã‚’æŒã£ã¦ãŠã‚Šã€å¯¾å±€ã‚’æœ‰åˆ©ã«é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      </div>
      <button class="sub-btn" style="background:#666;" onclick="switchModal('helpChar', 'helpMainMenu')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="helpContact" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513;">ä¸å…·åˆãƒ»ã”è¦æœ›</h3>
    <div style="margin: 20px 0; line-height: 1.6;">
      <p>ã“ã¡ã‚‰ã‹ã‚‰ã„ã¤ã§ã‚‚å—ã‘ä»˜ã‘ã¦ãŠã‚Šã¾ã™ã€‚<br>ã¾ãŸã¯ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
      <button class="sub-btn" style="background: #28a745; margin-top: 10px;" 
        onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSc5Ry7hikuBYzDp7lTVLtO74zWabVlvvsjc3a0HgqrIuT8Dww/viewform', '_blank')">
        å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã â†—
      </button>
    </div>
    <button class="sub-btn" style="background:#666;" onclick="closeModal('helpContact')">é–‰ã˜ã‚‹</button>
  </div>
</div>

  <div id="offlineMenu" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å±€</h3>
      <div class="modal-grid"> <button class="sub-btn" onclick="goToCharacterSelect('practice')">ã‚Œã‚“ã—ã‚…ã†</button>
        <button class="sub-btn" onclick="goToCharacterSelect('cpu')">ã²ã¨ã‚Šã§</button>
        <button class="sub-btn" onclick="goToCharacterSelect('pvp')">ãµãŸã‚Šã§</button>
      </div> <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('offlineMenu')">æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="systemAlertModal" class="overlay" style="z-index: 200;">
    <div class="modal-box" style="max-width: 400px;">
      <h3 style="color: #8b4513; margin-top: 0;">ãŠçŸ¥ã‚‰ã›</h3>
      <p id="sysAlertMsg" style="margin: 20px 0; line-height: 1.5; white-space: pre-wrap;"></p>
      <button id="sysAlertBtn" style="background: #28a745; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">OK</button>
    </div>
  </div>

  <div id="systemConfirmModal" class="overlay" style="z-index: 200;">
    <div class="modal-box" style="max-width: 400px;">
      <h3 style="color: #8b4513; margin-top: 0;">ç¢ºèª</h3>
      <p id="sysConfirmMsg" style="margin: 20px 0; line-height: 1.5; white-space: pre-wrap;"></p>
      <div style="display: flex; justify-content: center; gap: 20px;">
        <button id="sysConfirmYesBtn" style="background: #007bff; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">ã¯ã„</button>
        <button id="sysConfirmNoBtn" style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer;">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <div id="characterSettingsMenu" class="overlay">
  <div class="modal-box">
    <h3 style="color: #8b4513; margin-top: 0;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h3>
    <p style="font-size:0.9rem;">ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’é¸ã¹ã¾ã™</p>
    
    <div class="modal-grid">
      <button class="sub-btn" onclick="changeCharacter('komiya')">ã‚­ãƒ£ãƒ©A</button>
      <button class="sub-btn" onclick="changeCharacter('a')">ã‚­ãƒ£ãƒ©B</button>
      <button class="sub-btn" onclick="changeCharacter('b')">ã‚­ãƒ£ãƒ©C</button>
      <button class="sub-btn" onclick="changeCharacter('d')">ã‚­ãƒ£ãƒ©D</button>
    </div>
    
    <button class="sub-btn" style="background:#666;" onclick="closeModal('characterSettingsMenu')">é–‰ã˜ã‚‹</button>
  </div>
</div>
  
  <script src="script/serifu/komiya.js"></script>
<script src="script/serifu/a.js"></script>
<script src="script/serifu/b.js"></script>
<script src="script/serifu/d.js"></script>
  <script src="script/auth.js"></script>
  <script>
    // --- â˜…â˜…â˜… ä¿®æ­£ç‚¹ï¼šSocket.ioåˆæœŸåŒ– â˜…â˜…â˜… ---
    let socket = null;
    let globalChatHistory = [];
    try {
        socket = io();
    } catch(e) {
        console.log("ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ");
    }

    // --- ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ---
    function showSystemAlert(msg, callback) {
        document.getElementById("sysAlertMsg").textContent = msg;
        const modal = document.getElementById("systemAlertModal");
        modal.style.display = "flex";
        const btn = document.getElementById("sysAlertBtn");
        btn.onclick = function() {
            modal.style.display = "none";
            if (callback) callback();
        };
    }

    function showSystemConfirm(msg, yesCallback, noCallback) {
        document.getElementById("sysConfirmMsg").textContent = msg;
        const modal = document.getElementById("systemConfirmModal");
        modal.style.display = "flex";
        document.getElementById("sysConfirmYesBtn").onclick = function() {
            modal.style.display = "none";
            if (yesCallback) yesCallback();
        };
        document.getElementById("sysConfirmNoBtn").onclick = function() {
            modal.style.display = "none";
            if (noCallback) noCallback();
        };
    }
    
    // --- å¾©å¸°æ©Ÿèƒ½ ---
    document.addEventListener("DOMContentLoaded", () => {
        const savedRoomId = localStorage.getItem('current_shogi_room');
        if (savedRoomId && socket) {
            if (socket.connected) {
                checkReconnection(savedRoomId);
            } else {
                socket.on('connect', () => {
                   checkReconnection(savedRoomId);
                });
            }
        }
        
        // â˜…â˜…â˜… è¿½åŠ ï¼šä¿å­˜ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ç”»åƒã‚’æ›´æ–°ã™ã‚‹å‡¦ç† â˜…â˜…â˜…
        const savedCharId = localStorage.getItem('selected_character_id');
        if (savedCharId && window.CHARACTERS && window.CHARACTERS[savedCharId]) {
            currentCharacterId = savedCharId; // IDã‚’æ›´æ–°
            const imgEl = document.querySelector('.character-stand');
            if (imgEl) {
                imgEl.src = window.CHARACTERS[savedCharId].image;
            }
        }
    });

    function checkReconnection(roomId) {
        socket.emit('check reconnection', roomId, (response) => {
            if (response.canReconnect) {
                showSystemConfirm(
                    "ä¸­æ–­ã•ã‚ŒãŸå¯¾å±€ãŒã‚ã‚Šã¾ã™ã€‚\nå¾©å¸°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã„ã„ãˆã€ã‚’é¸ã¶ã¨å¯¾å±€ã‚’ç ´æ£„ã—ã¾ã™ï¼‰",
                    () => { window.location.href = `player_vs_player_online.html?room=${roomId}`; },
                    () => { localStorage.removeItem('current_shogi_room'); }
                );
            } else {
                localStorage.removeItem('current_shogi_room');
            }
        });
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function switchModal(closeId, openId) { closeModal(closeId); openModal(openId); }

    function openAccountFromSettings() {
      closeModal('settingsMainMenu');
      showAuthModal(); 
    }

    // --- ç”»é¢é·ç§» ---
    function goToCharacterSelect(mode) { 
        if (mode === 'online') {
            const user = firebase.auth().currentUser;
            if (!user) {
                showSystemAlert("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚", () => {
                    showAuthModal(); 
                });
                return;
            }
        }
        window.location.replace("character.html?mode=" + mode);
    }

    function startGame(difficulty) {
      if (difficulty === 'ex_hard3') {
          window.location.replace("cpu_yaneuraou.html");
      } else {
          window.location.replace("game_cpu.html?opponent=" + difficulty);
      }
    }

    // --- â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ â˜…â˜…â˜… ---
    // ç¾åœ¨é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©IDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ komiyaï¼‰
    let currentCharacterId = localStorage.getItem('selected_character_id') || 'komiya';

    function changeCharacter(charId) {
        // å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸ CHARACTERS ãŒã‚ã‚‹ã‹ç¢ºèª
        if (!window.CHARACTERS || !window.CHARACTERS[charId]) {
            console.error("æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", charId);
            return;
        }

        // 1. IDã‚’æ›´æ–°ãƒ»ä¿å­˜
        currentCharacterId = charId;
        localStorage.setItem('selected_character_id', charId);

        // 2. ç”»åƒã‚’æ›´æ–°
        const imgEl = document.querySelector('.character-stand');
        if (imgEl) {
            imgEl.src = window.CHARACTERS[charId].image;
        }

        // 3. è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        switchModal('characterSettingsMenu', 'settingsMainMenu');

        // 4. åˆ‡ã‚Šæ›¿ãˆç›´å¾Œã«æŒ¨æ‹¶ã•ã›ã‚‹ï¼ˆãŠå¥½ã¿ã§ï¼‰
        setTimeout(talkCharacter, 500);
    }

    // --- â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å–‹ã‚Šæ©Ÿèƒ½ï¼ˆ{name}ç½®æ›å¯¾å¿œç‰ˆï¼‰ â˜…â˜…â˜… ---
    let bubbleTimer = null;
    
    function talkCharacter() {
        // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!window.CHARACTERS || !window.CHARACTERS[currentCharacterId]) return;

        const bubble = document.getElementById("characterBubble");
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
        const userName = document.getElementById("userNameDisplay").textContent || "ã‚²ã‚¹ãƒˆ";
        
        const now = new Date();
        const hour = now.getHours();

        // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const charData = window.CHARACTERS[currentCharacterId];

        // æ™‚é–“å¸¯åˆ¥ã®ã‚»ãƒªãƒ•ãƒªã‚¹ãƒˆã‚’å–å¾—
        let timeMessages = [];
        if (hour >= 5 && hour < 11) {
            timeMessages = charData.time.morning || [];
        } else if (hour >= 11 && hour < 17) {
            timeMessages = charData.time.noon || [];
        } else if (hour >= 17 && hour < 22) {
            timeMessages = charData.time.evening || [];
        } else {
            timeMessages = charData.time.night || [];
        }

        // åŸºæœ¬ã‚»ãƒªãƒ•ã¨çµåˆ
        const allMessages = (charData.base || []).concat(timeMessages);
        
        // ã‚»ãƒªãƒ•ãŒ1ã¤ã‚‚ãªã„å ´åˆã¯çµ‚äº†
        if (allMessages.length === 0) return;

        // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
        let rawMsg = allMessages[Math.floor(Math.random() * allMessages.length)];
        
        // â˜… {name} ã‚’ å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ç½®ãæ›ãˆã‚‹å‡¦ç†
        let finalMsg = rawMsg.split('{name}').join(userName);
        
        // è¡¨ç¤º
        bubble.textContent = finalMsg;
        bubble.style.display = "block";

        clearTimeout(bubbleTimer);
        bubbleTimer = setTimeout(() => {
            bubble.style.display = "none";
        }, 3000); // å°‘ã—é•·ã‚ã«è¡¨ç¤º(3ç§’)
    }

    // --- ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
    function openLobbyChat() {
        openModal('lobbyChatModal');
    }

    function sendLobbyMessage() {
        if (!socket) {
            showSystemAlert("ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
        }
        const input = document.getElementById("lobbyChatInput");
        const text = input.value.trim();
        if (!text) return;

        const myName = document.getElementById("userNameDisplay").textContent || "ã‚²ã‚¹ãƒˆ";
        socket.emit('chat message', {
            name: myName,
            text: text,
            role: 'lobby' 
        });
        input.value = "";
    }

    // ãƒãƒ£ãƒƒãƒˆå—ä¿¡å‡¦ç†
    if (socket) {
        socket.on('chat history', (history) => {
            globalChatHistory = history; 
            renderLobbyChat();            
        });
        socket.on('chat message', (data) => {
            globalChatHistory.push(data); 
            addMessageToLobbyChat(data); 
        });
    }

    function renderLobbyChat() {
        const historyDiv = document.getElementById("lobbyChatHistory");
        if (!historyDiv) return;
        historyDiv.innerHTML = ""; 
        globalChatHistory.forEach(data => {
            addMessageToLobbyChat(data);
        });
    }

    function addMessageToLobbyChat(data) {
        const historyDiv = document.getElementById("lobbyChatHistory");
        if (!historyDiv) return;

        const domName = document.getElementById("userNameDisplay").textContent;
        const storageName = localStorage.getItem('shogi_username');
        const isMe = (data.name.trim() === (domName || "").trim()) || 
                     (data.name.trim() === (storageName || "").trim());

        if (data.isSystem) {
            const sysDiv = document.createElement("div");
            sysDiv.className = "chat-system-box";
            sysDiv.textContent = data.text;
            historyDiv.appendChild(sysDiv);
        } else {
            const rowDiv = document.createElement("div");
            rowDiv.className = "chat-row";
            if (isMe) rowDiv.classList.add("mine");

            const iconCol = document.createElement("div");
            iconCol.className = "icon-container";

            const nameDiv = document.createElement("div");
            nameDiv.className = "chat-name-badge";
            nameDiv.textContent = data.name;

            const iconImg = document.createElement("img");
            iconImg.src = "script/image/test.icon.PNG"; 
            iconImg.className = "chat-icon-img";
            iconImg.onerror = function() { this.style.backgroundColor = "#ccc"; };

            iconCol.appendChild(nameDiv);
            iconCol.appendChild(iconImg);

            const bubbleDiv = document.createElement("div");
            bubbleDiv.className = "chat-bubble";
            bubbleDiv.textContent = data.text;

            rowDiv.appendChild(iconCol);
            rowDiv.appendChild(bubbleDiv);
            historyDiv.appendChild(rowDiv);
        }
        historyDiv.scrollTop = historyDiv.scrollHeight;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const lobbyInput = document.getElementById("lobbyChatInput");
        if (lobbyInput) {
            lobbyInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendLobbyMessage();
            });
        }
    });

    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const openMenuId = urlParams.get('open');
      if (openMenuId) {
        const menuEl = document.getElementById(openMenuId);
        if (menuEl) {
          menuEl.style.display = 'flex';
          if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.pathname);
          }
        }
      }
    };

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            setTimeout(() => {
                renderLobbyChat();
            }, 500); 

            // â˜…â˜…â˜… è¿½åŠ ï¼šæ‰€æŒé‡‘ (gold) ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã—ã¦è¡¨ç¤ºæ›´æ–° â˜…â˜…â˜…
            db.collection("users").doc(user.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const currentGold = data.gold || 0;
                    const goldEl = document.getElementById("userGoldDisplay");
                    if (goldEl) {
                        goldEl.textContent = currentGold.toLocaleString(); // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¡¨ç¤º (ä¾‹: 1,500)
                    }
                }
            });
        } else {
            // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ 0 G ã«æˆ»ã™
            const goldEl = document.getElementById("userGoldDisplay");
            if (goldEl) goldEl.textContent = "0";
        }
    });

    // --- ç”»é¢å›è»¢ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ ---
    function autoRotateTitle() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const isPortrait = h > w;
        if (isPortrait) {
            document.body.style.width = h + "px";
            document.body.style.height = w + "px";
            document.body.style.transform = "translate(-50%, -50%) rotate(90deg)";
            document.body.style.position = "fixed";
            document.body.style.top = "50%";
            document.body.style.left = "50%";
        } else {
            document.body.style.width = "100%";
            document.body.style.height = "100%";
            document.body.style.transform = "";
            document.body.style.top = "0";
            document.body.style.left = "0";
        }
    }

    window.addEventListener('load', () => {
        autoRotateTitle();
        window.addEventListener('resize', autoRotateTitle);
        window.addEventListener('contextmenu', (e) => e.preventDefault());

        history.pushState(null, null, location.href);
        window.addEventListener('popstate', (e) => {
            history.pushState(null, null, location.href);
        });

        let startX = 0;
        let startY = 0;

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) return;
            startX = e.touches[0].pageX;
            startY = e.touches[0].pageY;
            if (startX < 30 || startX > window.innerWidth - 30) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) return;
            const x = e.touches[0].pageX;
            const y = e.touches[0].pageY;
            const deltaX = Math.abs(x - startX);
            const deltaY = Math.abs(y - startY);
            const isScrollable = e.target.closest('#lobbyChatHistory, .modal-box, #statsHistory, .help-content');

            if (isScrollable) {
                e.stopPropagation(); 
            } else {
                e.preventDefault();
            }
            if (deltaX > deltaY && deltaX > 10) {
                e.preventDefault();
            }
        }, { passive: false });
    });
</script>

</body>
</html>









