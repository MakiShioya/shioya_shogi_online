<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>„Åó„Åä„ÇÑÂ∞ÜÊ£ã - „Éï„É¨„É≥„Éâ</title>
  
  <link rel="preload" href="script/font/setofont.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="icon" href="script/image/komiya_icon.png"> 
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
    @font-face {
      font-family: 'SetoFont';
      src: url('script/font/setofont.ttf') format('truetype');
      font-display: block;
    }

    * {
      font-family: 'SetoFont', "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      box-sizing: border-box;
    }
    
    body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      position: fixed; background-color: #2c3e50;
      overflow: hidden; overscroll-behavior: none;
      -webkit-user-select: none; user-select: none; touch-action: none;
    }

    input, textarea {
      user-select: text; -webkit-user-select: text; touch-action: auto;
    }

    #bg-image {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1;
      background-image: linear-gradient(rgba(44, 62, 80, 0.6), rgba(44, 62, 80, 0.6)), url('script/image/shogi_title.PNG');
      background-size: cover; background-position: center;
    }

    /* --- „É≠„Éº„ÉâÁîªÈù¢ --- */
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #432517;
      display: flex; justify-content: center; align-items: center;
      z-index: 9999; transition: opacity 0.5s ease;
    }
    .loader-content { text-align: center; color: #ECDBBF; }
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid rgba(236, 219, 191, 0.3);
      border-top: 5px solid #ECDBBF; border-radius: 50%;
      animation: spin 1s linear infinite; margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loading-tips {
      margin-top: 20px; padding: 10px 20px;
      background: rgba(236, 219, 191, 0.1);
      border-radius: 10px; font-size: 0.9rem; max-width: 250px;
      line-height: 1.5; min-height: 3em; color: #ECDBBF;
    }

    /* --- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ --- */
    .container {
      width: 95%; max-width: 600px; margin: 20px auto;
      height: 80vh; 
      display: flex; flex-direction: column;
    }

    /* Ê§úÁ¥¢„Ç®„É™„Ç¢ */
    .search-area {
      background: rgba(236, 219, 191, 0.95);
      border: 3px solid #8b4513; border-radius: 10px;
      padding: 10px; display: flex; gap: 5px; align-items: center;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .search-input {
      flex: 1; padding: 8px; border: 1px solid #8b4513; border-radius: 5px;
      font-size: 1rem; font-family: "SetoFont";
    }
    .search-btn {
      background: #432517; color: #ECDBBF; border: none;
      padding: 8px 15px; border-radius: 5px; cursor: pointer;
      font-weight: bold;
    }

    /* „Çø„Éñ„Å®„É™„Çπ„Éà */
    .tab-container {
      display: flex;
      padding-left: 10px;
      align-items: flex-end;
      position: relative;
      z-index: 1;
      margin-bottom: -3px;
    }

    .tab-btn {
      flex: 1; padding: 10px 0;
      border: 3px solid #8b4513;
      background: #6d4c41; color: #ccc;
      border-radius: 10px 10px 0 0;
      cursor: pointer; font-weight: bold; font-size: 0.9rem;
      position: relative; margin-right: -2px;
      transition: background 0.2s;
      height: 45px;
    }

    .tab-btn.active {
      background: #ECDBBF; color: #432517;
      border-bottom: 3px solid #ECDBBF; 
      z-index: 10; height: 50px; 
    }

    .list-container {
      flex: 1; background: #ECDBBF;
      border: 3px solid #8b4513; 
      border-radius: 0 10px 10px 10px;
      padding: 10px; overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
      position: relative; z-index: 5;
    }
    
    .list-view { display: none; }
    .list-view.active { display: block; }

    /* „Éï„É¨„É≥„Éâ„É™„Çπ„Éà„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Éá„Ç∂„Ç§„É≥ */
    .friend-item {
      background: rgba(255,255,255,0.6);
      border: 1px solid #8b4513; border-radius: 8px;
      padding: 10px; margin-bottom: 8px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .friend-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .friend-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ccc; border: 2px solid #8b4513; object-fit: cover; }
    .friend-name { font-weight: bold; color: #432517; font-size: 1.1rem; }
    .friend-status { font-size: 0.8rem; color: #666; margin-left: auto; margin-right: 10px;}
    
    .action-btn {
      padding: 6px 12px; border-radius: 5px; border: none;
      font-size: 0.8rem; font-weight: bold; cursor: pointer; margin-left: 5px;
    }
    .btn-accept { background: #28a745; color: white; }
    .btn-reject { background: #d32f2f; color: white; }
    .btn-cancel { background: #666; color: white; }
    
    .empty-msg { text-align: center; color: #888; margin-top: 30px; }

    /* ‰∏ãÈÉ®„É°„Éã„É•„Éº */
    .bottom-menu {
      position: absolute; bottom: 10px; width: 96%; left: 2%;
      display: flex; justify-content: space-around; align-items: flex-end; gap: 5px;
      z-index: 20;
    }
    .menu-btn {
      flex: 1; height: 60px; border-radius: 10px;
      color: #ECDBBF; font-weight: bold; font-size: 1.1rem;
      cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      text-shadow: 1px 1px 2px #432517;
      display: flex; justify-content: center; align-items: center;
    }
    .menu-btn:active { transform: scale(0.95); }

    .mypage-color { background: linear-gradient(to bottom, #6C4B9C 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .analysis-color { background: linear-gradient(to bottom, #4B6C9C 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .ready-color { background: linear-gradient(to bottom, #7B9C4B 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .menu-color { background: linear-gradient(to bottom, #9C804B 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .chat-color { background: linear-gradient(to bottom, #747474 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }

    /* „É¢„Éº„ÉÄ„É´ */
    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 100;
      justify-content: center; align-items: center;
    }
    .modal-box {
      position: relative; background: #fff8dc; padding: 15px;
      border-radius: 10px; border: 4px solid #8b4513;
      text-align: center; width: 90%; max-width: 500px;
      display: flex; flex-direction: column;
    }
    .close-modal-btn {
      background: #666; color: white; border: none; padding: 8px 15px;
      border-radius: 5px; cursor: pointer; margin-top: 10px;
    }

    /* „ÉÅ„É£„ÉÉ„ÉàÁî®„Çπ„Çø„Ç§„É´ */
    .close-small-btn {
      position: absolute; top: 8px; right: 8px; padding: 4px 10px;
      background: #666; color: #ECDBBF; border: none; border-radius: 12px;
      font-size: 0.75rem; font-weight: bold; cursor: pointer; z-index: 101;
    }
    #lobbyChatHistory {
      height: 60vh; overflow-y: auto; background: rgba(255, 255, 255, 0.5);
      border: 1px solid #ccc; padding: 8px; border-radius: 8px; margin-top: 10px;
      display: flex; flex-direction: column; gap: 5px;
    }
    .chat-row { display: flex; align-items: flex-start; gap: 10px; }
    .chat-row.mine { align-self: flex-end; flex-direction: row-reverse; }
    .icon-container { display: flex; flex-direction: column; align-items: center; width: 60px; }
    .chat-name-badge {
      background: #ECDBBF; border: 1px solid #8b4513; border-radius: 10px;
      z-index: 2; margin-bottom: -10px; width: 50px; height: 18px;
      display: flex; justify-content: center; align-items: center; padding: 0 4px; overflow: hidden;
    }
    .chat-name-text {
      font-size: 12px; font-weight: bold; fill: #333;
      text-anchor: middle; dominant-baseline: central;
    }
    .chat-icon-img { 
      width: 50px; height: 50px; border: 3px solid #56ab2f; border-radius: 12px; 
      background: #ECDBBF; object-fit: cover; 
    }
    .chat-row.mine .chat-icon-img { border: 3px solid #FFA500; }
    .chat-bubble { 
      position: relative; padding: 10px; border-radius: 15px; 
      font-size: 0.75rem; font-weight: bold; margin-top: 5px; 
      word-break: break-all; text-align: left;
    }
    .chat-row .chat-bubble { background: #ECDBBF; border: 2px solid #e0e0e0; border-top-left-radius: 0; }
    .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; border-top-right-radius: 0; }
    .chat-input-area { display: flex; gap: 5px; margin-top: 10px; }
    #lobbyChatModal .modal-box { height: 85vh; max-width: 800px; }
  </style>
</head>
<body>

  <div id="loading-screen">
    <div class="loader-content">
      <div class="spinner"></div>
      <div id="loading-tips"></div>
      <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.8;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
    </div>
  </div>

  <div id="bg-image"></div>

  <div class="container">
    <div class="search-area">
      <span style="font-weight:bold; color:#432517;">üîç</span>
      <input type="text" id="searchInput" class="search-input" placeholder="ID„ÇíÂÖ•Âäõ„Åó„Å¶Ê§úÁ¥¢">
      <button class="search-btn" onclick="searchUser()">Ê§úÁ¥¢</button>
    </div>

    <div class="tab-container">
      <button class="tab-btn active" onclick="switchTab('list')">„Éï„É¨„É≥„Éâ‰∏ÄË¶ß</button>
      <button class="tab-btn" onclick="switchTab('pending')">Áî≥Ë´ã‰∏≠</button>
      <button class="tab-btn" onclick="switchTab('request')">„É™„ÇØ„Ç®„Çπ„Éà</button>
    </div>

    <div class="list-container">
      <div id="tab-list" class="list-view active">
        <div class="empty-msg">„Éï„É¨„É≥„Éâ„Åå„ÅÑ„Åæ„Åõ„Çì</div>
        <div id="friendListContent"></div>
      </div>
      <div id="tab-pending" class="list-view">
        <div class="empty-msg">Áî≥Ë´ã‰∏≠„ÅÆ„É¶„Éº„Ç∂„Éº„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>
        <div id="pendingListContent"></div>
      </div>
      <div id="tab-request" class="list-view">
        <div class="empty-msg">Â±ä„ÅÑ„Å¶„ÅÑ„Çã„É™„ÇØ„Ç®„Çπ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        <div id="requestListContent"></div>
      </div>
    </div>
  </div>

  <div class="bottom-menu">
    <button class="menu-btn mypage-color" onclick="window.location.href='home.html'">„Éõ„Éº„É†</button>
    <button class="menu-btn analysis-color" onclick="window.location.href='mypage.html'">ÂØæÂ±ÄÂ±•Ê≠¥</button>
    <button class="menu-btn ready-color" onclick="window.location.href='new_mypage.html'">„Éû„Ç§„Éö„Éº„Ç∏</button>
    <button class="menu-btn menu-color" onclick="window.location.href='collection.html'">ÊâÄÊåÅÂìÅ</button>
    <button class="menu-btn chat-color" onclick="openLobbyChat()">„ÉÅ„É£„ÉÉ„Éà</button>
  </div>

  <div id="searchResultModal" class="overlay">
    <div class="modal-box" style="height: auto; min-height: 200px;">
      <h3 style="color:#8b4513;">„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü</h3>
      <div style="margin: 20px 0;">
        <div style="font-size:1.5rem; font-weight:bold; color:#d35400;" id="foundUserName">ÂêçÁß∞</div>
        <div style="color:#666;" id="foundUserId">ID: ---</div>
      </div>
      <button id="sendRequestBtn" style="background:#28a745; color:white; border:none; padding:10px; border-radius:5px; font-weight:bold; font-size:1rem; cursor:pointer;">Áî≥Ë´ã„ÇíÈÄÅ„Çã</button>
      <button class="close-modal-btn" onclick="closeModal('searchResultModal')">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <div id="lobbyChatModal" class="overlay">
    <div class="modal-box">
      <button class="close-small-btn" onclick="closeModal('lobbyChatModal')">Èñâ„Åò„Çã</button>
      <h3 style="color:#005bea; margin:0 0 5px 0; text-align:left; padding-left: 5px; font-size: 0.9rem;">„É≠„Éì„Éº„ÉÅ„É£„ÉÉ„Éà</h3>
      <div id="lobbyChatHistory"></div>
      <div class="chat-input-area">
        <input type="text" id="lobbyChatInput" placeholder="„Åì„Åì„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; font-size: 16px;">
        <button onclick="sendLobbyMessage()" style="background:#28a745; color:#ECDBBF; border:none; padding:10px 15px; border-radius:5px; font-weight:bold;">ÈÄÅ‰ø°„Åô„Çã</button>
      </div>
    </div>
  </div>

  <script src="script/auth.js"></script>

  <script>
    // --- „É≠„Éº„ÉâÁîªÈù¢ ---
    const loadingTipsList = [
      "„Äêtips„ÄëID„Çí‰Ωø„Å£„Å¶ÈÅ†„Åè„ÅÆÂèãÈÅî„Å®„Å§„Å™„Åå„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ",
      "„Äêtips„Äë„Éï„É¨„É≥„Éâ„Å´„Å™„Çã„Å®„ÄÅ„ÅÑ„Å§„Åß„ÇÇ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ",
      "„Äêtips„ÄëÂØæÂ±ÄÂ±•Ê≠¥„Åã„ÇâÁõ∏Êâã„ÅÆID„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ"
    ];
    document.addEventListener("DOMContentLoaded", () => {
        const tipEl = document.getElementById('loading-tips');
        if(tipEl) tipEl.textContent = loadingTipsList[Math.floor(Math.random() * loadingTipsList.length)];
    });
    window.addEventListener('load', () => {
        const loader = document.getElementById('loading-screen');
        setTimeout(() => {
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
        }, 800);
    });

    // --- „Çø„ÉñÂàá„ÇäÊõø„Åà ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.list-view').forEach(div => div.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
    }

    // --- „É¢„Éº„ÉÄ„É´ ---
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- ‚òÖ‚òÖ‚òÖ Ê§úÁ¥¢Ê©üËÉΩ & Áî≥Ë´ãÈÄÅ‰ø°„É≠„Ç∏„ÉÉ„ÇØ („Åì„Åì„Çí‰øÆÊ≠£) ‚òÖ‚òÖ‚òÖ ---
    async function searchUser() {
        const input = document.getElementById('searchInput').value.trim();
        if (!input) return;
        
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) { alert("„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô"); return; }
        if (input === currentUser.uid) { alert("Ëá™ÂàÜËá™Ë∫´„Åß„Åô"); return; }

        try {
            const docRef = db.collection("users").doc(input);
            const doc = await docRef.get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('foundUserName').textContent = data.name || "ÂêçÁÑ°„Åó";
                document.getElementById('foundUserId').textContent = "ID: " + input;
                const btn = document.getElementById('sendRequestBtn');
                btn.onclick = () => sendFriendRequest(input, data.name || "ÂêçÁÑ°„Åó");
                document.getElementById('searchResultModal').style.display = 'flex';
            } else {
                alert("„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü");
            }
        } catch(e) {
            console.error(e);
            alert("Ê§úÁ¥¢„Ç®„É©„Éº");
        }
    }

    // ‚òÖ‰øÆÊ≠£Áâà: ÂÆüÈöõ„Å´Firestore„Å´Êõ∏„ÅçËæº„ÇÄÈñ¢Êï∞
    async function sendFriendRequest(targetUid, targetName) {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) return;

        try {
            const batch = db.batch();
            
            // 1. Áõ∏Êâã„ÅÆÂèó‰ø°ÁÆ±(received_requests)„Å´Ëá™ÂàÜ„ÇíËøΩÂä†
            // Ê≥®ÊÑè: Ëá™ÂàÜ„ÅÆÂêçÂâç„ÇíÂèñÂæó„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ‰∏ÄÊó¶Ëá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„Çã„Åã„ÄÅauth.currentUser.displayName„Çí‰Ωø„ÅÜ
            // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´„ÄåÁî≥Ë´ãËÄÖ„Äç„Å®„Åó„Å¶ID„ÇíË®òÈå≤„Åó„ÄÅË™≠„ÅøËæº„ÅøÊôÇ„Å´ÂêçÂâç„ÇíËß£Ê±∫„Åô„ÇãÊñπÂºè„Åã„ÄÅ
            // Ëá™ÂàÜ„ÅÆÂêçÂâç„Çí‰øùÊåÅ„Åó„Å¶„ÅÑ„ÇãÂ§âÊï∞„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰Ωø„ÅÜÔºà‰ªäÂõû„ÅØauth.jsÁ≠â„ÅÆÂÆüË£Ö‰æùÂ≠ò„Å™„ÅÆ„ÅßID„É°„Ç§„É≥„Åß‰øùÂ≠òÔºâ
            
            // Ëá™ÂàÜ„ÅÆÂêçÂâç„ÇíÂèñÂæóÔºàÈùûÂêåÊúüÔºâ
            const myDoc = await db.collection("users").doc(currentUser.uid).get();
            const myName = myDoc.exists ? (myDoc.data().name || "ÂêçÁÑ°„Åó") : "ÂêçÁÑ°„Åó";

            const targetRef = db.collection("users").doc(targetUid).collection("received_requests").doc(currentUser.uid);
            batch.set(targetRef, {
                fromUid: currentUser.uid,
                fromName: myName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // 2. Ëá™ÂàÜ„ÅÆÈÄÅ‰ø°Ê∏à„ÅøÁÆ±(sent_requests)„Å´Áõ∏Êâã„ÇíËøΩÂä†
            const myRef = db.collection("users").doc(currentUser.uid).collection("sent_requests").doc(targetUid);
            batch.set(myRef, {
                toUid: targetUid,
                toName: targetName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await batch.commit();

            alert("Áî≥Ë´ã„ÇíÈÄÅ„Çä„Åæ„Åó„ÅüÔºÅ");
            closeModal('searchResultModal');
            
            // Áî≥Ë´ã‰∏≠„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà„Å¶Á¢∫Ë™ç„Åï„Åõ„Çã
            switchTab('pending');

        } catch(e) {
            console.error(e);
            alert("Áî≥Ë´ã„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + e.message);
        }
    }

    // --- ‚òÖ‚òÖ‚òÖ „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñÊ©üËÉΩ („É™„Çπ„Éà„ÅÆËá™ÂãïÊõ¥Êñ∞) ‚òÖ‚òÖ‚òÖ ---
    
    let unsubscribeSent = null;
    let unsubscribeReceived = null;
    let unsubscribeFriends = null;

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            initFriendLists(user.uid);
            // „ÉÅ„É£„ÉÉ„ÉàÂàùÊúüÂåñ
            initLobbyChat();
        } else {
            // Êú™„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅØ„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.list-view div[id$="Content"]').forEach(el => el.innerHTML = "");
        }
    });

    function initFriendLists(uid) {
        // 1. Áî≥Ë´ã‰∏≠ (Sent) „ÅÆÁõ£Ë¶ñ
        if(unsubscribeSent) unsubscribeSent();
        unsubscribeSent = db.collection("users").doc(uid).collection("sent_requests")
            .orderBy("timestamp", "desc")
            .onSnapshot(snapshot => {
                const container = document.getElementById("pendingListContent");
                container.innerHTML = "";
                const emptyMsg = document.querySelector("#tab-pending .empty-msg");
                
                if (snapshot.empty) {
                    emptyMsg.style.display = "block";
                } else {
                    emptyMsg.style.display = "none";
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement("div");
                        div.className = "friend-item";
                        div.innerHTML = `
                            <div class="friend-info">
                                <div class="friend-avatar"></div>
                                <div class="friend-name">${data.toName}</div>
                            </div>
                            <button class="action-btn btn-cancel" onclick="cancelRequest('${doc.id}')">ÂèñÊ∂à</button>
                        `;
                        container.appendChild(div);
                    });
                }
            });

        // 2. „É™„ÇØ„Ç®„Çπ„Éà (Received) „ÅÆÁõ£Ë¶ñ
        if(unsubscribeReceived) unsubscribeReceived();
        unsubscribeReceived = db.collection("users").doc(uid).collection("received_requests")
            .orderBy("timestamp", "desc")
            .onSnapshot(snapshot => {
                const container = document.getElementById("requestListContent");
                container.innerHTML = "";
                const emptyMsg = document.querySelector("#tab-request .empty-msg");
                
                if (snapshot.empty) {
                    emptyMsg.style.display = "block";
                } else {
                    emptyMsg.style.display = "none";
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement("div");
                        div.className = "friend-item";
                        div.innerHTML = `
                            <div class="friend-info">
                                <div class="friend-avatar"></div>
                                <div class="friend-name">${data.fromName}</div>
                            </div>
                            <div>
                                <button class="action-btn btn-accept" onclick="acceptRequest('${doc.id}', '${data.fromName}')">ÊâøË™ç</button>
                                <button class="action-btn btn-reject" onclick="rejectRequest('${doc.id}')">ÊãíÂê¶</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            });

        // 3. „Éï„É¨„É≥„Éâ‰∏ÄË¶ß (friends) „ÅÆÁõ£Ë¶ñ
        // „Åì„Åì„Åß„ÅØ users/{uid}/friends „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÇíÊÉ≥ÂÆö
        if(unsubscribeFriends) unsubscribeFriends();
        unsubscribeFriends = db.collection("users").doc(uid).collection("friends")
            .onSnapshot(snapshot => {
                const container = document.getElementById("friendListContent");
                container.innerHTML = "";
                const emptyMsg = document.querySelector("#tab-list .empty-msg");
                
                if (snapshot.empty) {
                    emptyMsg.style.display = "block";
                } else {
                    emptyMsg.style.display = "none";
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement("div");
                        div.className = "friend-item";
                        // „ÇØ„É™„ÉÉ„ÇØ„ÅßÁõ∏Êâã„ÅÆ„Éû„Ç§„Éö„Éº„Ç∏„Å∏
                        div.innerHTML = `
                            <div class="friend-info" onclick="location.href='new_mypage.html?uid=${doc.id}'">
                                <div class="friend-avatar"></div>
                                <div class="friend-name">${data.name}</div>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            });
    }

    // --- ÂêÑÁ®Æ„Ç¢„ÇØ„Ç∑„Éß„É≥ (ÂèñÊ∂à„ÉªÊâøË™ç„ÉªÊãíÂê¶) ---
    async function cancelRequest(targetUid) {
        if(!confirm("Áî≥Ë´ã„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºü")) return;
        const myUid = firebase.auth().currentUser.uid;
        const batch = db.batch();
        batch.delete(db.collection("users").doc(myUid).collection("sent_requests").doc(targetUid));
        batch.delete(db.collection("users").doc(targetUid).collection("received_requests").doc(myUid));
        await batch.commit();
    }

    async function rejectRequest(targetUid) {
        if(!confirm("Áî≥Ë´ã„ÇíÊãíÂê¶„Åó„Åæ„Åô„ÅãÔºü")) return;
        const myUid = firebase.auth().currentUser.uid;
        const batch = db.batch();
        batch.delete(db.collection("users").doc(myUid).collection("received_requests").doc(targetUid));
        batch.delete(db.collection("users").doc(targetUid).collection("sent_requests").doc(myUid));
        await batch.commit();
    }

    async function acceptRequest(targetUid, targetName) {
        const myUid = firebase.auth().currentUser.uid;
        
        // Ëá™ÂàÜ„ÅÆÂêçÂâç„ÇíÂèñÂæó
        const myDoc = await db.collection("users").doc(myUid).get();
        const myName = myDoc.data().name || "ÂêçÁÑ°„Åó";

        const batch = db.batch();

        // 1. „Åä‰∫í„ÅÑ„ÅÆ friends „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Å´ËøΩÂä†
        batch.set(db.collection("users").doc(myUid).collection("friends").doc(targetUid), {
            name: targetName,
            since: firebase.firestore.FieldValue.serverTimestamp()
        });
        batch.set(db.collection("users").doc(targetUid).collection("friends").doc(myUid), {
            name: myName,
            since: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Áî≥Ë´ã„Éá„Éº„Çø„ÇíÂâäÈô§
        batch.delete(db.collection("users").doc(myUid).collection("received_requests").doc(targetUid));
        batch.delete(db.collection("users").doc(targetUid).collection("sent_requests").doc(myUid));

        await batch.commit();
        alert("„Éï„É¨„É≥„Éâ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ");
        switchTab('list');
    }

    // --- „ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ ---
    let chatUnsubscribe = null;
    function openLobbyChat() {
      document.getElementById('lobbyChatModal').style.display = 'flex';
      initLobbyChat();
    }
    function initLobbyChat() {
        const historyDiv = document.getElementById("lobbyChatHistory");
        if (!historyDiv) return;
        if (chatUnsubscribe) return; 
        chatUnsubscribe = db.collection("lobby_chat").orderBy("createdAt", "desc").limit(50).onSnapshot((snapshot) => {
            const historyDiv = document.getElementById("lobbyChatHistory");
            let messages = [];
            snapshot.forEach(doc => { const data = doc.data(); data.id = doc.id; messages.push(data); });
            historyDiv.innerHTML = "";
            messages.forEach(msg => addMessageToLobbyChatFirestore(msg));
            historyDiv.scrollTop = 0;
        });
    }
    function addMessageToLobbyChatFirestore(data) {
        const historyDiv = document.getElementById("lobbyChatHistory");
        const user = firebase.auth().currentUser;
        const currentMyId = user ? user.uid : null;
        const isMe = (data.userId === currentMyId);

        const rowDiv = document.createElement("div");
        rowDiv.className = "chat-row" + (isMe ? " mine" : "");

        const iconCol = document.createElement("div");
        iconCol.className = "icon-container";
        const nameDiv = document.createElement("div");
        nameDiv.className = "chat-name-badge";
        const safeName = data.name || "ÂêçÁÑ°„Åó";
        const textWidth = Math.max(80, safeName.length * 12); 
        nameDiv.innerHTML = `<svg viewBox="0 0 ${textWidth} 20" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"><text x="50%" y="50%" class="chat-name-text">${safeName}</text></svg>`;
        const iconImg = document.createElement("img");
        iconImg.src = data.icon || "script/image/test.icon.PNG";
        iconImg.className = "chat-icon-img";
        iconImg.onerror = function() { this.style.backgroundColor = "#ccc"; };
        iconCol.appendChild(nameDiv); iconCol.appendChild(iconImg);

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "chat-bubble";
        bubbleDiv.textContent = data.text;

        rowDiv.appendChild(iconCol); rowDiv.appendChild(bubbleDiv);
        historyDiv.appendChild(rowDiv);
    }
    function sendLobbyMessage() {
        const input = document.getElementById("lobbyChatInput");
        if (!input.value.trim()) return;
        const user = firebase.auth().currentUser;
        let myName = "„Ç≤„Çπ„Éà";
        let myId = "guest";
        
        if(user) {
             myId = user.uid;
             // Á∞°ÊòìÁöÑ„Å´DOM„Åã„ÇâÂèñÂæó„Åô„Çã„Åã„ÄÅFirestore„Åã„ÇâÂèñ„Çã„Åã„ÄÇ„Åì„Åì„Åß„ÅØDOM„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰Ωø„ÅÜ
             const nameEl = document.getElementById("userNameDisplay"); // friend.html„Å´„ÅØ„Å™„ÅÑ„ÅÆ„ÅßÊ≥®ÊÑè
             myName = nameEl ? nameEl.textContent : "ÂêçÁÑ°„Åó";
        }

        db.collection("lobby_chat").add({
            text: input.value, name: myName, userId: myId, icon: "script/image/test.icon.PNG",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), role: 'lobby'
        });
        input.value = "";
    }
    document.getElementById("lobbyChatInput").addEventListener("keypress", (e) => { if (e.key === "Enter") sendLobbyMessage(); });
  </script>
</body>
</html>
