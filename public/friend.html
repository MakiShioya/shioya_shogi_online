<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>ã—ãŠã‚„å°†æ£‹ - ãƒ•ãƒ¬ãƒ³ãƒ‰</title>
  
  <link rel="preload" href="script/font/setofont.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="icon" href="script/image/komiya_icon.png"> 
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* --- åŸºæœ¬è¨­å®š --- */
    @font-face {
      font-family: 'SetoFont';
      src: url('script/font/setofont.ttf') format('truetype');
      font-display: block;
    }

    * {
      font-family: 'SetoFont', "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      box-sizing: border-box;
    }
    
    body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      position: fixed; background-color: #2c3e50;
      overflow: hidden; overscroll-behavior: none;
      -webkit-user-select: none; user-select: none; touch-action: none;
    }

    input, textarea {
      user-select: text; -webkit-user-select: text; touch-action: auto;
    }

    /* èƒŒæ™¯ */
    #bg-image {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1;
      background-image: linear-gradient(rgba(44, 62, 80, 0.6), rgba(44, 62, 80, 0.6)), url('script/image/shogi_title.PNG');
      background-size: cover; background-position: center;
    }

    /* --- ãƒ­ãƒ¼ãƒ‰ç”»é¢ --- */
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #432517;
      display: flex; justify-content: center; align-items: center;
      z-index: 9999; transition: opacity 0.5s ease;
    }
    .loader-content { text-align: center; color: #ECDBBF; }
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid rgba(236, 219, 191, 0.3);
      border-top: 5px solid #ECDBBF; border-radius: 50%;
      animation: spin 1s linear infinite; margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loading-tips {
      margin-top: 20px; padding: 10px 20px;
      background: rgba(236, 219, 191, 0.1);
      border-radius: 10px; font-size: 0.9rem; max-width: 250px;
      line-height: 1.5; min-height: 3em; color: #ECDBBF;
    }

    /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
    .container {
      width: 95%; max-width: 600px; margin: 20px auto;
      height: 80vh; 
      display: flex; flex-direction: column;
      /* gapã¯å‰Šé™¤ã—ã€å€‹åˆ¥ã«ãƒãƒ¼ã‚¸ãƒ³åˆ¶å¾¡ã—ã¦ãã£ã¤ã‘ã‚‹ */
    }

    /* æ¤œç´¢ã‚¨ãƒªã‚¢ */
    .search-area {
      background: rgba(236, 219, 191, 0.95);
      border: 3px solid #8b4513; border-radius: 10px;
      padding: 10px; display: flex; gap: 5px; align-items: center;
      margin-bottom: 15px; /* ã‚¿ãƒ–ã¨ã®éš™é–“ */
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .search-input {
      flex: 1; padding: 8px; border: 1px solid #8b4513; border-radius: 5px;
      font-size: 1rem; font-family: "SetoFont";
    }
    .search-btn {
      background: #432517; color: #ECDBBF; border: none;
      padding: 8px 15px; border-radius: 5px; cursor: pointer;
      font-weight: bold;
    }

    /* --- â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ï¼šã‚¿ãƒ–ã¨ãƒªã‚¹ãƒˆã®ä¸€ä½“åŒ–ãƒ‡ã‚¶ã‚¤ãƒ³ â˜…â˜…â˜… --- */
    
    .tab-container {
      display: flex;
      padding-left: 10px; /* å·¦ç«¯ã‚’å°‘ã—ç©ºã‘ã‚‹ */
      align-items: flex-end; /* ä¸‹æƒãˆ */
      position: relative;
      z-index: 1; /* ãƒªã‚¹ãƒˆã‚ˆã‚Šå¥¥ã«é…ç½® */
      margin-bottom: -3px; /* ãƒªã‚¹ãƒˆã®æ ç·šåˆ†ã ã‘é£Ÿã„è¾¼ã¾ã›ã‚‹ */
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border: 3px solid #8b4513; /* æ ç·š */
      background: #6d4c41; /* éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯æš—ã */
      color: #ccc;
      border-radius: 10px 10px 0 0; /* ä¸Šã ã‘ä¸¸ã */
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      position: relative;
      margin-right: -2px; /* ã‚¿ãƒ–åŒå£«ã®éš™é–“ã‚’åŸ‹ã‚ã‚‹ */
      transition: background 0.2s; /* è‰²ã ã‘ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      height: 45px; /* é«˜ã•ã‚’å›ºå®š */
      
      /* ã‚¬ã‚¿ã¤ãé˜²æ­¢ï¼šå¤‰å½¢(scale)ã‚’ä½¿ã‚ãšå›ºå®šã‚µã‚¤ã‚ºã§ç®¡ç† */
    }

    .tab-btn.active {
      background: #ECDBBF; /* ãƒªã‚¹ãƒˆã¨åŒã˜è‰²ï¼ˆãƒ™ãƒ¼ã‚¸ãƒ¥ï¼‰ */
      color: #432517;
      
      /* â˜…é‡è¦ï¼šä¸‹ã®ç·šã‚’æ¶ˆã—ã¦ã€Œãã£ã¤ã„ã¦ã„ã‚‹ã€ã‚ˆã†ã«è¦‹ã›ã‚‹ */
      border-bottom: 3px solid #ECDBBF; 
      
      /* å‰é¢ã«æŒã£ã¦ãã‚‹ */
      z-index: 10;
      
      /* å°‘ã—ã ã‘é«˜ãè¦‹ã›ã‚‹ï¼ˆã‚¬ã‚¿ã¤ã‹ãªã„ç¯„å›²ã§ï¼‰ */
      height: 50px; 
    }

    /* ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .list-container {
      flex: 1; 
      background: #ECDBBF;
      border: 3px solid #8b4513; 
      border-radius: 0 10px 10px 10px; /* å·¦ä¸Šã ã‘è§’å¼µã‚‰ã›ã‚‹ */
      padding: 10px; 
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
      
      /* ã‚¿ãƒ–ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
      position: relative;
      z-index: 5;
    }
    
    .list-view { display: none; }
    .list-view.active { display: block; }

    .friend-item {
      background: rgba(255,255,255,0.6);
      border: 1px solid #8b4513; border-radius: 8px;
      padding: 10px; margin-bottom: 8px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .friend-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .friend-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ccc; border: 2px solid #8b4513; }
    .friend-name { font-weight: bold; color: #432517; font-size: 1.1rem; }
    
    .action-btn {
      padding: 5px 10px; border-radius: 5px; border: none;
      font-size: 0.8rem; font-weight: bold; cursor: pointer; margin-left: 5px;
    }
    .empty-msg { text-align: center; color: #888; margin-top: 30px; }

    /* --- ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
    .bottom-menu {
      position: absolute; bottom: 10px; width: 96%; left: 2%;
      display: flex; justify-content: space-around; align-items: flex-end; gap: 5px;
      z-index: 20;
    }
    .menu-btn {
      flex: 1; height: 60px; border-radius: 10px;
      color: #ECDBBF; font-weight: bold; font-size: 1.1rem;
      cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      text-shadow: 1px 1px 2px #432517;
      display: flex; justify-content: center; align-items: center;
    }
    .menu-btn:active { transform: scale(0.95); }

    .mypage-color { background: linear-gradient(to bottom, #6C4B9C 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .analysis-color { background: linear-gradient(to bottom, #4B6C9C 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .ready-color { background: linear-gradient(to bottom, #7B9C4B 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .menu-color { background: linear-gradient(to bottom, #9C804B 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }
    .chat-color { background: linear-gradient(to bottom, #747474 0%, #ECDBBF 100%) !important; border: 2px solid #432517 !important; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š --- */
    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 100;
      justify-content: center; align-items: center;
    }
    .modal-box {
      position: relative; background: #fff8dc; padding: 15px;
      border-radius: 10px; border: 4px solid #8b4513;
      text-align: center; width: 90%; max-width: 500px;
      display: flex; flex-direction: column;
    }
    .close-modal-btn {
      background: #666; color: white; border: none; padding: 8px 15px;
      border-radius: 5px; cursor: pointer; margin-top: 10px;
    }

    /* ãƒãƒ£ãƒƒãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .close-small-btn {
      position: absolute; top: 8px; right: 8px; padding: 4px 10px;
      background: #666; color: #ECDBBF; border: none; border-radius: 12px;
      font-size: 0.75rem; font-weight: bold; cursor: pointer; z-index: 101;
    }
    #lobbyChatHistory {
      height: 60vh; overflow-y: auto; background: rgba(255, 255, 255, 0.5);
      border: 1px solid #ccc; padding: 8px; border-radius: 8px; margin-top: 10px;
      display: flex; flex-direction: column; gap: 5px;
    }
    .chat-row { display: flex; align-items: flex-start; gap: 10px; }
    .chat-row.mine { align-self: flex-end; flex-direction: row-reverse; }
    .chat-bubble { background: #ECDBBF; padding: 10px; border-radius: 10px; font-size: 0.8rem; }
    .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; }
    .chat-input-area { display: flex; gap: 5px; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="loading-screen">
    <div class="loader-content">
      <div class="spinner"></div>
      <div id="loading-tips"></div>
      <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.8;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <div id="bg-image"></div>

  <div class="container">
    <div class="search-area">
      <span style="font-weight:bold; color:#432517;">ğŸ”</span>
      <input type="text" id="searchInput" class="search-input" placeholder="IDã‚’å…¥åŠ›ã—ã¦æ¤œç´¢">
      <button class="search-btn" onclick="searchUser()">æ¤œç´¢</button>
    </div>

    <div class="tab-container">
      <button class="tab-btn active" onclick="switchTab('list')">ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§</button>
      <button class="tab-btn" onclick="switchTab('pending')">ç”³è«‹ä¸­</button>
      <button class="tab-btn" onclick="switchTab('request')">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
    </div>

    <div class="list-container">
      <div id="tab-list" class="list-view active">
        <div class="empty-msg">ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ã¾ã›ã‚“</div>
      </div>
      <div id="tab-pending" class="list-view">
        <div class="empty-msg">ç”³è«‹ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>
      </div>
      <div id="tab-request" class="list-view">
        <div class="empty-msg">å±Šã„ã¦ã„ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>
      </div>
    </div>
  </div>

  <div class="bottom-menu">
    <button class="menu-btn mypage-color" onclick="window.location.href='home.html'">ãƒ›ãƒ¼ãƒ </button>
    <button class="menu-btn analysis-color" onclick="window.location.href='mypage.html'">å¯¾å±€å±¥æ­´</button>
    <button class="menu-btn ready-color" onclick="window.location.href='new_mypage.html'">ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
    <button class="menu-btn menu-color" onclick="window.location.href='collection.html'">æ‰€æŒå“</button>
    <button class="menu-btn chat-color" onclick="openLobbyChat()">ãƒãƒ£ãƒƒãƒˆ</button>
  </div>

  <div id="searchResultModal" class="overlay">
    <div class="modal-box">
      <h3 style="color:#8b4513;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</h3>
      <div style="margin: 20px 0;">
        <div style="font-size:1.5rem; font-weight:bold; color:#d35400;" id="foundUserName">åç§°</div>
        <div style="color:#666;" id="foundUserId">ID: ---</div>
      </div>
      <button id="sendRequestBtn" style="background:#28a745; color:white; border:none; padding:10px; border-radius:5px; font-weight:bold; font-size:1rem; cursor:pointer;">ç”³è«‹ã‚’é€ã‚‹</button>
      <button class="close-modal-btn" onclick="closeModal('searchResultModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="lobbyChatModal" class="overlay">
    <div class="modal-box" style="height: 85vh; max-width: 800px;">
      <button class="close-small-btn" onclick="closeModal('lobbyChatModal')">é–‰ã˜ã‚‹</button>
      <h3 style="color:#005bea; margin:0; text-align:left;">ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</h3>
      <div id="lobbyChatHistory"></div>
      <div class="chat-input-area">
        <input type="text" id="lobbyChatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px;">
        <button onclick="sendLobbyMessage()" style="background:#28a745; color:#fff; border:none; padding:10px; border-radius:5px; font-weight:bold;">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <script src="script/auth.js"></script>

  <script>
    // --- ãƒ­ãƒ¼ãƒ‰ç”»é¢ ---
    const loadingTipsList = [
      "ã€tipsã€‘IDã‚’ä½¿ã£ã¦é ãã®å‹é”ã¨ã¤ãªãŒã‚Šã¾ã—ã‚‡ã†ã€‚",
      "ã€tipsã€‘ãƒ•ãƒ¬ãƒ³ãƒ‰ã«ãªã‚‹ã¨ã€ã„ã¤ã§ã‚‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç¢ºèªã§ãã¾ã™ã€‚",
      "ã€tipsã€‘å¯¾å±€å±¥æ­´ã‹ã‚‰ç›¸æ‰‹ã®IDã‚’ç¢ºèªã§ãã¾ã™ã€‚"
    ];
    document.addEventListener("DOMContentLoaded", () => {
        const tipEl = document.getElementById('loading-tips');
        if(tipEl) tipEl.textContent = loadingTipsList[Math.floor(Math.random() * loadingTipsList.length)];
    });
    window.addEventListener('load', () => {
        const loader = document.getElementById('loading-screen');
        setTimeout(() => {
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
        }, 800);
    });

    // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.list-view').forEach(div => div.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- æ¤œç´¢æ©Ÿèƒ½ ---
    async function searchUser() {
        const input = document.getElementById('searchInput').value.trim();
        if (!input) return;
        const myUid = firebase.auth().currentUser ? firebase.auth().currentUser.uid : null;
        if(input === myUid) { alert("è‡ªåˆ†è‡ªèº«ã§ã™"); return; }

        try {
            const docRef = db.collection("users").doc(input);
            const doc = await docRef.get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('foundUserName').textContent = data.name || "åç„¡ã—";
                document.getElementById('foundUserId').textContent = "ID: " + input;
                const btn = document.getElementById('sendRequestBtn');
                btn.onclick = () => sendFriendRequest(input);
                document.getElementById('searchResultModal').style.display = 'flex';
            } else {
                alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
            }
        } catch(e) {
            console.error(e);
            alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼");
        }
    }

    function sendFriendRequest(targetUid) {
        alert("ç”³è«‹ã‚’é€ã‚Šã¾ã—ãŸï¼(ãƒ‡ãƒ¢)");
        closeModal('searchResultModal');
    }

    // --- ãƒãƒ£ãƒƒãƒˆ ---
    let chatUnsubscribe = null;
    function openLobbyChat() {
        document.getElementById('lobbyChatModal').style.display = 'flex';
        if(!chatUnsubscribe) {
            const historyDiv = document.getElementById("lobbyChatHistory");
            chatUnsubscribe = db.collection("lobby_chat").orderBy("createdAt", "desc").limit(50)
            .onSnapshot(snapshot => {
                historyDiv.innerHTML = "";
                const msgs = [];
                snapshot.forEach(doc => msgs.push(doc.data()));
                msgs.forEach(msg => {
                    const div = document.createElement("div");
                    div.textContent = (msg.name||"") + ": " + msg.text;
                    div.style.background = "#fff"; div.style.padding="5px"; div.style.borderRadius="5px";
                    historyDiv.appendChild(div);
                });
            });
        }
    }
    function sendLobbyMessage() {
        const input = document.getElementById("lobbyChatInput");
        if(!input.value) return;
        input.value = "";
    }
  </script>
</body>
</html>
