<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ã‚·ãƒ§ãƒƒãƒ— - ã—ãŠã‚„å°†æ£‹</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    body {
      margin: 0; padding: 0;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background-color: #f0e68c; /* èƒŒæ™¯è‰² */
      color: #333;
      overflow-x: hidden;
      -webkit-user-select: none; user-select: none; touch-action: manipulation;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒ¼ */
    .header-bar {
      position: sticky; top: 0;
      background: rgba(139, 69, 19, 0.9); /* æ¿ƒã„èŒ¶è‰² */
      color: white;
      padding: 10px 15px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .back-btn {
      background: #ccc; border: none; padding: 5px 15px; border-radius: 5px;
      cursor: pointer; font-weight: bold; color: black;
    }
    .gold-display {
      font-weight: bold; color: #ffd700; text-shadow: 1px 1px 2px #000; font-size: 1.1rem;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .shop-container {
      padding: 20px 10px;
      max-width: 800px; margin: 0 auto;
    }
    h2 { text-align: center; color: #8b4513; margin-bottom: 20px; }

    /* å•†å“ãƒªã‚¹ãƒˆã®ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* è‡ªå‹•ã§æŠ˜ã‚Šè¿”ã™ */
      gap: 15px;
    }

    /* å•†å“ã‚«ãƒ¼ãƒ‰ */
    .item-card {
      background: white;
      border: 3px solid #8b4513;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      display: flex; flex-direction: column; align-items: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.1s;
    }
    .item-card:active { transform: scale(0.98); }

    /* å•†å“ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    .item-image {
      width: 100px; height: 100px;
      background-color: #ddd;
      border-radius: 5px; margin-bottom: 10px;
      display: flex; justify-content: center; align-items: center;
      font-size: 0.8rem; color: #666; border: 1px solid #ccc;
      /* å®Ÿéš›ã®ç”»åƒã‚’è¨­å®šã™ã‚‹å ´åˆã¯ã“ã“ã‚’ä¸Šæ›¸ãã—ã¾ã™ */
      background-size: cover; background-position: center;
    }

    .item-name { font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
    .item-price { color: #d32f2f; font-weight: bold; margin-bottom: 10px; }

    /* è³¼å…¥ãƒœã‚¿ãƒ³ */
    .buy-btn {
      width: 100%; padding: 8px;
      border: none; border-radius: 5px;
      background: #28a745; color: white; font-weight: bold;
      cursor: pointer;
    }
    .buy-btn:disabled {
      background: #ccc; color: #666; cursor: not-allowed;
    }
    .owned-badge {
      background: #6c757d; color: white; padding: 5px 10px;
      border-radius: 5px; font-size: 0.8rem; width: 100%; box-sizing: border-box;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆç”¨ï¼‰ - home.htmlã‹ã‚‰æµç”¨ */
    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 100;
      justify-content: center; align-items: center;
    }
    .modal-box {
      background: #fff8dc; padding: 20px; border-radius: 10px;
      border: 4px solid #8b4513; text-align: center; max-width: 80%;
    }
  </style>
</head>
<body>

  <div class.header-bar>
    <button class="back-btn" onclick="window.location.href='home.html'">â† ãƒ›ãƒ¼ãƒ ã¸</button>
    <span class="gold-display">ğŸ’° <span id="userGold">---</span> G</span>
  </div>

  <div class.shop-container>
    <h2>ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—</h2>
    <div id="shopItemsList" class="item-grid"></div>
  </div>


  <div id="alertModal" class.overlay>
    <div class.modal-box">
      <h3 id="alertTitle" style="margin-top:0; color:#8b4513;"></h3>
      <p id="alertMessage"></p>
      <button onclick="closeAlert()" style="background:#8b4513; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">OK</button>
    </div>
  </div>


<script src="script/auth.js"></script> <script>
  // --- â˜…â˜…â˜… 1. å•†å“ãƒ‡ãƒ¼ã‚¿ã®å®šç¾© â˜…â˜…â˜… ---
  // ã“ã“ã«è²©å£²ã—ãŸã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™
  const SHOP_ITEMS = [
    {
      id: "piece_dot",             // ã‚¢ã‚¤ãƒ†ãƒ IDï¼ˆDBä¿å­˜ç”¨ã€‚ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè‹±æ•°å­—ï¼‰
      name: "ãƒ‰ãƒƒãƒˆçµµã®é§’",        // è¡¨ç¤ºå
      price: 1000,                 // ä¾¡æ ¼
      type: "piece",               // ç¨®é¡ï¼ˆpiece:é§’, board:ç›¤ ãªã©ã€‚å¾Œã§å½¹ç«‹ã¡ã¾ã™ï¼‰
      image: "script/image/dot/pawn.png", // ç”»åƒãƒ‘ã‚¹ï¼ˆä»®ï¼‰
      desc: "ãƒ¬ãƒˆãƒ­ãªé›°å›²æ°—ã®ãƒ‰ãƒƒãƒˆçµµé§’ã§ã™ã€‚" // èª¬æ˜æ–‡ï¼ˆä»Šå›ã¯æœªè¡¨ç¤ºï¼‰
    },
    {
      id: "board_wood_dark",
      name: "é«˜ç´šãªæœ¨è£½ç›¤",
      price: 2500,
      type: "board",
      // ç”»åƒãŒãªã„å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤ºç”¨è¨­å®š
      placeholderText: "æœ¨ã®ç›¤ç”»åƒ" 
    },
    {
      id: "piece_gold_style",
      name: "é»„é‡‘ã®é§’æ–‡å­—",
      price: 5000,
      type: "piece",
      placeholderText: "é‡‘è‰²æ–‡å­—"
    }
  ];

  let currentUserGold = 0;
  let currentUserInventory = [];

  // --- 2. åˆæœŸåŒ–å‡¦ç† ---
  document.addEventListener("DOMContentLoaded", () => {
    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–ã¨æ‰€æŒé‡‘è¡¨ç¤ºæ›´æ–°
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ‰€æŒé‡‘ã¨æŒã¡ç‰©ã‚’ç›£è¦–
        db.collection("users").doc(user.uid).onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            currentUserGold = data.gold || 0;
            // inventoryãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºé…åˆ—ã«ã™ã‚‹
            currentUserInventory = data.inventory || [];
            
            document.getElementById("userGold").textContent = currentUserGold.toLocaleString();
            
            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«åˆã‚ã›ã¦å•†å“ãƒªã‚¹ãƒˆã‚’å†æç”»ï¼ˆè³¼å…¥ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ãªã©ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ï¼‰
            renderShopItems();
          }
        });
      } else {
        // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ›ãƒ¼ãƒ ã«æˆ»ã™ãªã©ã®å‡¦ç†ãŒå¿…è¦ã§ã™ãŒã€ã¨ã‚Šã‚ãˆãšè¡¨ç¤ºã‚’---ã«
        document.getElementById("userGold").textContent = "---";
        showAlert("ã‚¨ãƒ©ãƒ¼", "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚", () => {
            window.location.href = "home.html";
        });
      }
    });
  });

  // --- 3. å•†å“ãƒªã‚¹ãƒˆã®æç”» ---
  function renderShopItems() {
    const listContainer = document.getElementById("shopItemsList");
    listContainer.innerHTML = ""; // ä¸€æ—¦ã‚¯ãƒªã‚¢

    SHOP_ITEMS.forEach(item => {
      // æ—¢ã«æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const isOwned = currentUserInventory.includes(item.id);
      // ãŠé‡‘ãŒè¶³ã‚Šã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const canAfford = (currentUserGold >= item.price);

      // ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
      const card = document.createElement("div");
      card.className = "item-card";

      // ç”»åƒéƒ¨åˆ†ï¼ˆç”»åƒãƒ‘ã‚¹æŒ‡å®šãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
      let imageStyle = "";
      let imageText = item.placeholderText || item.name;
      if (item.image) {
          imageStyle = `background-image: url('${item.image}');`;
          imageText = ""; // ç”»åƒãŒã‚ã‚‹ãªã‚‰æ–‡å­—ã¯æ¶ˆã™
      }

      card.innerHTML = `
        <div class="item-image" style="${imageStyle}">${imageText}</div>
        <div class="item-name">${item.name}</div>
        <div class="item-price">${item.price.toLocaleString()} G</div>
      `;

      // ãƒœã‚¿ãƒ³éƒ¨åˆ†ã®ç”Ÿæˆ
      if (isOwned) {
        // è³¼å…¥æ¸ˆã¿ã®å ´åˆ
        const badge = document.createElement("div");
        badge.className = "owned-badge";
        badge.textContent = "è³¼å…¥æ¸ˆã¿";
        card.appendChild(badge);
      } else {
        // æœªè³¼å…¥ã®å ´åˆ
        const buyBtn = document.createElement("button");
        buyBtn.className = "buy-btn";
        buyBtn.textContent = "è³¼å…¥ã™ã‚‹";
        // ãŠé‡‘ãŒè¶³ã‚Šãªã„å ´åˆã¯ç„¡åŠ¹åŒ–
        if (!canAfford) {
          buyBtn.disabled = true;
          buyBtn.textContent = "Gä¸è¶³";
        }
        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ã‚’è¨­å®š
        buyBtn.onclick = () => buyItem(item);
        card.appendChild(buyBtn);
      }

      listContainer.appendChild(card);
    });
  }

  // --- 4. è³¼å…¥å‡¦ç† ---
  function buyItem(item) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // å¿µã®ãŸã‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚æœ€çµ‚ãƒã‚§ãƒƒã‚¯
    if (currentUserInventory.includes(item.id)) {
        showAlert("æƒ…å ±", "ã™ã§ã«ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚");
        return;
    }
    if (currentUserGold < item.price) {
        showAlert("ã‚¨ãƒ©ãƒ¼", "ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        return;
    }

    // è³¼å…¥ç¢ºèª
    if (!confirm(`${item.name} ã‚’ ${item.price}G ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    // â˜…Firestoreã®æ›´æ–°å‡¦ç†ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰â˜…
    // goldã‚’æ¸›ã‚‰ã—ã€inventoryã«ã‚¢ã‚¤ãƒ†ãƒ IDã‚’è¿½åŠ ã™ã‚‹
    db.collection("users").doc(user.uid).update({
        gold: firebase.firestore.FieldValue.increment(-item.price),
        inventory: firebase.firestore.FieldValue.arrayUnion(item.id)
    }).then(() => {
        // æˆåŠŸæ™‚ï¼ˆonSnapshotãŒè‡ªå‹•ã§ç”»é¢ã‚’æ›´æ–°ã™ã‚‹ã®ã§ã€ã“ã“ã§ã¯å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ï¼‰
        showAlert("è³¼å…¥å®Œäº†", `${item.name} ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`);
        // åŠ¹æœéŸ³ã‚’é³´ã‚‰ã™ãªã‚‰ã“ã“ã« playSound() ãªã©ã‚’è¿½åŠ 
    }).catch((error) => {
        console.error("Purchase error:", error);
        showAlert("ã‚¨ãƒ©ãƒ¼", "è³¼å…¥å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    });
  }

  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼‰---
  let alertCallback = null;
  function showAlert(title, msg, callback) {
    document.getElementById("alertTitle").textContent = title;
    document.getElementById("alertMessage").textContent = msg;
    document.getElementById("alertModal").style.display = "flex";
    alertCallback = callback;
  }
  function closeAlert() {
    document.getElementById("alertModal").style.display = "none";
    if (alertCallback) {
        alertCallback();
        alertCallback = null;
    }
  }
</script>

</body>
</html>