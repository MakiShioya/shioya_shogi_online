<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ã‚·ãƒ§ãƒƒãƒ— - ã—ãŠã‚„å°†æ£‹</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    body {
      margin: 0; padding: 0;
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background-color: #f0e68c; /* èƒŒæ™¯è‰² */
      color: #333;
      overflow-x: hidden;
      -webkit-user-select: none; user-select: none; touch-action: manipulation;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒ¼ */
    .header-bar {
      position: sticky; top: 0;
      background: rgba(139, 69, 19, 0.9); /* æ¿ƒã„èŒ¶è‰² */
      color: white;
      padding: 10px 15px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .back-btn {
      background: #ccc; border: none; padding: 5px 15px; border-radius: 5px;
      cursor: pointer; font-weight: bold; color: black;
    }
    .gold-display {
      font-weight: bold; color: #ffd700; text-shadow: 1px 1px 2px #000; font-size: 1.1rem;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .shop-container {
      padding: 20px 10px;
      max-width: 800px; margin: 0 auto;
    }
    h2 { text-align: center; color: #8b4513; margin-bottom: 20px; }

    /* å•†å“ãƒªã‚¹ãƒˆã®ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* è‡ªå‹•ã§æŠ˜ã‚Šè¿”ã™ */
      gap: 15px;
    }

    /* å•†å“ã‚«ãƒ¼ãƒ‰ */
    .item-card {
      background: white;
      border: 3px solid #8b4513;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      display: flex; flex-direction: column; align-items: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.1s;
    }
    .item-card:active { transform: scale(0.98); }

    /* å•†å“ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    .item-image {
      width: 100px; height: 100px;
      background-color: #ddd;
      border-radius: 5px; margin-bottom: 10px;
      display: flex; justify-content: center; align-items: center;
      font-size: 0.8rem; color: #666; border: 1px solid #ccc;
      background-size: cover; background-position: center;
    }

    .item-name { font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
    .item-price { color: #d32f2f; font-weight: bold; margin-bottom: 10px; }

    /* è³¼å…¥ãƒœã‚¿ãƒ³ */
    .buy-btn {
      width: 100%; padding: 8px;
      border: none; border-radius: 5px;
      background: #28a745; color: white; font-weight: bold;
      cursor: pointer;
    }
    .buy-btn:disabled {
      background: #ccc; color: #666; cursor: not-allowed;
    }
    .owned-badge {
      background: #6c757d; color: white; padding: 5px 10px;
      border-radius: 5px; font-size: 0.8rem; width: 100%; box-sizing: border-box;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆç”¨ï¼‰ */
    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 100;
      justify-content: center; align-items: center;
    }
    .modal-box {
      background: #fff8dc; padding: 20px; border-radius: 10px;
      border: 4px solid #8b4513; text-align: center; max-width: 80%;
    }
  </style>
</head>
<body>

  <div class="header-bar">
    <button class="back-btn" onclick="window.location.href='home.html'">â† ãƒ›ãƒ¼ãƒ ã¸</button>
    <span class="gold-display">ğŸ’° <span id="userGold">---</span> G</span>
  </div>

  <div class="shop-container">
    <h2>ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—</h2>
    <div id="shopItemsList" class="item-grid"></div>
  </div>

  <div id="alertModal" class="overlay">
    <div class="modal-box">
      <h3 id="alertTitle" style="margin-top:0; color:#8b4513;"></h3>
      <p id="alertMessage"></p>
      <button onclick="closeAlert()" style="background:#8b4513; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">OK</button>
    </div>
  </div>

<script src="script/items.js"></script>
<script src="script/auth.js"></script>
<script>
  // å®šç¾©æ¸ˆã¿ã®GAME_ITEMSã‚’ä½¿ç”¨ã™ã‚‹
  const SHOP_ITEMS = GAME_ITEMS;

  let currentUserGold = 0;
  let currentUserInventory = [];

  // --- åˆæœŸåŒ–å‡¦ç† ---
  document.addEventListener("DOMContentLoaded", () => {
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        db.collection("users").doc(user.uid).onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            currentUserGold = data.gold || 0;
            currentUserInventory = data.inventory || [];
            
            document.getElementById("userGold").textContent = currentUserGold.toLocaleString();
            renderShopItems();
          }
        });
      } else {
        document.getElementById("userGold").textContent = "---";
        showAlert("ã‚¨ãƒ©ãƒ¼", "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚", () => {
            window.location.href = "home.html";
        });
      }
    });
  });

  // --- å•†å“ãƒªã‚¹ãƒˆã®æç”» ---
  function renderShopItems() {
    const listContainer = document.getElementById("shopItemsList");
    listContainer.innerHTML = "";

    SHOP_ITEMS.forEach(item => {
      // 0å††ã®åˆæœŸã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚·ãƒ§ãƒƒãƒ—ã«è¡¨ç¤ºã—ãªã„ï¼ˆã¾ãŸã¯ã€ŒåˆæœŸè£…å‚™ã€ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã‹ã¯ãŠå¥½ã¿ã§ï¼‰
      // ä»Šå›ã¯ã€Œ0å††ã‚ˆã‚Šé«˜ã„ã‚‚ã®ã€ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™
      if (item.price <= 0) return;

      const isOwned = currentUserInventory.includes(item.id);
      const canAfford = (currentUserGold >= item.price);

      const card = document.createElement("div");
      card.className = "item-card";

      let imageStyle = "";
      let imageText = item.placeholderText || item.name;
      if (item.image) {
          imageStyle = `background-image: url('${item.image}');`;
          imageText = "";
      }

      card.innerHTML = `
        <div class="item-image" style="${imageStyle}">${imageText}</div>
        <div class="item-name">${item.name}</div>
        <div class="item-price">${item.price.toLocaleString()} G</div>
      `;

      if (isOwned) {
        const badge = document.createElement("div");
        badge.className = "owned-badge";
        badge.textContent = "è³¼å…¥æ¸ˆã¿";
        card.appendChild(badge);
      } else {
        const buyBtn = document.createElement("button");
        buyBtn.className = "buy-btn";
        buyBtn.textContent = "è³¼å…¥ã™ã‚‹";
        if (!canAfford) {
          buyBtn.disabled = true;
          buyBtn.textContent = "Gä¸è¶³";
        }
        buyBtn.onclick = () => buyItem(item);
        card.appendChild(buyBtn);
      }
      listContainer.appendChild(card);
    });
  }

  // --- è³¼å…¥å‡¦ç† ---
  function buyItem(item) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    if (currentUserInventory.includes(item.id)) {
        showAlert("æƒ…å ±", "ã™ã§ã«ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚");
        return;
    }
    if (currentUserGold < item.price) {
        showAlert("ã‚¨ãƒ©ãƒ¼", "ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        return;
    }

    if (!confirm(`${item.name} ã‚’ ${item.price}G ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    db.collection("users").doc(user.uid).update({
        gold: firebase.firestore.FieldValue.increment(-item.price),
        inventory: firebase.firestore.FieldValue.arrayUnion(item.id)
    }).then(() => {
        showAlert("è³¼å…¥å®Œäº†", `${item.name} ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`);
    }).catch((error) => {
        console.error("Purchase error:", error);
        showAlert("ã‚¨ãƒ©ãƒ¼", "è³¼å…¥å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    });
  }

  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
  let alertCallback = null;
  function showAlert(title, msg, callback) {
    document.getElementById("alertTitle").textContent = title;
    document.getElementById("alertMessage").textContent = msg;
    document.getElementById("alertModal").style.display = "flex";
    alertCallback = callback;
  }
  function closeAlert() {
    document.getElementById("alertModal").style.display = "none";
    if (alertCallback) {
        alertCallback();
        alertCallback = null;
    }
  }
</script>

</body>
</html>
