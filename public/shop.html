<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ã—ãŠã‚„å°†æ£‹ ã‚·ãƒ§ãƒƒãƒ—</title>
  
  <link rel="preload" href="script/font/setofont.ttf" as="font" type="font/ttf" crossorigin>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    /* â˜…è¿½åŠ ï¼šãƒ•ã‚©ãƒ³ãƒˆå®šç¾© */
    @font-face {
      font-family: 'SetoFont';
      src: url('script/font/setofont.ttf') format('truetype');
      font-display: block;
    }

    /* â˜…è¿½åŠ ï¼šå…¨ä½“ã«ãƒ•ã‚©ãƒ³ãƒˆé©ç”¨ */
    * {
      font-family: 'SetoFont', "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
    }

    /* â˜…è¿½åŠ ï¼šãƒ­ãƒ¼ãƒ‰ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(240, 230, 140, 0.9); /* èƒŒæ™¯è‰²(#f0e68c)ã«åˆã‚ã›ã¦èª¿æ•´ */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loader-content {
      text-align: center;
      color: #8b4513; /* æ–‡å­—è‰²ã¯èŒ¶è‰²ã« */
      font-family: "SetoFont", sans-serif;
    }

    /* ãã‚‹ãã‚‹å›ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(139, 69, 19, 0.3);
      border-top: 5px solid #8b4513;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ãƒãƒƒãƒ—ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #loading-tips {
      margin-top: 20px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 10px;
      font-size: 0.9rem;
      max-width: 250px;
      line-height: 1.5;
      min-height: 3em;
    }

    /* --- ä»¥ä¸‹ã€æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body {
      margin: 0; padding: 0;
      /* font-family: "Hiragino Kaku Gothic ProN", ... â†å‰Šé™¤ï¼ˆ*ã§æŒ‡å®šæ¸ˆã¿ï¼‰ */
      background-color: #f0e68c;
      color: #333;
      overflow-x: hidden;
      -webkit-user-select: none; user-select: none; touch-action: manipulation;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒ¼ */
    .header-bar {
      position: sticky; top: 0;
      background: rgba(139, 69, 19, 0.9);
      color: white;
      padding: 10px 15px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .back-btn {
      background: #ccc; border: none; padding: 5px 15px; border-radius: 5px;
      cursor: pointer; font-weight: bold; color: black;
    }
    .gold-display {
      font-weight: bold; color: #ffd700; text-shadow: 1px 1px 2px #000; font-size: 1.1rem;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .shop-container {
      padding: 20px 10px;
      max-width: 800px; margin: 0 auto;
      padding-bottom: 50px;
    }
    h2 { text-align: center; color: #8b4513; margin-bottom: 20px; }

    /* ã‚«ãƒ†ã‚´ãƒªè¦‹å‡ºã— */
    .section-title {
      font-size: 1.2rem;
      margin-top: 30px;
      margin-bottom: 10px;
      color: #8b4513;
      font-weight: bold;
      border-bottom: 2px solid #8b4513;
      padding-bottom: 5px;
    }

    /* å•†å“ãƒªã‚¹ãƒˆ */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }

    /* å•†å“ã‚«ãƒ¼ãƒ‰ */
    .item-card {
      background: white;
      border: 3px solid #8b4513;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      display: flex; flex-direction: column; align-items: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.1s;
      position: relative; /* è©¦è´ãƒœã‚¿ãƒ³ã®é…ç½®åŸºæº– */
    }
    .item-card:active { transform: scale(0.98); }

    .item-image {
      width: 100px; height: 100px;
      background-color: #ddd;
      border-radius: 5px; margin-bottom: 10px;
      display: flex; justify-content: center; align-items: center;
      font-size: 0.8rem; color: #666; border: 1px solid #ccc;
      background-size: cover; background-position: center;
      position: relative;
    }

    .item-name { font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
    .item-desc {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 8px;
      line-height: 1.4;
      min-height: 2.8em; /* 2è¡Œåˆ†ãã‚‰ã„ã®é«˜ã•ã‚’ç¢ºä¿ã—ã¦ã‚¬ã‚¿ã¤ãé˜²æ­¢ */
    }
    .item-price { color: #d32f2f; font-weight: bold; margin-bottom: 10px; }

    .buy-btn {
      width: 100%; padding: 8px;
      border: none; border-radius: 5px;
      background: #28a745; color: white; font-weight: bold;
      cursor: pointer;
    }
    .buy-btn:disabled {
      background: #ccc; color: #666; cursor: not-allowed;
    }
    .owned-badge {
      background: #6c757d; color: white; padding: 5px 10px;
      border-radius: 5px; font-size: 0.8rem; width: 100%; box-sizing: border-box;
    }

    /* è©¦è´ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .preview-btn {
      position: absolute;
      bottom: 5px; right: 5px; /* ç”»åƒã®å³ä¸‹ã«é…ç½® */
      width: 30px; height: 30px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: 2px solid white;
      font-size: 14px;
      cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      z-index: 5;
    }
    .preview-btn:hover { background: rgba(255, 69, 0, 0.8); }
    /* å†ç”Ÿä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .preview-btn.playing {
      background: #ff4500;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(255, 69, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 100;
      justify-content: center; align-items: center;
    }
    .modal-box {
      background: #fff8dc; padding: 20px; border-radius: 10px;
      border: 4px solid #8b4513; text-align: center; max-width: 80%;
    }
  </style>
</head>
<body>

  <div id="loading-screen">
    <div class="loader-content">
      <div class="spinner"></div>
      <div id="loading-tips"></div>
      <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.8;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <div class="header-bar">
    <button class="back-btn" onclick="window.location.href='home.html'">â† ãƒ›ãƒ¼ãƒ ã¸</button>
    <span class="gold-display">ğŸ’° <span id="userGold">---</span> G</span>
  </div>

  <div class="shop-container">
    <h2>ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—</h2>
    
    <div class="section-title">å°†æ£‹ã®é§’</div>
    <div id="pieceList" class="item-grid"></div>

    <div class="section-title">å°†æ£‹ç›¤</div>
    <div id="boardList" class="item-grid"></div>

    <div class="section-title">BGMï¼ˆå†ç”Ÿãƒœã‚¿ãƒ³ã§è¦–è´ãŒã§ãã¾ã™ï¼ï¼‰</div>
    <div id="bgmList" class="item-grid"></div>
  </div>

  <div id="alertModal" class="overlay">
    <div class="modal-box">
      <h3 id="alertTitle" style="margin-top:0; color:#8b4513;"></h3>
      <p id="alertMessage"></p>
      <button onclick="closeAlert()" style="background:#8b4513; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">OK</button>
    </div>
  </div>

<script src="script/items.js"></script>
<script src="script/auth.js"></script>
<script>
  const SHOP_ITEMS = GAME_ITEMS;

  let currentUserGold = 0;
  let currentUserInventory = [];
  
  // è©¦è´ç”¨ã®éŸ³å£°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  let currentPreviewAudio = null; 
  let currentPreviewId = null;    

  document.addEventListener("DOMContentLoaded", () => {
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        db.collection("users").doc(user.uid).onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            currentUserGold = data.gold || 0;
            currentUserInventory = data.inventory || [];
            
            document.getElementById("userGold").textContent = currentUserGold.toLocaleString();
            renderShopItems();
          }
        });
      } else {
        document.getElementById("userGold").textContent = "---";
        showAlert("ã‚¨ãƒ©ãƒ¼", "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚", () => {
            window.location.href = "home.html";
        });
      }
    });
  });

  function renderShopItems() {
    const pieceList = document.getElementById("pieceList");
    const boardList = document.getElementById("boardList");
    const bgmList = document.getElementById("bgmList");

    pieceList.innerHTML = "";
    boardList.innerHTML = "";
    bgmList.innerHTML = "";

    SHOP_ITEMS.forEach(item => {
      if (item.price <= 0) return;

      const isOwned = currentUserInventory.includes(item.id);
      const canAfford = (currentUserGold >= item.price);

      const card = document.createElement("div");
      card.className = "item-card";

      // --- ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ ---
      let imageStyle = "";
      let imageText = item.placeholderText || item.name;
      
      if (item.image) {
          imageStyle = `background-image: url('${item.image}');`;
          imageText = "";
      } else if (item.type === "bgm") {
          imageText = "â™ª";
      }
      
      // ã‚«ãƒ¼ãƒ‰ã®ä¸ŠåŠåˆ†ï¼ˆç”»åƒã‚¨ãƒªã‚¢ï¼‰
      let imageAreaHTML = `<div class="item-image" style="${imageStyle}">${imageText}`;
      
      // BGMãªã‚‰è©¦è´ãƒœã‚¿ãƒ³ã‚’ç”»åƒã®ä¸­ã«åŸ‹ã‚è¾¼ã‚€
      if (item.type === 'bgm') {
          imageAreaHTML += `<button class="preview-btn" id="btn-${item.id}" onclick="playPreview('${item.id}', '${item.src}')">â–¶</button>`;
      }
      
      imageAreaHTML += `</div>`; // é–‰ã˜ã‚¿ã‚°

      card.innerHTML = `
        ${imageAreaHTML}
        <div class="item-name">${item.name}</div>
        <div class="item-desc">${item.desc}</div> 
        <div class="item-price">${item.price.toLocaleString()} G</div>
      `;

      if (isOwned) {
        const badge = document.createElement("div");
        badge.className = "owned-badge";
        badge.textContent = "è³¼å…¥æ¸ˆã¿";
        card.appendChild(badge);
      } else {
        const buyBtn = document.createElement("button");
        buyBtn.className = "buy-btn";
        buyBtn.textContent = "è³¼å…¥ã™ã‚‹";
        if (!canAfford) {
          buyBtn.disabled = true;
          buyBtn.textContent = "Gä¸è¶³";
        }
        buyBtn.onclick = () => buyItem(item);
        card.appendChild(buyBtn);
      }

      if (item.type === 'piece') pieceList.appendChild(card);
      else if (item.type === 'board') boardList.appendChild(card);
      else if (item.type === 'bgm') bgmList.appendChild(card);
    });
  }

  // è©¦è´å‡¦ç†é–¢æ•°
  function playPreview(id, src) {
      if (currentPreviewId === id) {
          stopPreview();
          return;
      }

      if (currentPreviewAudio) {
          stopPreview();
      }

      currentPreviewAudio = new Audio(src);
      currentPreviewAudio.volume = 0.5;
      currentPreviewId = id;

      const btn = document.getElementById(`btn-${id}`);
      if (btn) {
          btn.textContent = "â– "; 
          btn.classList.add("playing");
      }

      currentPreviewAudio.play().catch(e => {
          console.error("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e);
          alert("å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ");
          stopPreview();
      });

      currentPreviewAudio.onended = () => {
          stopPreview();
      };
  }

  // åœæ­¢å‡¦ç†é–¢æ•°
  function stopPreview() {
      if (currentPreviewAudio) {
          currentPreviewAudio.pause();
          currentPreviewAudio = null;
      }
      
      if (currentPreviewId) {
          const btn = document.getElementById(`btn-${currentPreviewId}`);
          if (btn) {
              btn.textContent = "â–¶";
              btn.classList.remove("playing");
          }
          currentPreviewId = null;
      }
  }

  // è³¼å…¥å‡¦ç†
  function buyItem(item) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    stopPreview();

    if (currentUserInventory.includes(item.id)) {
        showAlert("æƒ…å ±", "ã™ã§ã«ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚");
        return;
    }
    if (currentUserGold < item.price) {
        showAlert("ã‚¨ãƒ©ãƒ¼", "ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        return;
    }

    if (!confirm(`${item.name} ã‚’ ${item.price}G ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    db.collection("users").doc(user.uid).update({
        gold: firebase.firestore.FieldValue.increment(-item.price),
        inventory: firebase.firestore.FieldValue.arrayUnion(item.id)
    }).then(() => {
        showAlert("è³¼å…¥å®Œäº†", `${item.name} ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`);
    }).catch((error) => {
        console.error("Purchase error:", error);
        showAlert("ã‚¨ãƒ©ãƒ¼", "è³¼å…¥å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    });
  }

  // ç”»é¢é·ç§»æ™‚ã«éŸ³ã‚’æ­¢ã‚ã‚‹
  window.onbeforeunload = function() {
      stopPreview();
  };

  let alertCallback = null;
  function showAlert(title, msg, callback) {
    document.getElementById("alertTitle").textContent = title;
    document.getElementById("alertMessage").textContent = msg;
    document.getElementById("alertModal").style.display = "flex";
    alertCallback = callback;
  }
  function closeAlert() {
    document.getElementById("alertModal").style.display = "none";
    if (alertCallback) {
        alertCallback();
        alertCallback = null;
    }
  }
</script>

<script>
    const loadingTipsList = [
        "ã€tipsã€‘ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¯ãã‚Œãã‚Œå›ºæœ‰ã®å¿…æ®ºæŠ€ãŒã‚ã‚Šã¾ã™ã€‚",
        "ã€tipsã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾å±€ã¯ã€å…ˆã«å…¥å®¤ã—ãŸæ–¹ãŒå…ˆæ‰‹ã«ãªã‚Šã¾ã™ã€‚",
        "ã€tipsã€‘æ£‹è­œã§ã¯ã€è‡ªåˆ†ã®ã“ã‚Œã¾ã§ã®å¯¾å±€ã‚’æŒ¯ã‚Šè¿”ã‚‹ã ã‘ã§ãªãã€è§£æã‚‚ã§ãã¾ã™ã€‚",
        "ã€tipsã€‘ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚",
        "ã€tipsã€‘CPUã®å¿…æ®ºæŠ€ã¯ã€2å›è¡Œå‹•ã§ã™ã€‚",
        "ã€tipsã€‘CPUã¯å¿…æ®ºæŠ€ã‚²ãƒ¼ã‚¸ãŒ300ãŸã¾ã‚‹ã¨å¿…ãšå¿…æ®ºæŠ€ã‚’æ‰“ã£ã¦ãã¾ã™ã€‚"
    ];

    function showRandomTips() {
        const tipEl = document.getElementById('loading-tips');
        if (!tipEl) return;
        const randomTip = loadingTipsList[Math.floor(Math.random() * loadingTipsList.length)];
        tipEl.textContent = randomTip;
    }

    let tipsInterval = null;

    // ç”»åƒã®èª­ã¿è¾¼ã¿ã‚’å¾…ãŸãšã«Tipsã‚’è¡¨ç¤º
    document.addEventListener('DOMContentLoaded', () => {
        showRandomTips();
        tipsInterval = setInterval(showRandomTips, 3000);
    });

    // ç”»åƒã¨ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’æ¶ˆã™
    window.addEventListener('load', () => {
        const loader = document.getElementById('loading-screen');
        
        // ãƒ•ã‚©ãƒ³ãƒˆã®æº–å‚™å®Œäº†ã‚’å¾…ã¤
        document.fonts.ready.then(() => {
            setTimeout(() => {
                clearInterval(tipsInterval);
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }, 800); // æ¼”å‡ºã®ãŸã‚å°‘ã—å¾…æ©Ÿ
        });
    });
</script>

</body>
</html>
