<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>ã—ãŠã‚„å°†æ£‹ - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
  <link rel="preload" href="script/font/setofont.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="icon" href="script/image/komiya_icon.png"> 
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* --- åŸºæœ¬è¨­å®š (home.htmlã¨å…±é€š) --- */
    @font-face {
      font-family: 'SetoFont';
      src: url('script/font/setofont.ttf') format('truetype');
      font-display: block;
    }
    * { font-family: 'SetoFont', "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; }
    
    body {
      margin: 0; padding: 0;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #2c3e50;
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-user-select: none; user-select: none; touch-action: none;
    }
    html { width: 100%; height: 100%; overflow: hidden; overscroll-behavior: none; }
    input, textarea { user-select: text; -webkit-user-select: text; touch-action: auto; }

    /* èƒŒæ™¯ */
    #bg-image {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1;
      background-image: url('script/image/shogi_title.PNG');
      background-size: cover; background-position: center;
      filter: blur(2px);
    }

    /* --- â˜…â˜…â˜… ãƒã‚¤ãƒšãƒ¼ã‚¸å°‚ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆèª¿æ•´ç‰ˆï¼‰ â˜…â˜…â˜… --- */
    
    /* å·¦å´ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ */
    .character-stand-mypage {
      position: absolute;
      bottom: 75px;  /* ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼(ç´„70px)ã«è¢«ã‚‰ãªã„ä½ç½® */
      left: 0;       /* â˜…ä¿®æ­£: ç”»é¢å·¦ç«¯ã‹ã‚‰é–‹å§‹ */
      
      /* â˜…ä¿®æ­£: é«˜ã•ã¯ç”»é¢ã®80%ã¾ã§ã€ã‹ã¤å¹…ã¯ç”»é¢ã®45%ã¾ã§ï¼ˆå³ãƒ‘ãƒãƒ«ã¨è¢«ã‚Šã™ããªã„ã‚ˆã†ã«ï¼‰ */
      height: 80vh; 
      max-width: 45vw; 
      object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦åã‚ã‚‹ */
      object-position: bottom left; /* å·¦ä¸‹åŸºæº–ã§é…ç½® */
      
      z-index: 1;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
      pointer-events: none; /* ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚è£ã®è¦ç´ ã‚’é‚ªé­”ã—ãªã„ */
    }

    /* å³å´ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã‚³ãƒ³ãƒ†ãƒŠ */
    .profile-container {
      position: absolute;
      /* â˜…ä¿®æ­£: ç”»é¢ã®ä¸Šä¸‹ä¸­å¤®ã«é…ç½®ã™ã‚‹è¨­å®š */
      top: 50%;
      right: 5%;
      transform: translateY(-55%); /* ä¸­å¤®ã‚ˆã‚Šå°‘ã—ã ã‘ä¸Šã«ãšã‚‰ã™ï¼ˆä¸‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼è€ƒæ…®ï¼‰ */
      
      width: 50%;       /* ç”»é¢å¹…ã®åŠåˆ† */
      max-width: 450px; /* PCãªã©ã§åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
      
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px; /* ãƒ‘ãƒãƒ«ã¨ãƒœã‚¿ãƒ³ã®é–“éš” */
      z-index: 10;
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºãƒ‘ãƒãƒ« */
    .user-name-panel {
      background: rgba(67, 37, 23, 0.95);
      color: #ECDBBF;
      border: 3px solid #ECDBBF;
      border-radius: 15px;
      padding: 15px 10px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ãŸå¹…è¨ˆç®— */
    }
    .mypage-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; word-break: break-all; }
    .mypage-gold { color: #ffd700; font-weight: bold; font-size: 1.2rem; text-shadow: 1px 1px 2px #432517; }

    /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .mypage-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
    }

    .big-link-btn {
      background: linear-gradient(to bottom, #ff9800, #f57c00);
      border: 3px solid #ECDBBF;
      border-radius: 12px;
      color: #fff;
      font-size: 1.1rem;
      font-weight: bold;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.4);
      text-shadow: 1px 1px 2px #432517;
      transition: transform 0.1s;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      box-sizing: border-box;
    }
    .big-link-btn:active { transform: scale(0.96); }
    
    .btn-history { background: linear-gradient(to bottom, #6C4B9C, #4a326e); }
    .btn-friend { background: linear-gradient(to bottom, #28a745, #1e7e34); }

    /* --- ä¸‹éƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
    .bottom-menu {
      position: absolute; bottom: 10px; width: 96%; left: 2%;
      display: flex; justify-content: space-around; align-items: flex-end;
      gap: 5px; z-index: 20;
    }
    .menu-btn {
      flex: 1; height: 60px;
      border: 2px solid #ECDBBF; border-radius: 10px;
      color: #ECDBBF; font-weight: bold; font-size: 1.0rem;
      cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      text-shadow: 1px 1px 2px #432517;
      white-space: nowrap; /* æ–‡å­—æŠ˜ã‚Šè¿”ã—é˜²æ­¢ */
    }
    .menu-btn:active { transform: scale(0.95); }

    .home-color { background: linear-gradient(to bottom, #432517 0%, #8d6e63 100%); }
    .analysis-color { background: linear-gradient(to bottom, #4B6C9C 0%, #ECDBBF 100%); }
    .shop-color { background: linear-gradient(to bottom, #7B9C4B 0%, #ECDBBF 100%); }
    .menu-color { background: linear-gradient(to bottom, #9C804B 0%, #ECDBBF 100%); }
    .chat-color { background: linear-gradient(to bottom, #747474 0%, #ECDBBF 100%); }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 100;
      justify-content: center; align-items: center;
    }
    .modal-box {
      background: #fff8dc; padding: 15px; border-radius: 10px;
      border: 4px solid #8b4513; text-align: center;
      width: 80%; max-width: 800px; max-height: 85vh;
      display: flex; flex-direction: column;
    }
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
    .sub-btn {
      width: 100%; padding: 12px 5px; font-size: 1rem;
      background: #432517; color: #ECDBBF; border: none; border-radius: 5px;
      cursor: pointer; font-weight: bold;
    }
    .sub-btn:active { transform: scale(0.98); }

    #lobbyChatHistory { flex: 1; overflow-y: auto; background: rgba(255, 255, 255, 0.5); border: 1px solid #ccc; padding: 8px; border-radius: 8px; margin-bottom: 10px;}
    .chat-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px;}
    .chat-row.mine { flex-direction: row-reverse; }
    .chat-bubble { background: #ECDBBF; padding: 8px; border-radius: 10px; font-size: 0.9rem; max-width: 70%; word-break: break-all;}
    .chat-row.mine .chat-bubble { background: #fff8dc; border: 2px solid #f0e68c; }
    .chat-name-text { font-size: 0.7rem; font-weight: bold; color: #333; margin-bottom: 2px;}

    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #432517; z-index: 9999;
      display: flex; justify-content: center; align-items: center;
      transition: opacity 0.5s ease;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid rgba(236, 219, 191, 0.3);
      border-top: 5px solid #ECDBBF; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div id="loading-screen">
    <div style="text-align:center; color:#ECDBBF;">
      <div class="spinner" style="margin:0 auto 15px;"></div>
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <div id="bg-image"></div>

  <img id="myPageCharImg" class="character-stand-mypage" src="script/image/komiya_touka.png" alt="Character">

  <div class="profile-container">
    
    <div class="user-name-panel">
      <div style="font-size:0.8rem; margin-bottom:5px; opacity: 0.8;">ID: <span id="userIdDisplay">---</span></div>
      <div id="userNameDisplay" class="mypage-name">ã‚²ã‚¹ãƒˆ</div>
      <div style="margin-top:5px;">
        ğŸ’° <span id="userGoldDisplay" class="mypage-gold">0</span> G
      </div>
    </div>

    <div class="mypage-buttons">
      <a href="mypage.html" class="big-link-btn btn-history">
        <span>ğŸ“–</span> å¯¾å±€å±¥æ­´
      </a>

      <a href="friend.html" class="big-link-btn btn-friend">
        <span>ğŸ¤</span> ãƒ•ãƒ¬ãƒ³ãƒ‰
      </a>
      
      <button class="big-link-btn" style="background: linear-gradient(to bottom, #6c757d, #5a6268);" onclick="openModal('nameEditModal')">
        <span>âœï¸</span> åå‰å¤‰æ›´
      </button>
    </div>

  </div>

  <div class="bottom-menu">
    <button class="menu-btn home-color" onclick="window.location.href='home.html'">ãƒ›ãƒ¼ãƒ </button>
    <button class="menu-btn analysis-color" onclick="window.location.href='kaiseki.html'">è§£æ</button>
    <button class="menu-btn shop-color" onclick="window.location.href='shop.html'">ã‚·ãƒ§ãƒƒãƒ—</button>
    <button class="menu-btn menu-color" onclick="openModal('unifiedMenuModal')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
    <button class="menu-btn chat-color" onclick="openLobbyChat()">ãƒãƒ£ãƒƒãƒˆ</button>
  </div>

  <div id="unifiedMenuModal" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513; margin-top: 0;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <div class="modal-grid">
        <button class="sub-btn" style="background: linear-gradient(to bottom, #FF9800 0%, #F57C00 100%);" onclick="window.location.href='inventory.html'">ğŸ’ æ‰€æŒå“</button>
        <button class="sub-btn" style="background: #e91e63;" onclick="window.location.href='character.html'">ğŸ‘¤ ã‚­ãƒ£ãƒ©å¤‰æ›´</button>
        <button class="sub-btn" style="background: #17a2b8;" onclick="window.location.href='help.html'">â“ ãƒ˜ãƒ«ãƒ—</button>
        <button class="sub-btn" style="background: #6c757d;" onclick="openModal('settingsModal')">âš™ï¸ è¨­å®š</button>
      </div>
      <button class="sub-btn" style="background:#666; margin-top: 10px;" onclick="closeModal('unifiedMenuModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="nameEditModal" class="overlay">
    <div class="modal-box">
      <h3 style="color: #8b4513;">åå‰ã‚’å¤‰æ›´</h3>
      <div style="margin: 20px 0;">
        <input type="text" maxlength="8" id="newNameInput" style="width: 80%; padding: 10px; font-size: 16px; text-align: center;">
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="sub-btn" style="background: #28a745;" onclick="saveNewName()">æ±ºå®š</button>
        <button class="sub-btn" style="background: #ccc; color:#333;" onclick="closeModal('nameEditModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="lobbyChatModal" class="overlay">
    <div class="modal-box" style="height:85vh;">
      <h3 style="margin:0 0 5px 0;">ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</h3>
      <div id="lobbyChatHistory"></div>
      <div style="display: flex; gap: 5px; margin-top: 5px;">
        <input type="text" id="lobbyChatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" style="flex:1; padding:10px;">
        <button onclick="sendLobbyMessage()" style="background:#28a745; color:#fff; border:none; padding:10px; border-radius:5px;">é€ä¿¡</button>
      </div>
      <button class="sub-btn" style="background:#666; margin-top:10px;" onclick="closeModal('lobbyChatModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div id="settingsModal" class="overlay">
    <div class="modal-box">
        <h3>è¨­å®š</h3>
        <button class="sub-btn" onclick="firebase.auth().signOut().then(()=>{alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'); location.reload();})">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <br><br>
        <button class="sub-btn" style="background:#666;" onclick="closeModal('settingsModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script src="script/serifu/komiya.js"></script>
  <script src="script/serifu/a.js"></script>
  <script src="script/serifu/b.js"></script>
  <script src="script/serifu/d.js"></script>
  <script src="script/auth.js"></script>

  <script>
    // --- åˆæœŸåŒ–å‡¦ç† ---
    window.addEventListener('load', () => {
        const loader = document.getElementById('loading-screen');
        setTimeout(() => {
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
        }, 500);
        
        loadCharacterImage();
    });

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function loadCharacterImage() {
        const savedCharId = localStorage.getItem('selected_character_id') || 'komiya';
        if (window.CHARACTERS && window.CHARACTERS[savedCharId]) {
            document.getElementById('myPageCharImg').src = window.CHARACTERS[savedCharId].image;
        }
    }

    // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿åŒæœŸ ---
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            db.collection("users").doc(user.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const name = data.name || "åç„¡ã—";
                    document.getElementById("userNameDisplay").textContent = name;
                    document.getElementById("userIdDisplay").textContent = user.uid.slice(0, 6) + "..."; 
                    const gold = data.gold || 0;
                    document.getElementById("userGoldDisplay").textContent = gold.toLocaleString();
                }
            });
            initLobbyChat();
        } else {
            document.getElementById("userNameDisplay").textContent = "ã‚²ã‚¹ãƒˆ";
            initLobbyChat(); 
        }
    });

    // --- åå‰å¤‰æ›´ ---
    function saveNewName() {
        const user = firebase.auth().currentUser;
        const newName = document.getElementById("newNameInput").value.trim();
        if(!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
        if(!newName) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        db.collection("users").doc(user.uid).update({
            name: newName
        }).then(() => {
            alert("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼");
            closeModal("nameEditModal");
        }).catch(err => {
            alert("ã‚¨ãƒ©ãƒ¼: " + err);
        });
    }

    // --- ãƒãƒ£ãƒƒãƒˆ ---
    function openLobbyChat() {
        openModal('lobbyChatModal');
    }

    function initLobbyChat() {
        const historyDiv = document.getElementById("lobbyChatHistory");
        db.collection("lobby_chat").orderBy("createdAt", "desc").limit(30)
          .onSnapshot((snapshot) => {
             historyDiv.innerHTML = "";
             const msgs = [];
             snapshot.forEach(doc => msgs.push(doc.data()));
             msgs.forEach(data => {
                 const div = document.createElement("div");
                 div.className = "chat-row" + (firebase.auth().currentUser && data.userId === firebase.auth().currentUser.uid ? " mine" : "");
                 div.innerHTML = `
                   <div style="display:flex; flex-direction:column; align-items:center;">
                     <div class="chat-name-text">${data.name || 'åç„¡ã—'}</div>
                     <div class="chat-bubble">${data.text}</div>
                   </div>
                 `;
                 historyDiv.appendChild(div);
             });
             historyDiv.scrollTop = 0;
          });
    }

    function sendLobbyMessage() {
        const input = document.getElementById("lobbyChatInput");
        const text = input.value.trim();
        const user = firebase.auth().currentUser;
        if (!text) return;
        
        const name = document.getElementById("userNameDisplay").textContent;
        const uid = user ? user.uid : "guest";

        db.collection("lobby_chat").add({
            text: text,
            name: name,
            userId: uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            input.value = "";
        });
    }

    // --- ç”»é¢å›è»¢ ---
    function autoRotate() {
        if(window.innerHeight > window.innerWidth) {
            document.body.style.transform = "translate(-50%, -50%) rotate(90deg)";
            document.body.style.width = window.innerHeight + "px";
            document.body.style.height = window.innerWidth + "px";
            document.body.style.position = "fixed";
            document.body.style.top = "50%";
            document.body.style.left = "50%";
        } else {
            document.body.style.transform = "";
            document.body.style.width = "100%";
            document.body.style.height = "100%";
            document.body.style.top = "0";
            document.body.style.left = "0";
        }
    }
    window.addEventListener('resize', autoRotate);
    window.addEventListener('load', autoRotate);

  </script>
</body>
</html>
